<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>如何设计一个短网址服务 | 开发者笔记</title>
    <meta name="generator" content="VuePress 1.9.10">
    
    <meta name="description" content="">
    
    <link rel="preload" href="/note/assets/css/0.styles.fa566ad0.css" as="style"><link rel="preload" href="/note/assets/js/app.fe0ed53e.js" as="script"><link rel="preload" href="/note/assets/js/2.7b239f4c.js" as="script"><link rel="preload" href="/note/assets/js/1.51e4995c.js" as="script"><link rel="preload" href="/note/assets/js/67.ba2be8c2.js" as="script"><link rel="prefetch" href="/note/assets/js/10.555b32ff.js"><link rel="prefetch" href="/note/assets/js/100.923d2cb5.js"><link rel="prefetch" href="/note/assets/js/101.1b10aa6b.js"><link rel="prefetch" href="/note/assets/js/102.519481ff.js"><link rel="prefetch" href="/note/assets/js/103.93f3de8d.js"><link rel="prefetch" href="/note/assets/js/104.5f17bec9.js"><link rel="prefetch" href="/note/assets/js/105.22c71f14.js"><link rel="prefetch" href="/note/assets/js/106.7aca8b70.js"><link rel="prefetch" href="/note/assets/js/107.a1b34675.js"><link rel="prefetch" href="/note/assets/js/108.3dc6e794.js"><link rel="prefetch" href="/note/assets/js/109.97ce641d.js"><link rel="prefetch" href="/note/assets/js/11.fd20f755.js"><link rel="prefetch" href="/note/assets/js/110.ed78ce1a.js"><link rel="prefetch" href="/note/assets/js/111.81bf4714.js"><link rel="prefetch" href="/note/assets/js/112.916871fd.js"><link rel="prefetch" href="/note/assets/js/113.3e03ceee.js"><link rel="prefetch" href="/note/assets/js/114.a044d982.js"><link rel="prefetch" href="/note/assets/js/115.3804ad48.js"><link rel="prefetch" href="/note/assets/js/116.8f6f44ad.js"><link rel="prefetch" href="/note/assets/js/117.e215e63e.js"><link rel="prefetch" href="/note/assets/js/118.dfeb9e88.js"><link rel="prefetch" href="/note/assets/js/119.466009e4.js"><link rel="prefetch" href="/note/assets/js/12.3ad661be.js"><link rel="prefetch" href="/note/assets/js/120.77bd5754.js"><link rel="prefetch" href="/note/assets/js/121.04ff5c2a.js"><link rel="prefetch" href="/note/assets/js/13.0bb3a7d0.js"><link rel="prefetch" href="/note/assets/js/14.f9046e47.js"><link rel="prefetch" href="/note/assets/js/15.3af5a383.js"><link rel="prefetch" href="/note/assets/js/16.c8d9f254.js"><link rel="prefetch" href="/note/assets/js/17.71204e89.js"><link rel="prefetch" href="/note/assets/js/18.831fa1a4.js"><link rel="prefetch" href="/note/assets/js/19.a6dff0f2.js"><link rel="prefetch" href="/note/assets/js/20.611906c5.js"><link rel="prefetch" href="/note/assets/js/21.8da184a7.js"><link rel="prefetch" href="/note/assets/js/22.c52856f3.js"><link rel="prefetch" href="/note/assets/js/23.700dac36.js"><link rel="prefetch" href="/note/assets/js/24.69ce0e0c.js"><link rel="prefetch" href="/note/assets/js/25.0730c414.js"><link rel="prefetch" href="/note/assets/js/26.0dc2f351.js"><link rel="prefetch" href="/note/assets/js/27.b67f9ce5.js"><link rel="prefetch" href="/note/assets/js/28.1b0ec007.js"><link rel="prefetch" href="/note/assets/js/29.fd8012dc.js"><link rel="prefetch" href="/note/assets/js/3.922513d5.js"><link rel="prefetch" href="/note/assets/js/30.eb83510f.js"><link rel="prefetch" href="/note/assets/js/31.2eff891a.js"><link rel="prefetch" href="/note/assets/js/32.1ca7680c.js"><link rel="prefetch" href="/note/assets/js/33.e23bb18b.js"><link rel="prefetch" href="/note/assets/js/34.e1b481dc.js"><link rel="prefetch" href="/note/assets/js/35.f46213e9.js"><link rel="prefetch" href="/note/assets/js/36.a5e42658.js"><link rel="prefetch" href="/note/assets/js/37.0f540e46.js"><link rel="prefetch" href="/note/assets/js/38.b372cea4.js"><link rel="prefetch" href="/note/assets/js/39.95b7b6ef.js"><link rel="prefetch" href="/note/assets/js/4.7f32a226.js"><link rel="prefetch" href="/note/assets/js/40.aacc67a1.js"><link rel="prefetch" href="/note/assets/js/41.baa508be.js"><link rel="prefetch" href="/note/assets/js/42.adae8cbf.js"><link rel="prefetch" href="/note/assets/js/43.895ef36a.js"><link rel="prefetch" href="/note/assets/js/44.bbb4481a.js"><link rel="prefetch" href="/note/assets/js/45.cbf322f4.js"><link rel="prefetch" href="/note/assets/js/46.68e5a9a5.js"><link rel="prefetch" href="/note/assets/js/47.3fddf95f.js"><link rel="prefetch" href="/note/assets/js/48.92c8b712.js"><link rel="prefetch" href="/note/assets/js/49.4c802eef.js"><link rel="prefetch" href="/note/assets/js/5.27e38e77.js"><link rel="prefetch" href="/note/assets/js/50.36092570.js"><link rel="prefetch" href="/note/assets/js/51.1113abd3.js"><link rel="prefetch" href="/note/assets/js/52.b9a2d2d1.js"><link rel="prefetch" href="/note/assets/js/53.7dc6c9ae.js"><link rel="prefetch" href="/note/assets/js/54.e1fa1251.js"><link rel="prefetch" href="/note/assets/js/55.3b47207f.js"><link rel="prefetch" href="/note/assets/js/56.e2fa0521.js"><link rel="prefetch" href="/note/assets/js/57.efe7b9d7.js"><link rel="prefetch" href="/note/assets/js/58.91a3fbe0.js"><link rel="prefetch" href="/note/assets/js/59.759256fb.js"><link rel="prefetch" href="/note/assets/js/6.eeaf7e02.js"><link rel="prefetch" href="/note/assets/js/60.63a865bc.js"><link rel="prefetch" href="/note/assets/js/61.6ea99453.js"><link rel="prefetch" href="/note/assets/js/62.92a1deae.js"><link rel="prefetch" href="/note/assets/js/63.f0f2e8ba.js"><link rel="prefetch" href="/note/assets/js/64.66ca54af.js"><link rel="prefetch" href="/note/assets/js/65.d7a5fccb.js"><link rel="prefetch" href="/note/assets/js/66.6fd1421d.js"><link rel="prefetch" href="/note/assets/js/68.73dd8a54.js"><link rel="prefetch" href="/note/assets/js/69.01ef0cca.js"><link rel="prefetch" href="/note/assets/js/7.97a5d920.js"><link rel="prefetch" href="/note/assets/js/70.c0e7f26a.js"><link rel="prefetch" href="/note/assets/js/71.6e8cf6b2.js"><link rel="prefetch" href="/note/assets/js/72.f93545c3.js"><link rel="prefetch" href="/note/assets/js/73.65ede5b3.js"><link rel="prefetch" href="/note/assets/js/74.221a3475.js"><link rel="prefetch" href="/note/assets/js/75.4f15972e.js"><link rel="prefetch" href="/note/assets/js/76.db77aaf5.js"><link rel="prefetch" href="/note/assets/js/77.57d30a26.js"><link rel="prefetch" href="/note/assets/js/78.67ade579.js"><link rel="prefetch" href="/note/assets/js/79.d209365a.js"><link rel="prefetch" href="/note/assets/js/80.3676f009.js"><link rel="prefetch" href="/note/assets/js/81.de92044c.js"><link rel="prefetch" href="/note/assets/js/82.807d0fc1.js"><link rel="prefetch" href="/note/assets/js/83.41ad2d0d.js"><link rel="prefetch" href="/note/assets/js/84.09cc5bde.js"><link rel="prefetch" href="/note/assets/js/85.5452bba4.js"><link rel="prefetch" href="/note/assets/js/86.59edb859.js"><link rel="prefetch" href="/note/assets/js/87.382dd4a3.js"><link rel="prefetch" href="/note/assets/js/88.a715c97d.js"><link rel="prefetch" href="/note/assets/js/89.c8360788.js"><link rel="prefetch" href="/note/assets/js/90.130359da.js"><link rel="prefetch" href="/note/assets/js/91.e3275599.js"><link rel="prefetch" href="/note/assets/js/92.393dd45a.js"><link rel="prefetch" href="/note/assets/js/93.33847c52.js"><link rel="prefetch" href="/note/assets/js/94.d8033e92.js"><link rel="prefetch" href="/note/assets/js/95.5bd3b80e.js"><link rel="prefetch" href="/note/assets/js/96.50504acf.js"><link rel="prefetch" href="/note/assets/js/97.636b17d3.js"><link rel="prefetch" href="/note/assets/js/98.1801094c.js"><link rel="prefetch" href="/note/assets/js/99.88e5b949.js"><link rel="prefetch" href="/note/assets/js/vendors~docsearch.69e677f0.js">
    <link rel="stylesheet" href="/note/assets/css/0.styles.fa566ad0.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/note/" class="home-link router-link-active"><!----> <span class="site-name">开发者笔记</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/note/" class="nav-link">
  Home
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Java" class="dropdown-title"><span class="title">Java</span> <span class="arrow down"></span></button> <button type="button" aria-label="Java" class="mobile-dropdown-title"><span class="title">Java</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/note/java/base/basic.html" class="nav-link">
  Java基础
</a></li><li class="dropdown-item"><!----> <a href="/note/java/collection/ArrayList.html" class="nav-link">
  Java集合框架
</a></li><li class="dropdown-item"><!----> <a href="/note/java/concurrent/Theory.html" class="nav-link">
  Java并发编程
</a></li><li class="dropdown-item"><!----> <a href="/note/java/jvm/memory.html" class="nav-link">
  JVM相关
</a></li><li class="dropdown-item"><!----> <a href="/note/java/nio/io.html" class="nav-link">
  Java NIO相关
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="数据存储" class="dropdown-title"><span class="title">数据存储</span> <span class="arrow down"></span></button> <button type="button" aria-label="数据存储" class="mobile-dropdown-title"><span class="title">数据存储</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/note/storage/database/mysql.html" class="nav-link">
  MySQL
</a></li><li class="dropdown-item"><!----> <a href="/note/storage/redis/redis-question.html" class="nav-link">
  Redis
</a></li><li class="dropdown-item"><!----> <a href="/note/storage/mq/kafka-intro.html" class="nav-link">
  消息队列
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="框架" class="dropdown-title"><span class="title">框架</span> <span class="arrow down"></span></button> <button type="button" aria-label="框架" class="mobile-dropdown-title"><span class="title">框架</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/note/framework/spring-framework/spring-framework-intro.html" class="nav-link">
  Spring框架
</a></li><li class="dropdown-item"><!----> <a href="/note/framework/netty/netty-business-logic.html" class="nav-link">
  Netty
</a></li><li class="dropdown-item"><!----> <a href="/note/framework/apollo/setup-debug-enviroment.html" class="nav-link">
  Apollo源码分析
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="架构" class="dropdown-title"><span class="title">架构</span> <span class="arrow down"></span></button> <button type="button" aria-label="架构" class="mobile-dropdown-title"><span class="title">架构</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/note/arch/system-design/01-scale-from-zero.html" class="nav-link">
  系统设计
</a></li><li class="dropdown-item"><!----> <a href="/note/arch/case-study/rate-limiter.html" class="nav-link">
  案例
</a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/note/" class="nav-link">
  Home
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Java" class="dropdown-title"><span class="title">Java</span> <span class="arrow down"></span></button> <button type="button" aria-label="Java" class="mobile-dropdown-title"><span class="title">Java</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/note/java/base/basic.html" class="nav-link">
  Java基础
</a></li><li class="dropdown-item"><!----> <a href="/note/java/collection/ArrayList.html" class="nav-link">
  Java集合框架
</a></li><li class="dropdown-item"><!----> <a href="/note/java/concurrent/Theory.html" class="nav-link">
  Java并发编程
</a></li><li class="dropdown-item"><!----> <a href="/note/java/jvm/memory.html" class="nav-link">
  JVM相关
</a></li><li class="dropdown-item"><!----> <a href="/note/java/nio/io.html" class="nav-link">
  Java NIO相关
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="数据存储" class="dropdown-title"><span class="title">数据存储</span> <span class="arrow down"></span></button> <button type="button" aria-label="数据存储" class="mobile-dropdown-title"><span class="title">数据存储</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/note/storage/database/mysql.html" class="nav-link">
  MySQL
</a></li><li class="dropdown-item"><!----> <a href="/note/storage/redis/redis-question.html" class="nav-link">
  Redis
</a></li><li class="dropdown-item"><!----> <a href="/note/storage/mq/kafka-intro.html" class="nav-link">
  消息队列
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="框架" class="dropdown-title"><span class="title">框架</span> <span class="arrow down"></span></button> <button type="button" aria-label="框架" class="mobile-dropdown-title"><span class="title">框架</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/note/framework/spring-framework/spring-framework-intro.html" class="nav-link">
  Spring框架
</a></li><li class="dropdown-item"><!----> <a href="/note/framework/netty/netty-business-logic.html" class="nav-link">
  Netty
</a></li><li class="dropdown-item"><!----> <a href="/note/framework/apollo/setup-debug-enviroment.html" class="nav-link">
  Apollo源码分析
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="架构" class="dropdown-title"><span class="title">架构</span> <span class="arrow down"></span></button> <button type="button" aria-label="架构" class="mobile-dropdown-title"><span class="title">架构</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/note/arch/system-design/01-scale-from-zero.html" class="nav-link">
  系统设计
</a></li><li class="dropdown-item"><!----> <a href="/note/arch/case-study/rate-limiter.html" class="nav-link">
  案例
</a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>架构案例</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/note/arch/case-study/rate-limiter.html" class="sidebar-link">限流</a></li><li><a href="/note/arch/case-study/cache-consistency.html" class="sidebar-link">缓存一致性</a></li><li><a href="/note/arch/case-study/cache-avalanche-cache-penetration.html" class="sidebar-link">缓存雪崩、缓存穿透、缓存击穿</a></li><li><a href="/note/arch/case-study/gateway.html" class="sidebar-link">如何设计一个亿级网关</a></li><li><a href="/note/arch/case-study/short-url.html" aria-current="page" class="active sidebar-link">如何设计一个短网址服务</a></li><li><a href="/note/arch/case-study/deduction.html" class="sidebar-link">如何设计一个扣减类服务</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="如何设计一个短网址服务"><a href="#如何设计一个短网址服务" class="header-anchor">#</a> 如何设计一个短网址服务</h1> <h2 id="使用场景"><a href="#使用场景" class="header-anchor">#</a> 使用场景</h2> <p>微博和Twitter都有140字数的限制，如果分享一个长网址，很容易就超出限制，发布出去。短网址服务可以把一个长网址变成短网址，方便在社交网络上传播。</p> <h2 id="需求"><a href="#需求" class="header-anchor">#</a> 需求</h2> <p>很显然，要尽可能的短。长度设计为多少才合适呢？</p> <h2 id="短网址的长度"><a href="#短网址的长度" class="header-anchor">#</a> 短网址的长度</h2> <p>当前互联网上的网页总数大概是 45亿(参考 http://www.worldwidewebsize.com)，45亿超过了 2^{32}=42949672962，但远远小于64位整数的上限值，那么用一个64位整数足够了。</p> <p>微博的短网址服务用的是长度为7的字符串，这个字符串可以看做是62进制的数，那么最大能表示 {62}^7=352161460620862 个网址，远远大于45亿。所以长度为7就足够了。</p> <p>一个64位整数如何转化为字符串呢？，假设我们只是用大小写字母加数字，那么可以看做是62进制数，log_{62} {(2^{64}-1)}=10.7，即字符串最长11就足够了。</p> <p>实际生产中，还可以再短一点，比如新浪微博采用的长度就是7，因为 62^7=352161460620862，这个量级远远超过互联网上的URL总数了，绝对够用了。</p> <p>现代的web服务器（例如Apache, Nginx）大部分都区分URL里的大小写了，所以用大小写字母来区分不同的URL是没问题的。</p> <p>因此，正确答案：长度不超过7的字符串，由大小写字母加数字共62个字母组成</p> <h2 id="一对一还是一对多映射"><a href="#一对一还是一对多映射" class="header-anchor">#</a> 一对一还是一对多映射？</h2> <p>一个长网址，对应一个短网址，还是可以对应多个短网址？ 这也是个重大选择问题</p> <p>一般而言，一个长网址，在不同的地点，不同的用户等情况下，生成的短网址应该不一样，这样，在后端数据库中，可以更好的进行数据分析。如果一个长网址与一个短网址一一对应，那么在数据库中，仅有一行数据，无法区分不同的来源，就无法做数据分析了。</p> <p>以这个7位长度的短网址作为唯一ID，这个ID下可以挂各种信息，比如生成该网址的用户名，所在网站，HTTP头部的 User Agent等信息，收集了这些信息，才有可能在后面做大数据分析，挖掘数据的价值。短网址服务商的一大盈利来源就是这些数据。</p> <p>正确答案：一对多</p> <h2 id="如何计算短网址"><a href="#如何计算短网址" class="header-anchor">#</a> 如何计算短网址</h2> <p>现在我们设定了短网址是一个长度为7的字符串，如何计算得到这个短网址呢？</p> <p>最容易想到的办法是哈希，先hash得到一个64位整数，将它转化为62进制整，截取低7位即可。但是哈希算法会有冲突，如何处理冲突呢，又是一个麻烦。这个方法只是转移了矛盾，没有解决矛盾，抛弃。</p> <p>正确答案：分布式发号器(Distributed ID Generator)</p> <h1 id="如何存储"><a href="#如何存储" class="header-anchor">#</a> 如何存储</h1> <p>如果存储短网址和长网址的对应关系？以短网址为 primary key, 长网址为value, 可以用传统的关系数据库存起来，例如MySQL, PostgreSQL，也可以用任意一个分布式KV数据库，例如Redis, LevelDB。</p> <p>如果你手痒想要手工设计这个存储，那就是另一个话题了，你需要完整地造一个KV存储引擎轮子。当前流行的KV存储引擎有LevelDB何RockDB，去读它们的源码吧 😄</p> <h1 id="_301还是302重定向"><a href="#_301还是302重定向" class="header-anchor">#</a> 301还是302重定向</h1> <p>这也是一个有意思的问题。这个问题主要是考察你对301和302的理解，以及浏览器缓存机制的理解。</p> <p>301是永久重定向，302是临时重定向。短地址一经生成就不会变化，所以用301是符合http语义的。但是如果用了301， Google，百度等搜索引擎，搜索的时候会直接展示真实地址，那我们就无法统计到短地址被点击的次数了，也无法收集用户的Cookie, User Agent 等信息，这些信息可以用来做很多有意思的大数据分析，也是短网址服务商的主要盈利来源。</p> <p>所以，正确答案是302重定向。</p> <h2 id="预防攻击"><a href="#预防攻击" class="header-anchor">#</a> 预防攻击</h2> <p>如果一些别有用心的黑客，短时间内向TinyURL服务器发送大量的请求，会迅速耗光ID，怎么办呢？</p> <p>首先，限制IP的单日请求总数，超过阈值则直接拒绝服务。</p> <p>光限制IP的请求数还不够，因为黑客一般手里有上百万台肉鸡的，IP地址大大的有，所以光限制IP作用不大。</p> <p>可以用一台Redis作为缓存服务器，存储的不是 ID-&gt;长网址，而是 长网址-&gt;ID，仅存储一天以内的数据，用LRU机制进行淘汰。这样，如果黑客大量发同一个长网址过来，直接从缓存服务器里返回短网址即可，他就无法耗光我们的ID了。</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/note/arch/case-study/gateway.html" class="prev">
        如何设计一个亿级网关
      </a></span> <span class="next"><a href="/note/arch/case-study/deduction.html">
        如何设计一个扣减类服务
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/note/assets/js/app.fe0ed53e.js" defer></script><script src="/note/assets/js/2.7b239f4c.js" defer></script><script src="/note/assets/js/1.51e4995c.js" defer></script><script src="/note/assets/js/67.ba2be8c2.js" defer></script>
  </body>
</html>
