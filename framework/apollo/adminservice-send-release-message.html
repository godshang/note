<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Apollo源码分析——发送ReleaseMessage | 开发者笔记</title>
    <meta name="generator" content="VuePress 1.9.10">
    
    <meta name="description" content="">
    
    <link rel="preload" href="/note/assets/css/0.styles.fa566ad0.css" as="style"><link rel="preload" href="/note/assets/js/app.fe0ed53e.js" as="script"><link rel="preload" href="/note/assets/js/2.7b239f4c.js" as="script"><link rel="preload" href="/note/assets/js/1.51e4995c.js" as="script"><link rel="preload" href="/note/assets/js/48.92c8b712.js" as="script"><link rel="prefetch" href="/note/assets/js/10.555b32ff.js"><link rel="prefetch" href="/note/assets/js/100.923d2cb5.js"><link rel="prefetch" href="/note/assets/js/101.1b10aa6b.js"><link rel="prefetch" href="/note/assets/js/102.519481ff.js"><link rel="prefetch" href="/note/assets/js/103.93f3de8d.js"><link rel="prefetch" href="/note/assets/js/104.5f17bec9.js"><link rel="prefetch" href="/note/assets/js/105.22c71f14.js"><link rel="prefetch" href="/note/assets/js/106.7aca8b70.js"><link rel="prefetch" href="/note/assets/js/107.a1b34675.js"><link rel="prefetch" href="/note/assets/js/108.3dc6e794.js"><link rel="prefetch" href="/note/assets/js/109.97ce641d.js"><link rel="prefetch" href="/note/assets/js/11.fd20f755.js"><link rel="prefetch" href="/note/assets/js/110.ed78ce1a.js"><link rel="prefetch" href="/note/assets/js/111.81bf4714.js"><link rel="prefetch" href="/note/assets/js/112.916871fd.js"><link rel="prefetch" href="/note/assets/js/113.3e03ceee.js"><link rel="prefetch" href="/note/assets/js/114.a044d982.js"><link rel="prefetch" href="/note/assets/js/115.3804ad48.js"><link rel="prefetch" href="/note/assets/js/116.8f6f44ad.js"><link rel="prefetch" href="/note/assets/js/117.e215e63e.js"><link rel="prefetch" href="/note/assets/js/118.dfeb9e88.js"><link rel="prefetch" href="/note/assets/js/119.466009e4.js"><link rel="prefetch" href="/note/assets/js/12.3ad661be.js"><link rel="prefetch" href="/note/assets/js/120.77bd5754.js"><link rel="prefetch" href="/note/assets/js/121.04ff5c2a.js"><link rel="prefetch" href="/note/assets/js/13.0bb3a7d0.js"><link rel="prefetch" href="/note/assets/js/14.f9046e47.js"><link rel="prefetch" href="/note/assets/js/15.3af5a383.js"><link rel="prefetch" href="/note/assets/js/16.c8d9f254.js"><link rel="prefetch" href="/note/assets/js/17.71204e89.js"><link rel="prefetch" href="/note/assets/js/18.831fa1a4.js"><link rel="prefetch" href="/note/assets/js/19.a6dff0f2.js"><link rel="prefetch" href="/note/assets/js/20.611906c5.js"><link rel="prefetch" href="/note/assets/js/21.8da184a7.js"><link rel="prefetch" href="/note/assets/js/22.c52856f3.js"><link rel="prefetch" href="/note/assets/js/23.700dac36.js"><link rel="prefetch" href="/note/assets/js/24.69ce0e0c.js"><link rel="prefetch" href="/note/assets/js/25.0730c414.js"><link rel="prefetch" href="/note/assets/js/26.0dc2f351.js"><link rel="prefetch" href="/note/assets/js/27.b67f9ce5.js"><link rel="prefetch" href="/note/assets/js/28.1b0ec007.js"><link rel="prefetch" href="/note/assets/js/29.fd8012dc.js"><link rel="prefetch" href="/note/assets/js/3.922513d5.js"><link rel="prefetch" href="/note/assets/js/30.eb83510f.js"><link rel="prefetch" href="/note/assets/js/31.2eff891a.js"><link rel="prefetch" href="/note/assets/js/32.1ca7680c.js"><link rel="prefetch" href="/note/assets/js/33.e23bb18b.js"><link rel="prefetch" href="/note/assets/js/34.e1b481dc.js"><link rel="prefetch" href="/note/assets/js/35.f46213e9.js"><link rel="prefetch" href="/note/assets/js/36.a5e42658.js"><link rel="prefetch" href="/note/assets/js/37.0f540e46.js"><link rel="prefetch" href="/note/assets/js/38.b372cea4.js"><link rel="prefetch" href="/note/assets/js/39.95b7b6ef.js"><link rel="prefetch" href="/note/assets/js/4.7f32a226.js"><link rel="prefetch" href="/note/assets/js/40.aacc67a1.js"><link rel="prefetch" href="/note/assets/js/41.baa508be.js"><link rel="prefetch" href="/note/assets/js/42.adae8cbf.js"><link rel="prefetch" href="/note/assets/js/43.895ef36a.js"><link rel="prefetch" href="/note/assets/js/44.bbb4481a.js"><link rel="prefetch" href="/note/assets/js/45.cbf322f4.js"><link rel="prefetch" href="/note/assets/js/46.68e5a9a5.js"><link rel="prefetch" href="/note/assets/js/47.3fddf95f.js"><link rel="prefetch" href="/note/assets/js/49.4c802eef.js"><link rel="prefetch" href="/note/assets/js/5.27e38e77.js"><link rel="prefetch" href="/note/assets/js/50.36092570.js"><link rel="prefetch" href="/note/assets/js/51.1113abd3.js"><link rel="prefetch" href="/note/assets/js/52.b9a2d2d1.js"><link rel="prefetch" href="/note/assets/js/53.7dc6c9ae.js"><link rel="prefetch" href="/note/assets/js/54.e1fa1251.js"><link rel="prefetch" href="/note/assets/js/55.3b47207f.js"><link rel="prefetch" href="/note/assets/js/56.e2fa0521.js"><link rel="prefetch" href="/note/assets/js/57.efe7b9d7.js"><link rel="prefetch" href="/note/assets/js/58.91a3fbe0.js"><link rel="prefetch" href="/note/assets/js/59.759256fb.js"><link rel="prefetch" href="/note/assets/js/6.eeaf7e02.js"><link rel="prefetch" href="/note/assets/js/60.63a865bc.js"><link rel="prefetch" href="/note/assets/js/61.6ea99453.js"><link rel="prefetch" href="/note/assets/js/62.92a1deae.js"><link rel="prefetch" href="/note/assets/js/63.f0f2e8ba.js"><link rel="prefetch" href="/note/assets/js/64.66ca54af.js"><link rel="prefetch" href="/note/assets/js/65.d7a5fccb.js"><link rel="prefetch" href="/note/assets/js/66.6fd1421d.js"><link rel="prefetch" href="/note/assets/js/67.ba2be8c2.js"><link rel="prefetch" href="/note/assets/js/68.73dd8a54.js"><link rel="prefetch" href="/note/assets/js/69.01ef0cca.js"><link rel="prefetch" href="/note/assets/js/7.97a5d920.js"><link rel="prefetch" href="/note/assets/js/70.c0e7f26a.js"><link rel="prefetch" href="/note/assets/js/71.6e8cf6b2.js"><link rel="prefetch" href="/note/assets/js/72.f93545c3.js"><link rel="prefetch" href="/note/assets/js/73.65ede5b3.js"><link rel="prefetch" href="/note/assets/js/74.221a3475.js"><link rel="prefetch" href="/note/assets/js/75.4f15972e.js"><link rel="prefetch" href="/note/assets/js/76.db77aaf5.js"><link rel="prefetch" href="/note/assets/js/77.57d30a26.js"><link rel="prefetch" href="/note/assets/js/78.67ade579.js"><link rel="prefetch" href="/note/assets/js/79.d209365a.js"><link rel="prefetch" href="/note/assets/js/80.3676f009.js"><link rel="prefetch" href="/note/assets/js/81.de92044c.js"><link rel="prefetch" href="/note/assets/js/82.807d0fc1.js"><link rel="prefetch" href="/note/assets/js/83.41ad2d0d.js"><link rel="prefetch" href="/note/assets/js/84.09cc5bde.js"><link rel="prefetch" href="/note/assets/js/85.5452bba4.js"><link rel="prefetch" href="/note/assets/js/86.59edb859.js"><link rel="prefetch" href="/note/assets/js/87.382dd4a3.js"><link rel="prefetch" href="/note/assets/js/88.a715c97d.js"><link rel="prefetch" href="/note/assets/js/89.c8360788.js"><link rel="prefetch" href="/note/assets/js/90.130359da.js"><link rel="prefetch" href="/note/assets/js/91.e3275599.js"><link rel="prefetch" href="/note/assets/js/92.393dd45a.js"><link rel="prefetch" href="/note/assets/js/93.33847c52.js"><link rel="prefetch" href="/note/assets/js/94.d8033e92.js"><link rel="prefetch" href="/note/assets/js/95.5bd3b80e.js"><link rel="prefetch" href="/note/assets/js/96.50504acf.js"><link rel="prefetch" href="/note/assets/js/97.636b17d3.js"><link rel="prefetch" href="/note/assets/js/98.1801094c.js"><link rel="prefetch" href="/note/assets/js/99.88e5b949.js"><link rel="prefetch" href="/note/assets/js/vendors~docsearch.69e677f0.js">
    <link rel="stylesheet" href="/note/assets/css/0.styles.fa566ad0.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/note/" class="home-link router-link-active"><!----> <span class="site-name">开发者笔记</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/note/" class="nav-link">
  Home
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Java" class="dropdown-title"><span class="title">Java</span> <span class="arrow down"></span></button> <button type="button" aria-label="Java" class="mobile-dropdown-title"><span class="title">Java</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/note/java/base/basic.html" class="nav-link">
  Java基础
</a></li><li class="dropdown-item"><!----> <a href="/note/java/collection/ArrayList.html" class="nav-link">
  Java集合框架
</a></li><li class="dropdown-item"><!----> <a href="/note/java/concurrent/Theory.html" class="nav-link">
  Java并发编程
</a></li><li class="dropdown-item"><!----> <a href="/note/java/jvm/memory.html" class="nav-link">
  JVM相关
</a></li><li class="dropdown-item"><!----> <a href="/note/java/nio/io.html" class="nav-link">
  Java NIO相关
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="数据存储" class="dropdown-title"><span class="title">数据存储</span> <span class="arrow down"></span></button> <button type="button" aria-label="数据存储" class="mobile-dropdown-title"><span class="title">数据存储</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/note/storage/database/mysql.html" class="nav-link">
  MySQL
</a></li><li class="dropdown-item"><!----> <a href="/note/storage/redis/redis-question.html" class="nav-link">
  Redis
</a></li><li class="dropdown-item"><!----> <a href="/note/storage/mq/kafka-intro.html" class="nav-link">
  消息队列
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="框架" class="dropdown-title"><span class="title">框架</span> <span class="arrow down"></span></button> <button type="button" aria-label="框架" class="mobile-dropdown-title"><span class="title">框架</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/note/framework/spring-framework/spring-framework-intro.html" class="nav-link">
  Spring框架
</a></li><li class="dropdown-item"><!----> <a href="/note/framework/netty/netty-business-logic.html" class="nav-link">
  Netty
</a></li><li class="dropdown-item"><!----> <a href="/note/framework/apollo/setup-debug-enviroment.html" class="nav-link">
  Apollo源码分析
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="架构" class="dropdown-title"><span class="title">架构</span> <span class="arrow down"></span></button> <button type="button" aria-label="架构" class="mobile-dropdown-title"><span class="title">架构</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/note/arch/system-design/01-scale-from-zero.html" class="nav-link">
  系统设计
</a></li><li class="dropdown-item"><!----> <a href="/note/arch/case-study/rate-limiter.html" class="nav-link">
  案例
</a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/note/" class="nav-link">
  Home
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Java" class="dropdown-title"><span class="title">Java</span> <span class="arrow down"></span></button> <button type="button" aria-label="Java" class="mobile-dropdown-title"><span class="title">Java</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/note/java/base/basic.html" class="nav-link">
  Java基础
</a></li><li class="dropdown-item"><!----> <a href="/note/java/collection/ArrayList.html" class="nav-link">
  Java集合框架
</a></li><li class="dropdown-item"><!----> <a href="/note/java/concurrent/Theory.html" class="nav-link">
  Java并发编程
</a></li><li class="dropdown-item"><!----> <a href="/note/java/jvm/memory.html" class="nav-link">
  JVM相关
</a></li><li class="dropdown-item"><!----> <a href="/note/java/nio/io.html" class="nav-link">
  Java NIO相关
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="数据存储" class="dropdown-title"><span class="title">数据存储</span> <span class="arrow down"></span></button> <button type="button" aria-label="数据存储" class="mobile-dropdown-title"><span class="title">数据存储</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/note/storage/database/mysql.html" class="nav-link">
  MySQL
</a></li><li class="dropdown-item"><!----> <a href="/note/storage/redis/redis-question.html" class="nav-link">
  Redis
</a></li><li class="dropdown-item"><!----> <a href="/note/storage/mq/kafka-intro.html" class="nav-link">
  消息队列
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="框架" class="dropdown-title"><span class="title">框架</span> <span class="arrow down"></span></button> <button type="button" aria-label="框架" class="mobile-dropdown-title"><span class="title">框架</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/note/framework/spring-framework/spring-framework-intro.html" class="nav-link">
  Spring框架
</a></li><li class="dropdown-item"><!----> <a href="/note/framework/netty/netty-business-logic.html" class="nav-link">
  Netty
</a></li><li class="dropdown-item"><!----> <a href="/note/framework/apollo/setup-debug-enviroment.html" class="nav-link">
  Apollo源码分析
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="架构" class="dropdown-title"><span class="title">架构</span> <span class="arrow down"></span></button> <button type="button" aria-label="架构" class="mobile-dropdown-title"><span class="title">架构</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/note/arch/system-design/01-scale-from-zero.html" class="nav-link">
  系统设计
</a></li><li class="dropdown-item"><!----> <a href="/note/arch/case-study/rate-limiter.html" class="nav-link">
  案例
</a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Apollo源码分析</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/note/framework/apollo/setup-debug-enviroment.html" class="sidebar-link">Apollo调试环境搭建</a></li><li><a href="/note/framework/apollo/portal-create-app.html" class="sidebar-link">Apollo源码分析——Portal创建App</a></li><li><a href="/note/framework/apollo/portal-create-cluster.html" class="sidebar-link">Apollo源码分析——Portal创建Cluster</a></li><li><a href="/note/framework/apollo/portal-create-appnamespace.html" class="sidebar-link">Apollo源码分析——Portal创建Namespace</a></li><li><a href="/note/framework/apollo/portal-create-namespace.html" class="sidebar-link">Apollo源码分析——Portal关联Namespace</a></li><li><a href="/note/framework/apollo/portal-create-item.html" class="sidebar-link">Apollo源码分析——Portal创建Item</a></li><li><a href="/note/framework/apollo/portal-create-item-by-text.html" class="sidebar-link">Apollo源码分析——Portal文本变更Item</a></li><li><a href="/note/framework/apollo/portal-publish.html" class="sidebar-link">Apollo源码分析——Portal发布配置</a></li><li><a href="/note/framework/apollo/adminservice-send-release-message.html" aria-current="page" class="active sidebar-link">Apollo源码分析——AdminService发布ReleaseMessage</a></li><li><a href="/note/framework/apollo/configservice-notifications.html" class="sidebar-link">Apollo源码分析——ConfigService通知配置变更</a></li><li><a href="/note/framework/apollo/configservice-query-api.html" class="sidebar-link">Apollo源码分析——ConfigService配置查询</a></li><li><a href="/note/framework/apollo/client-poll-config.html" class="sidebar-link">Apollo源码分析——Client拉取配置</a></li><li><a href="/note/framework/apollo/portal-create-namespace-branch.html" class="sidebar-link">Apollo源码分析——Portal 创建灰度</a></li><li><a href="/note/framework/apollo/portal-create-namespace-branch-gray-rule.html" class="sidebar-link">Apollo源码分析——Portal 配置灰度规则</a></li><li><a href="/note/framework/apollo/portal-publish-namespace-branch-to-master.html" class="sidebar-link">Apollo源码分析——Portal 灰度全量发布</a></li><li><a href="/note/framework/apollo/portal-publish-namespace-branch.html" class="sidebar-link">Apollo 源码解析 —— Portal 灰度发布</a></li><li><a href="/note/framework/apollo/client-config-api-1.html" class="sidebar-link">Apollo 源码解析 —— 客户端 API 配置（一）之一览</a></li><li><a href="/note/framework/apollo/client-config-api-2.html" class="sidebar-link">Apollo 源码解析 —— 客户端 API 配置（二）之 Config</a></li><li><a href="/note/framework/apollo/client-config-api-3.html" class="sidebar-link">Apollo 源码解析 —— 客户端 API 配置（三）之 ConfigFile</a></li><li><a href="/note/framework/apollo/client-config-api-4.html" class="sidebar-link">Apollo 源码解析 —— 客户端 API 配置（四）之 ConfigRepository                            </a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="apollo源码分析-发送releasemessage"><a href="#apollo源码分析-发送releasemessage" class="header-anchor">#</a> Apollo源码分析——发送ReleaseMessage</h1> <p></p><div class="table-of-contents"><ul><li><a href="#apollo源码分析-发送releasemessage">Apollo源码分析——发送ReleaseMessage</a><ul><li><a href="#概述">概述</a></li><li><a href="#releasecontroller">ReleaseController</a></li><li><a href="#releasemessagekeygenerator">ReleaseMessageKeyGenerator</a></li><li><a href="#messagesender">MessageSender</a></li><li><a href="#releasemessagelistener">ReleaseMessageListener</a></li><li><a href="#releasemessagescanner">ReleaseMessageScanner</a><ul><li><a href="#scanmessages">scanMessages</a></li><li><a href="#scanmissingmessages">scanMissingMessages</a></li></ul></li></ul></li></ul></div><p></p> <h2 id="概述"><a href="#概述" class="header-anchor">#</a> 概述</h2> <p>以下内容来自<a href="https://www.apolloconfig.com/#/zh/design/apollo-design" target="_blank" rel="noopener noreferrer">Apollo配置中心设计<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <blockquote><p>Admin Service在配置发布后，需要通知所有的Config Service有配置发布，从而Config Service可以通知对应的客户端来拉取最新的配置。</p> <p>从概念上来看，这是一个典型的消息使用场景，Admin Service作为producer发出消息，各个Config Service作为consumer消费消息。通过一个消息组件（Message Queue）就能很好的实现Admin Service和Config Service的解耦。</p> <p>在实现上，考虑到Apollo的实际使用场景，以及为了尽可能减少外部依赖，我们没有采用外部的消息中间件，而是通过数据库实现了一个简单的消息队列。</p></blockquote> <p>实现方式如下：</p> <blockquote><ol><li>Admin Service在配置发布后会往ReleaseMessage表插入一条消息记录，消息内容就是配置发布的AppId+Cluster+Namespace，参见DatabaseMessageSender</li> <li>Config Service有一个线程会每秒扫描一次ReleaseMessage表，看看是否有新的消息记录，参见ReleaseMessageScanner</li> <li>Config Service如果发现有新的消息记录，那么就会通知到所有的消息监听器（ReleaseMessageListener），如NotificationControllerV2，消息监听器的注册过程参见ConfigServiceAutoConfiguration</li> <li>NotificationControllerV2得到配置发布的AppId+Cluster+Namespace后，会通知对应的客户端</li></ol></blockquote> <h2 id="releasecontroller"><a href="#releasecontroller" class="header-anchor">#</a> ReleaseController</h2> <p>前文提到，<code>apollo-adminservice</code>模块<code>com.ctrip.framework.apollo.adminservice.controller.ReleaseController</code>的<code>publish</code>方法创建Release时，会发送一个Release消息，代码如下所示</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Transactional</span>
<span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/apps/{appId}/clusters/{clusterName}/namespaces/{namespaceName}/releases&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">ReleaseDTO</span> <span class="token function">publish</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">&quot;appId&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> appId<span class="token punctuation">,</span>
                            <span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">&quot;clusterName&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> clusterName<span class="token punctuation">,</span>
                            <span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">&quot;namespaceName&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> namespaceName<span class="token punctuation">,</span>
                            <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> releaseName<span class="token punctuation">,</span>
                            <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;comment&quot;</span><span class="token punctuation">,</span> required <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token class-name">String</span> releaseComment<span class="token punctuation">,</span>
                            <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;operator&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> operator<span class="token punctuation">,</span>
                            <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;isEmergencyPublish&quot;</span><span class="token punctuation">,</span> defaultValue <span class="token operator">=</span> <span class="token string">&quot;false&quot;</span><span class="token punctuation">)</span> <span class="token keyword">boolean</span> isEmergencyPublish<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Namespace</span> namespace <span class="token operator">=</span> namespaceService<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span>appId<span class="token punctuation">,</span> clusterName<span class="token punctuation">,</span> namespaceName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>namespace <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token class-name">NotFoundException</span><span class="token punctuation">.</span><span class="token function">namespaceNotFound</span><span class="token punctuation">(</span>appId<span class="token punctuation">,</span> clusterName<span class="token punctuation">,</span> namespaceName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">Release</span> release <span class="token operator">=</span> releaseService<span class="token punctuation">.</span><span class="token function">publish</span><span class="token punctuation">(</span>namespace<span class="token punctuation">,</span> releaseName<span class="token punctuation">,</span> releaseComment<span class="token punctuation">,</span> operator<span class="token punctuation">,</span> isEmergencyPublish<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//send release message</span>
    <span class="token class-name">Namespace</span> parentNamespace <span class="token operator">=</span> namespaceService<span class="token punctuation">.</span><span class="token function">findParentNamespace</span><span class="token punctuation">(</span>namespace<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> messageCluster<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>parentNamespace <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        messageCluster <span class="token operator">=</span> parentNamespace<span class="token punctuation">.</span><span class="token function">getClusterName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        messageCluster <span class="token operator">=</span> clusterName<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    messageSender<span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span><span class="token class-name">ReleaseMessageKeyGenerator</span><span class="token punctuation">.</span><span class="token function">generate</span><span class="token punctuation">(</span>appId<span class="token punctuation">,</span> messageCluster<span class="token punctuation">,</span> namespaceName<span class="token punctuation">)</span><span class="token punctuation">,</span>
                              <span class="token class-name">Topics</span><span class="token punctuation">.</span><span class="token constant">APOLLO_RELEASE_TOPIC</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token class-name">BeanUtils</span><span class="token punctuation">.</span><span class="token function">transform</span><span class="token punctuation">(</span><span class="token class-name">ReleaseDTO</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> release<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="releasemessagekeygenerator"><a href="#releasemessagekeygenerator" class="header-anchor">#</a> ReleaseMessageKeyGenerator</h2> <p><code>com.ctrip.framework.apollo.biz.utils.ReleaseMessageKeyGenerator</code>生成消息内容</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// +</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Joiner</span> <span class="token constant">STRING_JOINER</span> <span class="token operator">=</span> <span class="token class-name">Joiner</span><span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token class-name">ConfigConsts</span><span class="token punctuation">.</span><span class="token constant">CLUSTER_NAMESPACE_SEPARATOR</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">generate</span><span class="token punctuation">(</span><span class="token class-name">String</span> appId<span class="token punctuation">,</span> <span class="token class-name">String</span> cluster<span class="token punctuation">,</span> <span class="token class-name">String</span> namespace<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token constant">STRING_JOINER</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>appId<span class="token punctuation">,</span> cluster<span class="token punctuation">,</span> namespace<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>generate</code>方法，将<code>appId</code>、<code>cluster</code>、<code>namespace</code>用<code>+</code>拼接到一起，例如：<code>test+default+application</code></p> <p>对同一个Namespace，生成的消息内容是相同的。通过这种方式，我们可以使用最新的 ReleaseMessage 的 id 属性，作为 Namespace 是否发生变更的标识。而 Apollo 确实是通过这样的方式实现，Client 通过不断使用获得到 ReleaseMessage 的 id 属性作为版本号，请求 Config Service 判断是否配置发生了变化。</p> <h2 id="messagesender"><a href="#messagesender" class="header-anchor">#</a> MessageSender</h2> <p><code>com.ctrip.framework.apollo.biz.message.MessageSender</code>定义了消息发送者的接口</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">MessageSender</span> <span class="token punctuation">{</span>
    <span class="token keyword">void</span> <span class="token function">sendMessage</span><span class="token punctuation">(</span><span class="token class-name">String</span> message<span class="token punctuation">,</span> <span class="token class-name">String</span> channel<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>com.ctrip.framework.apollo.biz.message.DatabaseMessageSender</code>是<code>MessageSender</code>接口的唯一实现</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Transactional</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">sendMessage</span><span class="token punctuation">(</span><span class="token class-name">String</span> message<span class="token punctuation">,</span> <span class="token class-name">String</span> channel<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Sending message {} to channel {}&quot;</span><span class="token punctuation">,</span> message<span class="token punctuation">,</span> channel<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> <span class="token class-name">Topics</span><span class="token punctuation">.</span><span class="token constant">APOLLO_RELEASE_TOPIC</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        logger<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;Channel {} not supported by DatabaseMessageSender!&quot;</span><span class="token punctuation">,</span> channel<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token class-name">Tracer</span><span class="token punctuation">.</span><span class="token function">logEvent</span><span class="token punctuation">(</span><span class="token string">&quot;Apollo.AdminService.ReleaseMessage&quot;</span><span class="token punctuation">,</span> message<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Transaction</span> transaction <span class="token operator">=</span> <span class="token class-name">Tracer</span><span class="token punctuation">.</span><span class="token function">newTransaction</span><span class="token punctuation">(</span><span class="token string">&quot;Apollo.AdminService&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;sendMessage&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token class-name">ReleaseMessage</span> newMessage <span class="token operator">=</span> releaseMessageRepository<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ReleaseMessage</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>toClean<span class="token punctuation">.</span><span class="token function">offer</span><span class="token punctuation">(</span>newMessage<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            logger<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;Queue is full, Failed to add message {} to clean queue&quot;</span><span class="token punctuation">,</span> newMessage<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        transaction<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token class-name">Transaction</span><span class="token punctuation">.</span><span class="token constant">SUCCESS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;Sending message to database failed&quot;</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        transaction<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span>ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">throw</span> ex<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        transaction<span class="token punctuation">.</span><span class="token function">complete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ol><li>判断<code>channel</code>如果不是<code>Topics.APOLLO_RELEASE_TOPIC</code>即<code>apollo-release</code>，直接返回</li> <li>创建ReleaseMessage对象，并调用<code>releaseMessageRepository.save</code>保存到数据库中</li> <li>将ReleaseMessage对象的id加入到<code>toClean</code>队列中，<code>toClean</code>是<code>DatabaseMessageSender</code>的一个阻塞队列，默认长度100</li></ol> <p><code>DatabaseMessageSender</code>构造方法中创建了一个单线程的线程池<code>cleanExecutorService</code></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">DatabaseMessageSender</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">ReleaseMessageRepository</span> releaseMessageRepository<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    cleanExecutorService <span class="token operator">=</span> <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newSingleThreadExecutor</span><span class="token punctuation">(</span><span class="token class-name">ApolloThreadFactory</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token string">&quot;DatabaseMessageSender&quot;</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    cleanStopped <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicBoolean</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>releaseMessageRepository <span class="token operator">=</span> releaseMessageRepository<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>在<code>initialize</code>方法被Spring回调时，会向<code>cleanExecutorService</code>线程池中提交一个后台线程任务</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@PostConstruct</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">initialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    cleanExecutorService<span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>cleanStopped<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isInterrupted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token class-name">Long</span> rm <span class="token operator">=</span> toClean<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>rm <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">cleanMessage</span><span class="token punctuation">(</span>rm<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">Tracer</span><span class="token punctuation">.</span><span class="token function">logError</span><span class="token punctuation">(</span>ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>后台任务会不断从<code>toClean</code>队列中获取ReleaseMessage对象的id，如果id存在调用<code>cleanMessage</code>方法，否则sleep 5秒后继续从队列中获取id</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">cleanMessage</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//double check in case the release message is rolled back</span>
    <span class="token class-name">ReleaseMessage</span> releaseMessage <span class="token operator">=</span> releaseMessageRepository<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">orElse</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>releaseMessage <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">boolean</span> hasMore <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>hasMore <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isInterrupted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ReleaseMessage</span><span class="token punctuation">&gt;</span></span> messages <span class="token operator">=</span> releaseMessageRepository<span class="token punctuation">.</span><span class="token function">findFirst100ByMessageAndIdLessThanOrderByIdAsc</span><span class="token punctuation">(</span>
            releaseMessage<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> releaseMessage<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        releaseMessageRepository<span class="token punctuation">.</span><span class="token function">deleteAll</span><span class="token punctuation">(</span>messages<span class="token punctuation">)</span><span class="token punctuation">;</span>
        hasMore <span class="token operator">=</span> messages<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">100</span><span class="token punctuation">;</span>

        messages<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>toRemove <span class="token operator">-&gt;</span> <span class="token class-name">Tracer</span><span class="token punctuation">.</span><span class="token function">logEvent</span><span class="token punctuation">(</span>
            <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;ReleaseMessage.Clean.%s&quot;</span><span class="token punctuation">,</span> toRemove<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>toRemove<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ol><li>调用<code>releaseMessageRepository.findById</code>方法查询id对应的ReleaseMessage对象，避免对象已被删除。
<ul><li>这是因为<code>DatabaseMessageSender</code>会在多进程中执行，例如：1) Config Service + Admin Service；2) N * Config Service；3) N * Admin Service</li> <li>为什么 Config Service 和 Admin Service 都会启动清理任务呢？因为<code>DatabaseMessageSender</code>添加了<code>@Component</code>注解，而<code>NamespaceService</code>注入了 <code>DatabaseMessageSender</code> 。而<code>NamespaceService</code>被<code>apollo-adminservice</code>和<code>apoll-configservice</code>项目都引用了，所以都会启动该任务。</li></ul></li> <li>循环删除，相同消息内容( ReleaseMessage.message )的老消息，即 Namespace 的老消息。
<ul><li>调用<code>ReleaseMessageRepository#findFirst100ByMessageAndIdLessThanOrderByIdAsc(message, id)</code>方法，拉取相同消息内容的 100 条的老消息，按照 id 升序。</li> <li>调用<code>ReleaseMessageRepository#delete(messages)</code>方法，删除老消息。</li> <li>若拉取不足 100 条，说明无老消息了。</li></ul></li></ol> <h2 id="releasemessagelistener"><a href="#releasemessagelistener" class="header-anchor">#</a> ReleaseMessageListener</h2> <p><code>com.ctrip.framework.apollo.biz.message.ReleaseMessageListener</code>，ReleaseMessage的监听器接口</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">ReleaseMessageListener</span> <span class="token punctuation">{</span>
    <span class="token keyword">void</span> <span class="token function">handleMessage</span><span class="token punctuation">(</span><span class="token class-name">ReleaseMessage</span> message<span class="token punctuation">,</span> <span class="token class-name">String</span> channel<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>com.ctrip.framework.apollo.biz.message.ReleaseMessageListener</code>接口的实现类如下图所示</p> <p><img src="/note/assets/img/55d7f9c612fb9624b749eb64f57dab4e.55d7f9c6.png" alt=""></p> <h2 id="releasemessagescanner"><a href="#releasemessagescanner" class="header-anchor">#</a> ReleaseMessageScanner</h2> <p><code>com.ctrip.framework.apollo.biz.message.ReleaseMessageScanner</code>，ReleaseMessage的扫描器，<code>apollo-configservce</code>的自动配置类<code>ConfigServiceAutoConfiguration</code>中会创建该Bean，并添加一系列的<code>ReleaseMessageListener</code></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">ReleaseMessageScanner</span> <span class="token function">releaseMessageScanner</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token class-name">ReleaseMessageScanner</span> releaseMessageScanner <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReleaseMessageScanner</span><span class="token punctuation">(</span>bizConfig<span class="token punctuation">,</span>
          releaseMessageRepository<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">//0. handle release message cache</span>
      releaseMessageScanner<span class="token punctuation">.</span><span class="token function">addMessageListener</span><span class="token punctuation">(</span>releaseMessageServiceWithCache<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">//1. handle gray release rule</span>
      releaseMessageScanner<span class="token punctuation">.</span><span class="token function">addMessageListener</span><span class="token punctuation">(</span>grayReleaseRulesHolder<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">//2. handle server cache</span>
      releaseMessageScanner<span class="token punctuation">.</span><span class="token function">addMessageListener</span><span class="token punctuation">(</span>configService<span class="token punctuation">)</span><span class="token punctuation">;</span>
      releaseMessageScanner<span class="token punctuation">.</span><span class="token function">addMessageListener</span><span class="token punctuation">(</span>configFileController<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">//3. notify clients</span>
      releaseMessageScanner<span class="token punctuation">.</span><span class="token function">addMessageListener</span><span class="token punctuation">(</span>notificationControllerV2<span class="token punctuation">)</span><span class="token punctuation">;</span>
      releaseMessageScanner<span class="token punctuation">.</span><span class="token function">addMessageListener</span><span class="token punctuation">(</span>notificationController<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> releaseMessageScanner<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><p><code>ReleaseMessageScanner</code>构造方法中创建了一个定时调度的线程池<code>executorService</code></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">ReleaseMessageScanner</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">BizConfig</span> bizConfig<span class="token punctuation">,</span>
      <span class="token keyword">final</span> <span class="token class-name">ReleaseMessageRepository</span> releaseMessageRepository<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>bizConfig <span class="token operator">=</span> bizConfig<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>releaseMessageRepository <span class="token operator">=</span> releaseMessageRepository<span class="token punctuation">;</span>
    listeners <span class="token operator">=</span> <span class="token class-name">Lists</span><span class="token punctuation">.</span><span class="token function">newCopyOnWriteArrayList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    executorService <span class="token operator">=</span> <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newScheduledThreadPool</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token class-name">ApolloThreadFactory</span>
        <span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token string">&quot;ReleaseMessageScanner&quot;</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    missingReleaseMessages <span class="token operator">=</span> <span class="token class-name">Maps</span><span class="token punctuation">.</span><span class="token function">newHashMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>ReleaseMessageScanner</code>实现了Spring的<code>InitializingBean</code>，当Spring完成Bean初始化后，回调<code>afterPropertiesSet</code>方法，这个方法中向线程池<code>executorService</code>提交了一个定时被调度执行的后台任务</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">afterPropertiesSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    databaseScanInterval <span class="token operator">=</span> bizConfig<span class="token punctuation">.</span><span class="token function">releaseMessageScanIntervalInMilli</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    maxIdScanned <span class="token operator">=</span> <span class="token function">loadLargestMessageId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    executorService<span class="token punctuation">.</span><span class="token function">scheduleWithFixedDelay</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        <span class="token class-name">Transaction</span> transaction <span class="token operator">=</span> <span class="token class-name">Tracer</span><span class="token punctuation">.</span><span class="token function">newTransaction</span><span class="token punctuation">(</span><span class="token string">&quot;Apollo.ReleaseMessageScanner&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;scanMessage&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token function">scanMissingMessages</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">scanMessages</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            transaction<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token class-name">Transaction</span><span class="token punctuation">.</span><span class="token constant">SUCCESS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            transaction<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span>ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
            logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;Scan and send message failed&quot;</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            transaction<span class="token punctuation">.</span><span class="token function">complete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> databaseScanInterval<span class="token punctuation">,</span> databaseScanInterval<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MILLISECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><ol><li>调度的时间间隔<code>databaseScanInterval</code>从<code>bizConfig.releaseMessageScanIntervalInMilli</code>方法返回，这个参数key是<code>apollo.message-scan.interval</code>，默认值是1000ms</li> <li>调用<code>loadLargestMessageId</code>方法，获得最大的ReleaseMessage的id<div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">long</span> <span class="token function">loadLargestMessageId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">ReleaseMessage</span> releaseMessage <span class="token operator">=</span> releaseMessageRepository<span class="token punctuation">.</span><span class="token function">findTopByOrderByIdDesc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> releaseMessage <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token number">0</span> <span class="token operator">:</span> releaseMessage<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li>调用<code>executorService.scheduleWithFixedDelay</code>提交定时任务，定时任务主要由<code>scanMissingMessages</code>和<code>scanMessages</code>方法组成</li></ol> <h3 id="scanmessages"><a href="#scanmessages" class="header-anchor">#</a> scanMessages</h3> <p><code>scanMessages</code>方法里while循环不断调用<code>scanAndSendMessages</code>方法扫描并发送消息，只要还有更多消息且线程未被中断，就一直循环执行</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">scanMessages</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">boolean</span> hasMoreMessages <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>hasMoreMessages <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isInterrupted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      hasMoreMessages <span class="token operator">=</span> <span class="token function">scanAndSendMessages</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>scanAndSendMessages</code>方法扫描ReleaseMessage表并回调<code>ReleaseMessageListener</code>接口实现</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">scanAndSendMessages</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//current batch is 500</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ReleaseMessage</span><span class="token punctuation">&gt;</span></span> releaseMessages <span class="token operator">=</span>
        releaseMessageRepository<span class="token punctuation">.</span><span class="token function">findFirst500ByIdGreaterThanOrderByIdAsc</span><span class="token punctuation">(</span>maxIdScanned<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">CollectionUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>releaseMessages<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">fireMessageScanned</span><span class="token punctuation">(</span>releaseMessages<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> messageScanned <span class="token operator">=</span> releaseMessages<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">long</span> newMaxIdScanned <span class="token operator">=</span> releaseMessages<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>messageScanned <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// check id gaps, possible reasons are release message not committed yet or already rolled back</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>newMaxIdScanned <span class="token operator">-</span> maxIdScanned <span class="token operator">&gt;</span> messageScanned<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">recordMissingReleaseMessageIds</span><span class="token punctuation">(</span>releaseMessages<span class="token punctuation">,</span> maxIdScanned<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    maxIdScanned <span class="token operator">=</span> newMaxIdScanned<span class="token punctuation">;</span>
    <span class="token keyword">return</span> messageScanned <span class="token operator">==</span> <span class="token number">500</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><ol><li>扫描时会查询<code>maxIdScanned</code>之后按ID升序排序后的前500个ReleaseMessage，500是固定的batch size</li> <li>调用<code>fireMessageScanned</code>通知所有listener<div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">fireMessageScanned</span><span class="token punctuation">(</span><span class="token class-name">Iterable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ReleaseMessage</span><span class="token punctuation">&gt;</span></span> messages<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">ReleaseMessage</span> message <span class="token operator">:</span> messages<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">ReleaseMessageListener</span> listener <span class="token operator">:</span> listeners<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                listener<span class="token punctuation">.</span><span class="token function">handleMessage</span><span class="token punctuation">(</span>message<span class="token punctuation">,</span> <span class="token class-name">Topics</span><span class="token punctuation">.</span><span class="token constant">APOLLO_RELEASE_TOPIC</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">Tracer</span><span class="token punctuation">.</span><span class="token function">logError</span><span class="token punctuation">(</span>ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
                logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to invoke message listener {}&quot;</span><span class="token punctuation">,</span> listener<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li>取查询到的列表的size为<code>messageScanned</code>，最后一条记录的ID为<code>newMaxIdScanned</code></li> <li>如果<code>newMaxIdScanned</code>和<code>maxIdScanned</code>的差值大于<code>messageScanned</code>，说明查询到的列表不连续、中间存在空洞，可能是ReleaseMessage记录数据库尚未commit或已经回滚，这种情况时调用<code>recordMissingReleaseMessageIds</code>方法将中间空洞缺少的ID记录到<code>missingReleaseMessages</code>中<div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">recordMissingReleaseMessageIds</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ReleaseMessage</span><span class="token punctuation">&gt;</span></span> messages<span class="token punctuation">,</span> <span class="token keyword">long</span> startId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">ReleaseMessage</span> message <span class="token operator">:</span> messages<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">long</span> currentId <span class="token operator">=</span> message<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>currentId <span class="token operator">-</span> startId <span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">long</span> i <span class="token operator">=</span> startId <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> currentId<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                missingReleaseMessages<span class="token punctuation">.</span><span class="token function">putIfAbsent</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        startId <span class="token operator">=</span> currentId<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li></ol> <h3 id="scanmissingmessages"><a href="#scanmissingmessages" class="header-anchor">#</a> scanMissingMessages</h3> <p><code>scanMissingMessages</code>方法会从<code>missingReleaseMessages</code>中查找曾经缺失的ReleaseMessage，找到的ReleaseMessage会调用<code>fireMessageScanned</code>回调listener，并从<code>missingReleaseMessages</code>中移除掉</p> <div class="language-java extra-class"><pre class="language-java"><code>rivate <span class="token keyword">void</span> <span class="token function">scanMissingMessages</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> missingReleaseMessageIds <span class="token operator">=</span> missingReleaseMessages<span class="token punctuation">.</span><span class="token function">keySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Iterable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ReleaseMessage</span><span class="token punctuation">&gt;</span></span> releaseMessages <span class="token operator">=</span> releaseMessageRepository
        <span class="token punctuation">.</span><span class="token function">findAllById</span><span class="token punctuation">(</span>missingReleaseMessageIds<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">fireMessageScanned</span><span class="token punctuation">(</span>releaseMessages<span class="token punctuation">)</span><span class="token punctuation">;</span>
    releaseMessages<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>releaseMessage <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        missingReleaseMessageIds<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>releaseMessage<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">growAndCleanMissingMessages</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>对于尚未commit的ReleaseMessage，commit后自然会被<code>scanMissingMessages</code>扫描到，但回滚的ReleaseMessage是扫描不到的，为了避免<code>missingReleaseMessages</code>不断增长，<code>growAndCleanMissingMessages</code>方法内部实现了自动清理的逻辑</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">growAndCleanMissingMessages</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Iterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Entry</span><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> iterator <span class="token operator">=</span> missingReleaseMessages<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>iterator<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> entry <span class="token operator">=</span> iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>entry<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> missingReleaseMessageMaxAge<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            iterator<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            entry<span class="token punctuation">.</span><span class="token function">setValue</span><span class="token punctuation">(</span>entry<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>missingReleaseMessages</code>是个Map结构，key是ReleaseMessage对应的ID，value则是生命周期，每次扫描<code>missingReleaseMessages</code>时候value会增加1，当大于<code>missingReleaseMessageMaxAge</code>时remove掉。<code>missingReleaseMessageMaxAge</code>值目前是硬编码为10，不可配置，后续可能会被优化为可配置参数</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/note/framework/apollo/portal-publish.html" class="prev">
        Apollo源码分析——Portal发布配置
      </a></span> <span class="next"><a href="/note/framework/apollo/configservice-notifications.html">
        Apollo源码分析——ConfigService通知配置变更
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/note/assets/js/app.fe0ed53e.js" defer></script><script src="/note/assets/js/2.7b239f4c.js" defer></script><script src="/note/assets/js/1.51e4995c.js" defer></script><script src="/note/assets/js/48.92c8b712.js" defer></script>
  </body>
</html>
