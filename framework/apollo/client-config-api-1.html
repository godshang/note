<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Apollo 源码解析 —— 客户端 API 配置（一）之一览 | 开发者笔记</title>
    <meta name="generator" content="VuePress 1.9.10">
    
    <meta name="description" content="">
    
    <link rel="preload" href="/note/assets/css/0.styles.fa566ad0.css" as="style"><link rel="preload" href="/note/assets/js/app.e7654e9f.js" as="script"><link rel="preload" href="/note/assets/js/2.e810aa3c.js" as="script"><link rel="preload" href="/note/assets/js/1.07fc4d8c.js" as="script"><link rel="preload" href="/note/assets/js/37.8d31cfbf.js" as="script"><link rel="prefetch" href="/note/assets/js/10.555b32ff.js"><link rel="prefetch" href="/note/assets/js/100.d020d8ee.js"><link rel="prefetch" href="/note/assets/js/101.7683a3d7.js"><link rel="prefetch" href="/note/assets/js/102.88714d09.js"><link rel="prefetch" href="/note/assets/js/103.233ddbe4.js"><link rel="prefetch" href="/note/assets/js/104.e433d6c3.js"><link rel="prefetch" href="/note/assets/js/105.fe2e4966.js"><link rel="prefetch" href="/note/assets/js/106.d239b033.js"><link rel="prefetch" href="/note/assets/js/107.3026af59.js"><link rel="prefetch" href="/note/assets/js/108.36315191.js"><link rel="prefetch" href="/note/assets/js/109.81c1c194.js"><link rel="prefetch" href="/note/assets/js/11.028a3c1c.js"><link rel="prefetch" href="/note/assets/js/110.f821be7e.js"><link rel="prefetch" href="/note/assets/js/111.e072da72.js"><link rel="prefetch" href="/note/assets/js/112.c96d9beb.js"><link rel="prefetch" href="/note/assets/js/113.f62b712c.js"><link rel="prefetch" href="/note/assets/js/114.28d5802e.js"><link rel="prefetch" href="/note/assets/js/115.59b34590.js"><link rel="prefetch" href="/note/assets/js/116.e7563be8.js"><link rel="prefetch" href="/note/assets/js/117.2b203c5c.js"><link rel="prefetch" href="/note/assets/js/118.26adca05.js"><link rel="prefetch" href="/note/assets/js/119.54c5dd1e.js"><link rel="prefetch" href="/note/assets/js/12.1b649a19.js"><link rel="prefetch" href="/note/assets/js/120.b3a105c7.js"><link rel="prefetch" href="/note/assets/js/13.c8f31ead.js"><link rel="prefetch" href="/note/assets/js/14.f9046e47.js"><link rel="prefetch" href="/note/assets/js/15.3af5a383.js"><link rel="prefetch" href="/note/assets/js/16.9a3efa49.js"><link rel="prefetch" href="/note/assets/js/17.ef3ca875.js"><link rel="prefetch" href="/note/assets/js/18.831fa1a4.js"><link rel="prefetch" href="/note/assets/js/19.cfea4209.js"><link rel="prefetch" href="/note/assets/js/20.9c5bbcd6.js"><link rel="prefetch" href="/note/assets/js/21.3ad15aa3.js"><link rel="prefetch" href="/note/assets/js/22.45739dd6.js"><link rel="prefetch" href="/note/assets/js/23.0b3b321e.js"><link rel="prefetch" href="/note/assets/js/24.69ce0e0c.js"><link rel="prefetch" href="/note/assets/js/25.0730c414.js"><link rel="prefetch" href="/note/assets/js/26.2834d6fd.js"><link rel="prefetch" href="/note/assets/js/27.b67f9ce5.js"><link rel="prefetch" href="/note/assets/js/28.1b0ec007.js"><link rel="prefetch" href="/note/assets/js/29.c69a505d.js"><link rel="prefetch" href="/note/assets/js/3.922513d5.js"><link rel="prefetch" href="/note/assets/js/30.59c9f0f6.js"><link rel="prefetch" href="/note/assets/js/31.99a0ee4b.js"><link rel="prefetch" href="/note/assets/js/32.34fb1316.js"><link rel="prefetch" href="/note/assets/js/33.4c466f0a.js"><link rel="prefetch" href="/note/assets/js/34.11542871.js"><link rel="prefetch" href="/note/assets/js/35.f46213e9.js"><link rel="prefetch" href="/note/assets/js/36.191cc770.js"><link rel="prefetch" href="/note/assets/js/38.10058a9f.js"><link rel="prefetch" href="/note/assets/js/39.95b7b6ef.js"><link rel="prefetch" href="/note/assets/js/4.a1966589.js"><link rel="prefetch" href="/note/assets/js/40.aacc67a1.js"><link rel="prefetch" href="/note/assets/js/41.69d1900a.js"><link rel="prefetch" href="/note/assets/js/42.a10bf330.js"><link rel="prefetch" href="/note/assets/js/43.cca6ff22.js"><link rel="prefetch" href="/note/assets/js/44.90b90816.js"><link rel="prefetch" href="/note/assets/js/45.113abd6a.js"><link rel="prefetch" href="/note/assets/js/46.c428ba25.js"><link rel="prefetch" href="/note/assets/js/47.3fddf95f.js"><link rel="prefetch" href="/note/assets/js/48.cc7000a1.js"><link rel="prefetch" href="/note/assets/js/49.b873071f.js"><link rel="prefetch" href="/note/assets/js/5.b21639f8.js"><link rel="prefetch" href="/note/assets/js/50.fb0418b2.js"><link rel="prefetch" href="/note/assets/js/51.3933f89b.js"><link rel="prefetch" href="/note/assets/js/52.5d4b2e9e.js"><link rel="prefetch" href="/note/assets/js/53.b771539b.js"><link rel="prefetch" href="/note/assets/js/54.a0da92be.js"><link rel="prefetch" href="/note/assets/js/55.e3c32e70.js"><link rel="prefetch" href="/note/assets/js/56.c273a07a.js"><link rel="prefetch" href="/note/assets/js/57.d0e02578.js"><link rel="prefetch" href="/note/assets/js/58.72664a5f.js"><link rel="prefetch" href="/note/assets/js/59.d425fbf8.js"><link rel="prefetch" href="/note/assets/js/6.0299a03f.js"><link rel="prefetch" href="/note/assets/js/60.961047ab.js"><link rel="prefetch" href="/note/assets/js/61.dd024c7d.js"><link rel="prefetch" href="/note/assets/js/62.aa0ba217.js"><link rel="prefetch" href="/note/assets/js/63.e2a55dcc.js"><link rel="prefetch" href="/note/assets/js/64.30bf7f34.js"><link rel="prefetch" href="/note/assets/js/65.39726ca4.js"><link rel="prefetch" href="/note/assets/js/66.1addd97a.js"><link rel="prefetch" href="/note/assets/js/67.cc99e8a2.js"><link rel="prefetch" href="/note/assets/js/68.e278ab91.js"><link rel="prefetch" href="/note/assets/js/69.a9c2296f.js"><link rel="prefetch" href="/note/assets/js/7.84671687.js"><link rel="prefetch" href="/note/assets/js/70.51cd3ef1.js"><link rel="prefetch" href="/note/assets/js/71.78a7e100.js"><link rel="prefetch" href="/note/assets/js/72.d5f54084.js"><link rel="prefetch" href="/note/assets/js/73.2b2e81d3.js"><link rel="prefetch" href="/note/assets/js/74.026d5759.js"><link rel="prefetch" href="/note/assets/js/75.b315d618.js"><link rel="prefetch" href="/note/assets/js/76.e4402459.js"><link rel="prefetch" href="/note/assets/js/77.c492b51c.js"><link rel="prefetch" href="/note/assets/js/78.f13c15b5.js"><link rel="prefetch" href="/note/assets/js/79.6da0305c.js"><link rel="prefetch" href="/note/assets/js/80.10321fab.js"><link rel="prefetch" href="/note/assets/js/81.9daf45ce.js"><link rel="prefetch" href="/note/assets/js/82.17c606f7.js"><link rel="prefetch" href="/note/assets/js/83.68053253.js"><link rel="prefetch" href="/note/assets/js/84.cac1ee23.js"><link rel="prefetch" href="/note/assets/js/85.eb45d699.js"><link rel="prefetch" href="/note/assets/js/86.cdfbccd6.js"><link rel="prefetch" href="/note/assets/js/87.edc80e1b.js"><link rel="prefetch" href="/note/assets/js/88.d1cd3a58.js"><link rel="prefetch" href="/note/assets/js/89.ffd23af7.js"><link rel="prefetch" href="/note/assets/js/90.7ea29979.js"><link rel="prefetch" href="/note/assets/js/91.fa52ca7b.js"><link rel="prefetch" href="/note/assets/js/92.1aa72a1e.js"><link rel="prefetch" href="/note/assets/js/93.723b96db.js"><link rel="prefetch" href="/note/assets/js/94.e1a4317f.js"><link rel="prefetch" href="/note/assets/js/95.486c4f74.js"><link rel="prefetch" href="/note/assets/js/96.6f5bcf47.js"><link rel="prefetch" href="/note/assets/js/97.d196e0cc.js"><link rel="prefetch" href="/note/assets/js/98.3213f4f1.js"><link rel="prefetch" href="/note/assets/js/99.e73f1d6c.js"><link rel="prefetch" href="/note/assets/js/vendors~docsearch.200fb47e.js">
    <link rel="stylesheet" href="/note/assets/css/0.styles.fa566ad0.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/note/" class="home-link router-link-active"><!----> <span class="site-name">开发者笔记</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/note/" class="nav-link">
  Home
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Java" class="dropdown-title"><span class="title">Java</span> <span class="arrow down"></span></button> <button type="button" aria-label="Java" class="mobile-dropdown-title"><span class="title">Java</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/note/java/base/basic.html" class="nav-link">
  Java基础
</a></li><li class="dropdown-item"><!----> <a href="/note/java/collection/ArrayList.html" class="nav-link">
  Java集合框架
</a></li><li class="dropdown-item"><!----> <a href="/note/java/concurrent/Theory.html" class="nav-link">
  Java并发编程
</a></li><li class="dropdown-item"><!----> <a href="/note/java/jvm/memory.html" class="nav-link">
  JVM相关
</a></li><li class="dropdown-item"><!----> <a href="/note/java/nio/io.html" class="nav-link">
  Java NIO相关
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="数据存储" class="dropdown-title"><span class="title">数据存储</span> <span class="arrow down"></span></button> <button type="button" aria-label="数据存储" class="mobile-dropdown-title"><span class="title">数据存储</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/note/storage/database/mysql.html" class="nav-link">
  MySQL
</a></li><li class="dropdown-item"><!----> <a href="/note/storage/redis/redis-question.html" class="nav-link">
  Redis
</a></li><li class="dropdown-item"><!----> <a href="/note/storage/mq/kafka-intro.html" class="nav-link">
  消息队列
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="框架" class="dropdown-title"><span class="title">框架</span> <span class="arrow down"></span></button> <button type="button" aria-label="框架" class="mobile-dropdown-title"><span class="title">框架</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/note/framework/spring-framework/spring-framework-intro.html" class="nav-link">
  Spring框架
</a></li><li class="dropdown-item"><!----> <a href="/note/framework/netty/netty-business-logic.html" class="nav-link">
  Netty
</a></li><li class="dropdown-item"><!----> <a href="/note/framework/apollo/setup-debug-enviroment.html" class="nav-link">
  Apollo源码分析
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="架构" class="dropdown-title"><span class="title">架构</span> <span class="arrow down"></span></button> <button type="button" aria-label="架构" class="mobile-dropdown-title"><span class="title">架构</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/note/arch/system-design/01-scale-from-zero.html" class="nav-link">
  系统设计
</a></li><li class="dropdown-item"><!----> <a href="/note/arch/case-study/rate-limiter.html" class="nav-link">
  案例
</a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/note/" class="nav-link">
  Home
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Java" class="dropdown-title"><span class="title">Java</span> <span class="arrow down"></span></button> <button type="button" aria-label="Java" class="mobile-dropdown-title"><span class="title">Java</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/note/java/base/basic.html" class="nav-link">
  Java基础
</a></li><li class="dropdown-item"><!----> <a href="/note/java/collection/ArrayList.html" class="nav-link">
  Java集合框架
</a></li><li class="dropdown-item"><!----> <a href="/note/java/concurrent/Theory.html" class="nav-link">
  Java并发编程
</a></li><li class="dropdown-item"><!----> <a href="/note/java/jvm/memory.html" class="nav-link">
  JVM相关
</a></li><li class="dropdown-item"><!----> <a href="/note/java/nio/io.html" class="nav-link">
  Java NIO相关
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="数据存储" class="dropdown-title"><span class="title">数据存储</span> <span class="arrow down"></span></button> <button type="button" aria-label="数据存储" class="mobile-dropdown-title"><span class="title">数据存储</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/note/storage/database/mysql.html" class="nav-link">
  MySQL
</a></li><li class="dropdown-item"><!----> <a href="/note/storage/redis/redis-question.html" class="nav-link">
  Redis
</a></li><li class="dropdown-item"><!----> <a href="/note/storage/mq/kafka-intro.html" class="nav-link">
  消息队列
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="框架" class="dropdown-title"><span class="title">框架</span> <span class="arrow down"></span></button> <button type="button" aria-label="框架" class="mobile-dropdown-title"><span class="title">框架</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/note/framework/spring-framework/spring-framework-intro.html" class="nav-link">
  Spring框架
</a></li><li class="dropdown-item"><!----> <a href="/note/framework/netty/netty-business-logic.html" class="nav-link">
  Netty
</a></li><li class="dropdown-item"><!----> <a href="/note/framework/apollo/setup-debug-enviroment.html" class="nav-link">
  Apollo源码分析
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="架构" class="dropdown-title"><span class="title">架构</span> <span class="arrow down"></span></button> <button type="button" aria-label="架构" class="mobile-dropdown-title"><span class="title">架构</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/note/arch/system-design/01-scale-from-zero.html" class="nav-link">
  系统设计
</a></li><li class="dropdown-item"><!----> <a href="/note/arch/case-study/rate-limiter.html" class="nav-link">
  案例
</a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Apollo源码分析</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/note/framework/apollo/setup-debug-enviroment.html" class="sidebar-link">Apollo调试环境搭建</a></li><li><a href="/note/framework/apollo/portal-create-app.html" class="sidebar-link">Apollo源码分析——Portal创建App</a></li><li><a href="/note/framework/apollo/portal-create-cluster.html" class="sidebar-link">Apollo源码分析——Portal创建Cluster</a></li><li><a href="/note/framework/apollo/portal-create-appnamespace.html" class="sidebar-link">Apollo源码分析——Portal创建Namespace</a></li><li><a href="/note/framework/apollo/portal-create-namespace.html" class="sidebar-link">Apollo源码分析——Portal关联Namespace</a></li><li><a href="/note/framework/apollo/portal-create-item.html" class="sidebar-link">Apollo源码分析——Portal创建Item</a></li><li><a href="/note/framework/apollo/portal-create-item-by-text.html" class="sidebar-link">Apollo源码分析——Portal文本变更Item</a></li><li><a href="/note/framework/apollo/portal-publish.html" class="sidebar-link">Apollo源码分析——Portal发布配置</a></li><li><a href="/note/framework/apollo/adminservice-send-release-message.html" class="sidebar-link">Apollo源码分析——AdminService发布ReleaseMessage</a></li><li><a href="/note/framework/apollo/configservice-notifications.html" class="sidebar-link">Apollo源码分析——ConfigService通知配置变更</a></li><li><a href="/note/framework/apollo/configservice-query-api.html" class="sidebar-link">Apollo源码分析——ConfigService配置查询</a></li><li><a href="/note/framework/apollo/client-poll-config.html" class="sidebar-link">Apollo源码分析——Client拉取配置</a></li><li><a href="/note/framework/apollo/portal-create-namespace-branch.html" class="sidebar-link">Apollo源码分析——Portal 创建灰度</a></li><li><a href="/note/framework/apollo/portal-create-namespace-branch-gray-rule.html" class="sidebar-link">Apollo源码分析——Portal 配置灰度规则</a></li><li><a href="/note/framework/apollo/portal-publish-namespace-branch-to-master.html" class="sidebar-link">Apollo源码分析——Portal 灰度全量发布</a></li><li><a href="/note/framework/apollo/portal-publish-namespace-branch.html" class="sidebar-link">Apollo 源码解析 —— Portal 灰度发布</a></li><li><a href="/note/framework/apollo/client-config-api-1.html" aria-current="page" class="active sidebar-link">Apollo 源码解析 —— 客户端 API 配置（一）之一览</a></li><li><a href="/note/framework/apollo/client-config-api-2.html" class="sidebar-link">Apollo 源码解析 —— 客户端 API 配置（二）之 Config</a></li><li><a href="/note/framework/apollo/client-config-api-3.html" class="sidebar-link">Apollo 源码解析 —— 客户端 API 配置（三）之 ConfigFile</a></li><li><a href="/note/framework/apollo/client-config-api-4.html" class="sidebar-link">Apollo 源码解析 —— 客户端 API 配置（四）之 ConfigRepository                            </a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="apollo-源码解析-客户端-api-配置-一-之一览"><a href="#apollo-源码解析-客户端-api-配置-一-之一览" class="header-anchor">#</a> Apollo 源码解析 —— 客户端 API 配置（一）之一览</h1> <h2 id="概述"><a href="#概述" class="header-anchor">#</a> 概述</h2> <p><img src="/note/assets/img/d604f9b486da0304ed89e52cd38b803f.d604f9b4.png" alt=""></p> <h2 id="configservice"><a href="#configservice" class="header-anchor">#</a> ConfigService</h2> <p><code>com.ctrip.framework.apollo.ConfigService</code> ，客户端配置服务，作为配置使用的入口。</p> <h3 id="构造方法"><a href="#构造方法" class="header-anchor">#</a> 构造方法</h3> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * 单例
 */</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">ConfigService</span> s_instance <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConfigService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token class-name">ConfigManager</span> m_configManager<span class="token punctuation">;</span>
<span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token class-name">ConfigRegistry</span> m_configRegistry<span class="token punctuation">;</span>
</code></pre></div><ul><li><code>s_instance</code> 静态，单例。</li> <li><code>m_configManager</code> 属性，通过 #getManager() 方法获得。代码如下：<div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token class-name">ConfigManager</span> <span class="token function">getManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>m_configManager <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>m_configManager <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                m_configManager <span class="token operator">=</span> <span class="token class-name">ApolloInjector</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token class-name">ConfigManager</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> m_configManager<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>调用 <code>ApolloInjector#getInstance(Class&lt;T&gt;)</code> 方法，获得 ConfigManager 单例。</li></ul></li> <li><code>m_configRegistry</code> 属性，通过 #getRegistry() 方法获得。代码如下：<div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token class-name">ConfigRegistry</span> <span class="token function">getRegistry</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>m_configRegistry <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>m_configRegistry <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                m_configRegistry <span class="token operator">=</span> <span class="token class-name">ApolloInjector</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token class-name">ConfigRegistry</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> m_configRegistry<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div></li></ul> <h3 id="获得配置对象"><a href="#获得配置对象" class="header-anchor">#</a> 获得配置对象</h3> <p>在 Apollo 客户端中，有两种形式的配置对象的接口：</p> <ul><li>Config ，配置接口</li> <li>ConfigFile ，配置文件接口</li></ul> <p>实际情况下，我们使用 Config 居多。另外，有一点需要注意，Config 和 ConfigFile 差异在于形式，而不是类型。</p> <h4 id="获得-config-对象"><a href="#获得-config-对象" class="header-anchor">#</a> 获得 Config 对象</h4> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Config</span> <span class="token function">getAppConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">getConfig</span><span class="token punctuation">(</span><span class="token class-name">ConfigConsts</span><span class="token punctuation">.</span><span class="token constant">NAMESPACE_APPLICATION</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Config</span> <span class="token function">getConfig</span><span class="token punctuation">(</span><span class="token class-name">String</span> namespace<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> s_instance<span class="token punctuation">.</span><span class="token function">getManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getConfig</span><span class="token punctuation">(</span>namespace<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>调用 <code>ConfigManager#getConfig(namespace)</code> 方法，获得 Namespace 对应的 Config 对象。在这里，我们可以看出，ConfigManager 是 Config 的管理器。</p> <h4 id="获得-configfile-对象"><a href="#获得-configfile-对象" class="header-anchor">#</a> 获得 ConfigFile 对象</h4> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">ConfigFile</span> <span class="token function">getConfigFile</span><span class="token punctuation">(</span><span class="token class-name">String</span> namespace<span class="token punctuation">,</span> <span class="token class-name">ConfigFileFormat</span> configFileFormat<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> s_instance<span class="token punctuation">.</span><span class="token function">getManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getConfigFile</span><span class="token punctuation">(</span>namespace<span class="token punctuation">,</span> configFileFormat<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>调用<code>ConfigManager#getConfigFile(namespace, ConfigFileFormat)</code> 方法，获得 Namespace 对应的 ConfigFile 对象。在这里，我们可以看出，ConfigManager 也是 ConfigFile 的管理器。</p> <p>比 <code>#getConfig(namespace)</code> 方法，多了一个类型为 ConfigFileFormat 的方法参数，实际是一致的。因为 ConfigManager 会在方法中，将 ConfigFileFormat 拼接到 namespace 中。代码如下：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">ConfigFile</span> <span class="token function">getConfigFile</span><span class="token punctuation">(</span><span class="token class-name">String</span> namespace<span class="token punctuation">,</span> <span class="token class-name">ConfigFileFormat</span> configFileFormat<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">String</span> namespaceFileName <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;%s.%s&quot;</span><span class="token punctuation">,</span> namespace<span class="token punctuation">,</span> configFileFormat<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="设置-config-对象"><a href="#设置-config-对象" class="header-anchor">#</a> 设置 Config 对象</h3> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">setConfig</span><span class="token punctuation">(</span><span class="token class-name">Config</span> config<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">setConfig</span><span class="token punctuation">(</span><span class="token class-name">ConfigConsts</span><span class="token punctuation">.</span><span class="token constant">NAMESPACE_APPLICATION</span><span class="token punctuation">,</span> config<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">setConfig</span><span class="token punctuation">(</span><span class="token class-name">String</span> namespace<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">Config</span> config<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    s_instance<span class="token punctuation">.</span><span class="token function">getRegistry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span>namespace<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ConfigFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token class-name">Config</span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token class-name">String</span> namespace<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> config<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token class-name">ConfigFile</span> <span class="token function">createConfigFile</span><span class="token punctuation">(</span><span class="token class-name">String</span> namespace<span class="token punctuation">,</span> <span class="token class-name">ConfigFileFormat</span> configFileFormat<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>在 Apollo 的设计中，ConfigManager 不允许设置 Namespace 对应的 Config 对象，而是通过 ConfigFactory 统一创建，虽然此时的创建是假的，直接返回了 <code>config</code> 方法参数。</p> <h3 id="设置-configfactory-对象"><a href="#设置-configfactory-对象" class="header-anchor">#</a> 设置 ConfigFactory 对象</h3> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">setConfigFactory</span><span class="token punctuation">(</span><span class="token class-name">ConfigFactory</span> factory<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">setConfigFactory</span><span class="token punctuation">(</span><span class="token class-name">ConfigConsts</span><span class="token punctuation">.</span><span class="token constant">NAMESPACE_APPLICATION</span><span class="token punctuation">,</span> factory<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">setConfigFactory</span><span class="token punctuation">(</span><span class="token class-name">String</span> namespace<span class="token punctuation">,</span> <span class="token class-name">ConfigFactory</span> factory<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    s_instance<span class="token punctuation">.</span><span class="token function">getRegistry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span>namespace<span class="token punctuation">,</span> factory<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>和设置 Config 对象类似，也是注册到 ConfigRegistry 中。</p> <h2 id="config-config-file"><a href="#config-config-file" class="header-anchor">#</a> Config &amp; Config File</h2> <h3 id="config"><a href="#config" class="header-anchor">#</a> Config</h3> <p><code>com.ctrip.framework.apollo.Config</code> ，Config 接口。子类如下图：</p> <p><img src="/note/assets/img/b6078901dc59d8a550b816595d720bb3.b6078901.png" alt=""></p> <h4 id="获取属性"><a href="#获取属性" class="header-anchor">#</a> 获取属性</h4> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">String</span> <span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token class-name">String</span> defaultValue<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">Integer</span> <span class="token function">getIntProperty</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token class-name">Integer</span> defaultValue<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">Long</span> <span class="token function">getLongProperty</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token class-name">Long</span> defaultValue<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">Short</span> <span class="token function">getShortProperty</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token class-name">Short</span> defaultValue<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">Float</span> <span class="token function">getFloatProperty</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token class-name">Float</span> defaultValue<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">Double</span> <span class="token function">getDoubleProperty</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token class-name">Double</span> defaultValue<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">Byte</span> <span class="token function">getByteProperty</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token class-name">Byte</span> defaultValue<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">Boolean</span> <span class="token function">getBooleanProperty</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token class-name">Boolean</span> defaultValue<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">getArrayProperty</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token class-name">String</span> delimiter<span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> defaultValue<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">Date</span> <span class="token function">getDateProperty</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token class-name">Date</span> defaultValue<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">Date</span> <span class="token function">getDateProperty</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token class-name">String</span> format<span class="token punctuation">,</span> <span class="token class-name">Date</span> defaultValue<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">Date</span> <span class="token function">getDateProperty</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token class-name">String</span> format<span class="token punctuation">,</span> <span class="token class-name">Locale</span> locale<span class="token punctuation">,</span> <span class="token class-name">Date</span> defaultValue<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span> <span class="token keyword">extends</span> <span class="token class-name">Enum</span><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">T</span> <span class="token function">getEnumProperty</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> enumType<span class="token punctuation">,</span> <span class="token class-name">T</span> defaultValue<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * Return the duration property value(in milliseconds) with the given name, or {@code
 * defaultValue} if the name doesn't exist. Please note the format should comply with the follow
 * example (case insensitive). Examples:
 * &lt;pre&gt;
 *    &quot;123MS&quot;          -- parses as &quot;123 milliseconds&quot;
 *    &quot;20S&quot;            -- parses as &quot;20 seconds&quot;
 *    &quot;15M&quot;            -- parses as &quot;15 minutes&quot; (where a minute is 60 seconds)
 *    &quot;10H&quot;            -- parses as &quot;10 hours&quot; (where an hour is 3600 seconds)
 *    &quot;2D&quot;             -- parses as &quot;2 days&quot; (where a day is 24 hours or 86400 seconds)
 *    &quot;2D3H4M5S123MS&quot;  -- parses as &quot;2 days, 3 hours, 4 minutes, 5 seconds and 123 milliseconds&quot;
 * &lt;/pre&gt;
 *
 * @param key          the property name
 * @param defaultValue the default value when name is not found or any error occurred
 * @return the parsed property value(in milliseconds)
 */</span>
<span class="token keyword">long</span> <span class="token function">getDurationProperty</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token keyword">long</span> defaultValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="获得属性名集合"><a href="#获得属性名集合" class="header-anchor">#</a> 获得属性名集合</h4> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">getPropertyNames</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="添加配置变化监听器"><a href="#添加配置变化监听器" class="header-anchor">#</a> 添加配置变化监听器</h4> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">void</span> <span class="token function">addChangeListener</span><span class="token punctuation">(</span><span class="token class-name">ConfigChangeListener</span> listener<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><code>com.ctrip.framework.apollo.ConfigChangeListener</code> 接口，代码如下：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">ConfigChangeListener</span> <span class="token punctuation">{</span>

    <span class="token comment">/**
     * Invoked when there is any config change for the namespace.
     *
     * @param changeEvent the event for this change
     */</span>
    <span class="token keyword">void</span> <span class="token function">onChange</span><span class="token punctuation">(</span><span class="token class-name">ConfigChangeEvent</span> changeEvent<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre></div><p><code>com.ctrip.framework.apollo.model.ConfigChangeEvent</code> ，Config 变化事件，代码如下：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConfigChangeEvent</span> <span class="token punctuation">{</span>
    
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span> m_namespace<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">ConfigChange</span><span class="token punctuation">&gt;</span></span> m_changes<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>com.ctrip.framework.apollo.model.ConfigChange</code> ，配置每个属性变化的信息。代码如下：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConfigChange</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span> namespace<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span> propertyName<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> oldValue<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> newValue<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">PropertyChangeType</span> changeType<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>com.ctrip.framework.apollo.enums.PropertyChangeType</code> ，属性变化类型枚举。代码如下：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">enum</span> <span class="token class-name">PropertyChangeType</span> <span class="token punctuation">{</span>
    <span class="token constant">ADDED</span><span class="token punctuation">,</span>
    <span class="token constant">MODIFIED</span><span class="token punctuation">,</span>
    <span class="token constant">DELETED</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="configfile"><a href="#configfile" class="header-anchor">#</a> ConfigFile</h3> <p><code>com.ctrip.framework.apollo.ConfigFile</code> ，ConfigFile 接口。子类如下图：</p> <p><img src="/note/assets/img/12c7d0c6bd59cf6978010476a0c57236.12c7d0c6.png" alt=""></p> <h4 id="获得内容"><a href="#获得内容" class="header-anchor">#</a> 获得内容</h4> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">String</span> <span class="token function">getContent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">boolean</span> <span class="token function">hasContent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="获得-namespace-名字"><a href="#获得-namespace-名字" class="header-anchor">#</a> 获得 Namespace 名字</h4> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">String</span> <span class="token function">getNamespace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">ConfigFileFormat</span> <span class="token function">getConfigFileFormat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="添加配置文件变化监听器"><a href="#添加配置文件变化监听器" class="header-anchor">#</a> 添加配置文件变化监听器</h4> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">void</span> <span class="token function">addChangeListener</span><span class="token punctuation">(</span><span class="token class-name">ConfigFileChangeListener</span> listener<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><code>com.ctrip.framework.apollo.ConfigFileChangeListener</code> 接口，代码如下：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">ConfigFileChangeListener</span> <span class="token punctuation">{</span>
    
    <span class="token comment">/**
     * Invoked when there is any config change for the namespace.
     *
     * @param changeEvent the event for this change
     */</span>
    <span class="token keyword">void</span> <span class="token function">onChange</span><span class="token punctuation">(</span><span class="token class-name">ConfigFileChangeEvent</span> changeEvent<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre></div><p><code>com.ctrip.framework.apollo.model.ConfigFileChangeEvent</code> ，配置文件改变事件。代码如下：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConfigFileChangeEvent</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span> namespace<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span> oldValue<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> newValue<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">PropertyChangeType</span> changeType<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="configmanager"><a href="#configmanager" class="header-anchor">#</a> ConfigManager</h2> <p><code>com.ctrip.framework.apollo.internals.ConfigManager</code> ，配置_管理器_接口。提供获得 Config 和 ConfigFile 对象的接口，代码如下：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">ConfigManager</span> <span class="token punctuation">{</span>

    <span class="token comment">/**
     * Get the config instance for the namespace specified.
     *
     * @param namespace the namespace
     * @return the config instance for the namespace
     */</span>
    <span class="token class-name">Config</span> <span class="token function">getConfig</span><span class="token punctuation">(</span><span class="token class-name">String</span> namespace<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * Get the config file instance for the namespace specified.
     *
     * @param namespace        the namespace
     * @param configFileFormat the config file format
     * @return the config file instance for the namespace
     */</span>
    <span class="token class-name">ConfigFile</span> <span class="token function">getConfigFile</span><span class="token punctuation">(</span><span class="token class-name">String</span> namespace<span class="token punctuation">,</span> <span class="token class-name">ConfigFileFormat</span> configFileFormat<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="defaultconfigmanager"><a href="#defaultconfigmanager" class="header-anchor">#</a> DefaultConfigManager</h3> <p><code>com.ctrip.framework.apollo.internals.DefaultConfigManager</code> ，实现 ConfigManager 接口，默认配置管理器实现类。</p> <h4 id="构造方法-2"><a href="#构造方法-2" class="header-anchor">#</a> 构造方法</h4> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token class-name">ConfigFactoryManager</span> m_factoryManager<span class="token punctuation">;</span>

<span class="token keyword">private</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Config</span><span class="token punctuation">&gt;</span></span> m_configs <span class="token operator">=</span> <span class="token class-name">Maps</span><span class="token punctuation">.</span><span class="token function">newConcurrentMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">private</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">ConfigFile</span><span class="token punctuation">&gt;</span></span> m_configFiles <span class="token operator">=</span> <span class="token class-name">Maps</span><span class="token punctuation">.</span><span class="token function">newConcurrentMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token class-name">DefaultConfigManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    m_factoryManager <span class="token operator">=</span> <span class="token class-name">ApolloInjector</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token class-name">ConfigFactoryManager</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>当需要获得的 Config 或 ConfigFile 对象不在缓存中时，通过 ConfigFactoryManager ，获得对应的 ConfigFactory 对象，从而创建 Config 或 ConfigFile 对象。</p> <h4 id="获得-config-对象-2"><a href="#获得-config-对象-2" class="header-anchor">#</a> 获得 Config 对象</h4> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">Config</span> <span class="token function">getConfig</span><span class="token punctuation">(</span><span class="token class-name">String</span> namespace<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Config</span> config <span class="token operator">=</span> m_configs<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>namespace<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>config <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            config <span class="token operator">=</span> m_configs<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>namespace<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>config <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">ConfigFactory</span> factory <span class="token operator">=</span> m_factoryManager<span class="token punctuation">.</span><span class="token function">getFactory</span><span class="token punctuation">(</span>namespace<span class="token punctuation">)</span><span class="token punctuation">;</span>
                config <span class="token operator">=</span> factory<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>namespace<span class="token punctuation">)</span><span class="token punctuation">;</span>
                m_configs<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>namespace<span class="token punctuation">,</span> config<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> config<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="获得-configfile-对象-2"><a href="#获得-configfile-对象-2" class="header-anchor">#</a> 获得 ConfigFile 对象</h4> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">ConfigFile</span> <span class="token function">getConfigFile</span><span class="token punctuation">(</span><span class="token class-name">String</span> namespace<span class="token punctuation">,</span> <span class="token class-name">ConfigFileFormat</span> configFileFormat<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">String</span> namespaceFileName <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;%s.%s&quot;</span><span class="token punctuation">,</span> namespace<span class="token punctuation">,</span> configFileFormat<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">ConfigFile</span> configFile <span class="token operator">=</span> m_configFiles<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>namespaceFileName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>configFile <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            configFile <span class="token operator">=</span> m_configFiles<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>namespaceFileName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>configFile <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">ConfigFactory</span> factory <span class="token operator">=</span> m_factoryManager<span class="token punctuation">.</span><span class="token function">getFactory</span><span class="token punctuation">(</span>namespaceFileName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                configFile <span class="token operator">=</span> factory<span class="token punctuation">.</span><span class="token function">createConfigFile</span><span class="token punctuation">(</span>namespaceFileName<span class="token punctuation">,</span> configFileFormat<span class="token punctuation">)</span><span class="token punctuation">;</span>
                m_configFiles<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>namespaceFileName<span class="token punctuation">,</span> configFile<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> configFile<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="configfactorymanager"><a href="#configfactorymanager" class="header-anchor">#</a> ConfigFactoryManager</h2> <p><code>com.ctrip.framework.apollo.spi.ConfigFactoryManager</code> ，ConfigFactory 管理器接口。代码如下：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">ConfigFactoryManager</span> <span class="token punctuation">{</span>

    <span class="token comment">/**
     * Get the config factory for the namespace.
     *
     * @param namespace the namespace
     * @return the config factory for this namespace
     */</span>
    <span class="token class-name">ConfigFactory</span> <span class="token function">getFactory</span><span class="token punctuation">(</span><span class="token class-name">String</span> namespace<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre></div><p>ConfigFactoryManager 管理的是 ConfigFactory ，而 ConfigManager 管理的是 Config 。</p> <h3 id="defaultconfigfactorymanager"><a href="#defaultconfigfactorymanager" class="header-anchor">#</a> DefaultConfigFactoryManager</h3> <p><code>com.ctrip.framework.apollo.spi.DefaultConfigFactoryManager</code> ，ConfigFactoryManager 接口，默认 ConfigFactory 管理器实现类。代码如下：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DefaultConfigFactoryManager</span> <span class="token keyword">implements</span> <span class="token class-name">ConfigFactoryManager</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token class-name">ConfigRegistry</span> m_registry<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">ConfigFactory</span><span class="token punctuation">&gt;</span></span> m_factories <span class="token operator">=</span> <span class="token class-name">Maps</span><span class="token punctuation">.</span><span class="token function">newConcurrentMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">DefaultConfigFactoryManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        m_registry <span class="token operator">=</span> <span class="token class-name">ApolloInjector</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token class-name">ConfigRegistry</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">ConfigFactory</span> <span class="token function">getFactory</span><span class="token punctuation">(</span><span class="token class-name">String</span> namespace<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">ConfigFactory</span> factory <span class="token operator">=</span> m_registry<span class="token punctuation">.</span><span class="token function">getFactory</span><span class="token punctuation">(</span>namespace<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>factory <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> factory<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        factory <span class="token operator">=</span> m_factories<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>namespace<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>factory <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> factory<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        factory <span class="token operator">=</span> <span class="token class-name">ApolloInjector</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token class-name">ConfigFactory</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> namespace<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>factory <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> factory<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        factory <span class="token operator">=</span> <span class="token class-name">ApolloInjector</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token class-name">ConfigFactory</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        m_factories<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>namespace<span class="token punctuation">,</span> factory<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> factory<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><p>总的来说，DefaultConfigFactoryManager 的 ConfigFactory 来源有两个：</p> <ul><li>ConfigRegistry</li> <li>ApolloInjector ，优先指定 Namespace 自定义的 ConfigFactory 对象，否则默认的 ConfigFactory 对象。</li></ul> <h2 id="configfactory"><a href="#configfactory" class="header-anchor">#</a> ConfigFactory</h2> <p><code>com.ctrip.framework.apollo.spi.ConfigFactory</code> ，配置工厂接口，其每个接口方法和 ConfigManager 一一对应。代码如下：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">ConfigFactory</span> <span class="token punctuation">{</span>

    <span class="token comment">/**
     * Create the config instance for the namespace.
     *
     * @param namespace the namespace
     * @return the newly created config instance
     */</span>
    <span class="token class-name">Config</span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token class-name">String</span> namespace<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * Create the config file instance for the namespace
     *
     * @param namespace the namespace
     * @return the newly created config file instance
     */</span>
    <span class="token class-name">ConfigFile</span> <span class="token function">createConfigFile</span><span class="token punctuation">(</span><span class="token class-name">String</span> namespace<span class="token punctuation">,</span> <span class="token class-name">ConfigFileFormat</span> configFileFormat<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre></div><h3 id="defaultconfigfactory"><a href="#defaultconfigfactory" class="header-anchor">#</a> DefaultConfigFactory</h3> <p><code>com.ctrip.framework.apollo.spi.DefaultConfigFactory</code> ，实现 ConfigFactory 接口，默认配置工厂实现类。</p> <h4 id="构造方法-3"><a href="#构造方法-3" class="header-anchor">#</a> 构造方法</h4> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Logger</span> logger <span class="token operator">=</span> <span class="token class-name">LoggerFactory</span><span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token class-name">DefaultConfigFactory</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">private</span> <span class="token class-name">ConfigUtil</span> m_configUtil<span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token class-name">DefaultConfigFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    m_configUtil <span class="token operator">=</span> <span class="token class-name">ApolloInjector</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token class-name">ConfigUtil</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="创建-config-对象"><a href="#创建-config-对象" class="header-anchor">#</a> 创建 Config 对象</h4> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">Config</span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token class-name">String</span> namespace<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">DefaultConfig</span><span class="token punctuation">(</span>namespace<span class="token punctuation">,</span> <span class="token function">createLocalConfigRepository</span><span class="token punctuation">(</span>namespace<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>调用 <code>#createLocalConfigRepository(name)</code> 方法，创建 LocalConfigRepository 对象。作为后面创建的 DefaultConfig 对象的 ConfigRepository 。</p> <h4 id="创建-fileconfig-对象"><a href="#创建-fileconfig-对象" class="header-anchor">#</a> 创建 FileConfig 对象</h4> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">ConfigFile</span> <span class="token function">createConfigFile</span><span class="token punctuation">(</span><span class="token class-name">String</span> namespace<span class="token punctuation">,</span> <span class="token class-name">ConfigFileFormat</span> configFileFormat<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">ConfigRepository</span> configRepository <span class="token operator">=</span> <span class="token function">createLocalConfigRepository</span><span class="token punctuation">(</span>namespace<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>configFileFormat<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">case</span> <span class="token class-name">Properties</span><span class="token operator">:</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">PropertiesConfigFile</span><span class="token punctuation">(</span>namespace<span class="token punctuation">,</span> configRepository<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token constant">XML</span><span class="token operator">:</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">XmlConfigFile</span><span class="token punctuation">(</span>namespace<span class="token punctuation">,</span> configRepository<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token constant">JSON</span><span class="token operator">:</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">JsonConfigFile</span><span class="token punctuation">(</span>namespace<span class="token punctuation">,</span> configRepository<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token constant">YAML</span><span class="token operator">:</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">YamlConfigFile</span><span class="token punctuation">(</span>namespace<span class="token punctuation">,</span> configRepository<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token constant">YML</span><span class="token operator">:</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">YmlConfigFile</span><span class="token punctuation">(</span>namespace<span class="token punctuation">,</span> configRepository<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>调用 <code>#createLocalConfigRepository(name)</code> 方法，创建 LocalConfigRepository 对象。作为后面创建的 XXXConfigFile 对象的 ConfigRepository 。</p> <h4 id="创建-localconfigrepository-对象"><a href="#创建-localconfigrepository-对象" class="header-anchor">#</a> 创建 LocalConfigRepository 对象</h4> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">LocalFileConfigRepository</span> <span class="token function">createLocalConfigRepository</span><span class="token punctuation">(</span><span class="token class-name">String</span> namespace<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>m_configUtil<span class="token punctuation">.</span><span class="token function">isInLocalMode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        logger<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;==== Apollo is in local mode! Won't pull configs from remote server for namespace {} ! ====&quot;</span><span class="token punctuation">,</span> namespace<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">LocalFileConfigRepository</span><span class="token punctuation">(</span>namespace<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">LocalFileConfigRepository</span><span class="token punctuation">(</span>namespace<span class="token punctuation">,</span> <span class="token function">createRemoteConfigRepository</span><span class="token punctuation">(</span>namespace<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token class-name">RemoteConfigRepository</span> <span class="token function">createRemoteConfigRepository</span><span class="token punctuation">(</span><span class="token class-name">String</span> namespace<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">RemoteConfigRepository</span><span class="token punctuation">(</span>namespace<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>根据是否为本地模式，单独使用 LocalFileConfigRepository 还是组合使用 LocalFileConfigRepository + RemoteConfigRepository 。</li> <li>那么什么是本地模式呢？ConfigUtil#isInLocalMode() 方法，代码如下：<div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isInLocalMode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token class-name">Env</span> env <span class="token operator">=</span> <span class="token function">getApolloEnv</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> env <span class="token operator">==</span> <span class="token class-name">Env</span><span class="token punctuation">.</span><span class="token constant">LOCAL</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//ignore</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div></li></ul> <h2 id="configregistry"><a href="#configregistry" class="header-anchor">#</a> ConfigRegistry</h2> <p><code>com.ctrip.framework.apollo.spi.ConfigRegistry</code> ，Config 注册表接口。其中，KEY 为 Namespace 的名字，VALUE 为 ConfigFactory 对象。代码如下：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">ConfigRegistry</span> <span class="token punctuation">{</span>

    <span class="token comment">/**
     * Register the config factory for the namespace specified.
     *
     * @param namespace the namespace
     * @param factory   the factory for this namespace
     */</span>
    <span class="token keyword">void</span> <span class="token function">register</span><span class="token punctuation">(</span><span class="token class-name">String</span> namespace<span class="token punctuation">,</span> <span class="token class-name">ConfigFactory</span> factory<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * Get the registered config factory for the namespace.
     *
     * @param namespace the namespace
     * @return the factory registered for this namespace
     */</span>
    <span class="token class-name">ConfigFactory</span> <span class="token function">getFactory</span><span class="token punctuation">(</span><span class="token class-name">String</span> namespace<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre></div><h3 id="defaultconfigregistry"><a href="#defaultconfigregistry" class="header-anchor">#</a> DefaultConfigRegistry</h3> <p><code>com.ctrip.framework.apollo.spi.DefaultConfigRegistry</code> ，实现 ConfigRegistry 接口，默认 ConfigFactory 管理器实现类。代码如下：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DefaultConfigRegistry</span> <span class="token keyword">implements</span> <span class="token class-name">ConfigRegistry</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Logger</span> s_logger <span class="token operator">=</span> <span class="token class-name">LoggerFactory</span><span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token class-name">DefaultConfigRegistry</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * ConfigFactory Map
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">ConfigFactory</span><span class="token punctuation">&gt;</span></span> m_instances <span class="token operator">=</span> <span class="token class-name">Maps</span><span class="token punctuation">.</span><span class="token function">newConcurrentMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">register</span><span class="token punctuation">(</span><span class="token class-name">String</span> namespace<span class="token punctuation">,</span> <span class="token class-name">ConfigFactory</span> factory<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>m_instances<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>namespace<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
            s_logger<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;ConfigFactory({}) is overridden by {}!&quot;</span><span class="token punctuation">,</span> namespace<span class="token punctuation">,</span> factory<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        m_instances<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>namespace<span class="token punctuation">,</span> factory<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">ConfigFactory</span> <span class="token function">getFactory</span><span class="token punctuation">(</span><span class="token class-name">String</span> namespace<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> m_instances<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>namespace<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><h2 id="apolloinjector"><a href="#apolloinjector" class="header-anchor">#</a> ApolloInjector</h2> <p><code>com.ctrip.framework.apollo.build.ApolloInjector</code> ，Apollo 注入器，实现依赖注入。</p> <h3 id="构造方法-4"><a href="#构造方法-4" class="header-anchor">#</a> 构造方法</h3> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">volatile</span> <span class="token class-name">Injector</span> s_injector<span class="token punctuation">;</span>

<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Object</span> lock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><code>s_injector</code> 静态属性，真正的注入器对象。通过 #getInjector() 静态方法获得。代码如下：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Injector</span> <span class="token function">getInjector</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>s_injector <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>lock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>s_injector <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    s_injector <span class="token operator">=</span> <span class="token class-name">ServiceBootstrap</span><span class="token punctuation">.</span><span class="token function">loadFirst</span><span class="token punctuation">(</span><span class="token class-name">Injector</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token class-name">ApolloConfigException</span> exception <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ApolloConfigException</span><span class="token punctuation">(</span><span class="token string">&quot;Unable to initialize Apollo Injector!&quot;</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">Tracer</span><span class="token punctuation">.</span><span class="token function">logError</span><span class="token punctuation">(</span>exception<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">throw</span> exception<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> s_injector<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>调用 <code>com.ctrip.framework.foundation.internals.ServiceBootstrap#loadFirst(Class&lt;S&gt;)</code> 方法，基于 JDK SPI 机制，加载指定服务的首个对象。代码如下：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ServiceBootstrap</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">S</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">S</span> <span class="token function">loadFirst</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">S</span><span class="token punctuation">&gt;</span></span> clazz<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Iterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">S</span><span class="token punctuation">&gt;</span></span> iterator <span class="token operator">=</span> <span class="token function">loadAll</span><span class="token punctuation">(</span>clazz<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>iterator<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;No implementation defined in /META-INF/services/%s, please check whether the file exists and has the right implementation class!&quot;</span><span class="token punctuation">,</span> clazz<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">S</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">Iterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">S</span><span class="token punctuation">&gt;</span></span> <span class="token function">loadAll</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">S</span><span class="token punctuation">&gt;</span></span> clazz<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">ServiceLoader</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">S</span><span class="token punctuation">&gt;</span></span> loader <span class="token operator">=</span> <span class="token class-name">ServiceLoader</span><span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>clazz<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// JDK SPI</span>
        <span class="token keyword">return</span> loader<span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><p>在 <code>META-INF/services/com.ctrip.framework.apollo.internals.Injector</code> 中，配置 Injector 的实现类为 DefaultInjector ，如下：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>ctrip<span class="token punctuation">.</span>framework<span class="token punctuation">.</span>apollo<span class="token punctuation">.</span>internals<span class="token punctuation">.</span></span>DefaultInjector</span>
</code></pre></div><h3 id="获得实例"><a href="#获得实例" class="header-anchor">#</a> 获得实例</h3> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">T</span> <span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> clazz<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">getInjector</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span>clazz<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Tracer</span><span class="token punctuation">.</span><span class="token function">logError</span><span class="token punctuation">(</span>ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ApolloConfigException</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;Unable to load instance for type %s!&quot;</span><span class="token punctuation">,</span> clazz<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">T</span> <span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> clazz<span class="token punctuation">,</span> <span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">getInjector</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span>clazz<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Tracer</span><span class="token punctuation">.</span><span class="token function">logError</span><span class="token punctuation">(</span>ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ApolloConfigException</span><span class="token punctuation">(</span>
                <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;Unable to load instance for type %s and name %s !&quot;</span><span class="token punctuation">,</span> clazz<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="injector"><a href="#injector" class="header-anchor">#</a> Injector</h2> <p><code>com.ctrip.framework.apollo.internals.Injector</code> ，注入器接口。代码如下：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Injector</span> <span class="token punctuation">{</span>

    <span class="token comment">/**
     * Returns the appropriate instance for the given injection type
     */</span>
    <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">T</span> <span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> clazz<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * Returns the appropriate instance for the given injection type and name
     */</span>
    <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">T</span> <span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> clazz<span class="token punctuation">,</span> <span class="token class-name">String</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre></div><h3 id="defaultinjector"><a href="#defaultinjector" class="header-anchor">#</a> DefaultInjector</h3> <p><code>com.ctrip.framework.apollo.internals.DefaultInjector</code> ，实现 Injector 接口，基于 Guice 的注入器实现类。</p> <p>考虑到 Apollo 会被引入项目中，尽量减少对 Spring 的依赖。但是呢，自身又有 DI 特性的需要，那么引入 Google Guice 是非常好的选择。</p> <h4 id="构造方法-5"><a href="#构造方法-5" class="header-anchor">#</a> 构造方法</h4> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>google<span class="token punctuation">.</span>inject<span class="token punctuation">.</span></span>Injector</span> m_injector<span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token class-name">DefaultInjector</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        m_injector <span class="token operator">=</span> <span class="token class-name">Guice</span><span class="token punctuation">.</span><span class="token function">createInjector</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ApolloModule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">ApolloConfigException</span> exception <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ApolloConfigException</span><span class="token punctuation">(</span><span class="token string">&quot;Unable to initialize Guice Injector!&quot;</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Tracer</span><span class="token punctuation">.</span><span class="token function">logError</span><span class="token punctuation">(</span>exception<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">throw</span> exception<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>使用 ApolloModule 类，告诉 Guice 需要 DI 的配置。代码如下：</p> <div class="language-java extra-class"><pre class="language-java"><code>rivate <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">ApolloModule</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractModule</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">bind</span><span class="token punctuation">(</span><span class="token class-name">ConfigManager</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">to</span><span class="token punctuation">(</span><span class="token class-name">DefaultConfigManager</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">in</span><span class="token punctuation">(</span><span class="token class-name">Singleton</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">bind</span><span class="token punctuation">(</span><span class="token class-name">ConfigFactoryManager</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">to</span><span class="token punctuation">(</span><span class="token class-name">DefaultConfigFactoryManager</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">in</span><span class="token punctuation">(</span><span class="token class-name">Singleton</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">bind</span><span class="token punctuation">(</span><span class="token class-name">ConfigRegistry</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">to</span><span class="token punctuation">(</span><span class="token class-name">DefaultConfigRegistry</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">in</span><span class="token punctuation">(</span><span class="token class-name">Singleton</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">bind</span><span class="token punctuation">(</span><span class="token class-name">ConfigFactory</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">to</span><span class="token punctuation">(</span><span class="token class-name">DefaultConfigFactory</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">in</span><span class="token punctuation">(</span><span class="token class-name">Singleton</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">bind</span><span class="token punctuation">(</span><span class="token class-name">ConfigUtil</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">in</span><span class="token punctuation">(</span><span class="token class-name">Singleton</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">bind</span><span class="token punctuation">(</span><span class="token class-name">HttpUtil</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">in</span><span class="token punctuation">(</span><span class="token class-name">Singleton</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">bind</span><span class="token punctuation">(</span><span class="token class-name">ConfigServiceLocator</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">in</span><span class="token punctuation">(</span><span class="token class-name">Singleton</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">bind</span><span class="token punctuation">(</span><span class="token class-name">RemoteConfigLongPollService</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">in</span><span class="token punctuation">(</span><span class="token class-name">Singleton</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><h4 id="获得实例-2"><a href="#获得实例-2" class="header-anchor">#</a> 获得实例</h4> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">T</span> <span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> clazz<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> m_injector<span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span>clazz<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Tracer</span><span class="token punctuation">.</span><span class="token function">logError</span><span class="token punctuation">(</span>ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ApolloConfigException</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;Unable to load instance for %s!&quot;</span><span class="token punctuation">,</span> clazz<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">T</span> <span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> clazz<span class="token punctuation">,</span> <span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Guice does not support get instance by type and name</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/note/framework/apollo/portal-publish-namespace-branch.html" class="prev">
        Apollo 源码解析 —— Portal 灰度发布
      </a></span> <span class="next"><a href="/note/framework/apollo/client-config-api-2.html">
        Apollo 源码解析 —— 客户端 API 配置（二）之 Config
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/note/assets/js/app.e7654e9f.js" defer></script><script src="/note/assets/js/2.e810aa3c.js" defer></script><script src="/note/assets/js/1.07fc4d8c.js" defer></script><script src="/note/assets/js/37.8d31cfbf.js" defer></script>
  </body>
</html>
