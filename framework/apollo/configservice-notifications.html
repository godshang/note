<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Apollo源码分析——ConfigService通知配置变更 | 开发者笔记</title>
    <meta name="generator" content="VuePress 1.9.10">
    
    <meta name="description" content="">
    
    <link rel="preload" href="/note/assets/css/0.styles.fa566ad0.css" as="style"><link rel="preload" href="/note/assets/js/app.e7654e9f.js" as="script"><link rel="preload" href="/note/assets/js/2.e810aa3c.js" as="script"><link rel="preload" href="/note/assets/js/1.07fc4d8c.js" as="script"><link rel="preload" href="/note/assets/js/74.026d5759.js" as="script"><link rel="prefetch" href="/note/assets/js/10.555b32ff.js"><link rel="prefetch" href="/note/assets/js/100.d020d8ee.js"><link rel="prefetch" href="/note/assets/js/101.7683a3d7.js"><link rel="prefetch" href="/note/assets/js/102.88714d09.js"><link rel="prefetch" href="/note/assets/js/103.233ddbe4.js"><link rel="prefetch" href="/note/assets/js/104.e433d6c3.js"><link rel="prefetch" href="/note/assets/js/105.fe2e4966.js"><link rel="prefetch" href="/note/assets/js/106.d239b033.js"><link rel="prefetch" href="/note/assets/js/107.3026af59.js"><link rel="prefetch" href="/note/assets/js/108.36315191.js"><link rel="prefetch" href="/note/assets/js/109.81c1c194.js"><link rel="prefetch" href="/note/assets/js/11.028a3c1c.js"><link rel="prefetch" href="/note/assets/js/110.f821be7e.js"><link rel="prefetch" href="/note/assets/js/111.e072da72.js"><link rel="prefetch" href="/note/assets/js/112.c96d9beb.js"><link rel="prefetch" href="/note/assets/js/113.f62b712c.js"><link rel="prefetch" href="/note/assets/js/114.28d5802e.js"><link rel="prefetch" href="/note/assets/js/115.59b34590.js"><link rel="prefetch" href="/note/assets/js/116.e7563be8.js"><link rel="prefetch" href="/note/assets/js/117.2b203c5c.js"><link rel="prefetch" href="/note/assets/js/118.26adca05.js"><link rel="prefetch" href="/note/assets/js/119.54c5dd1e.js"><link rel="prefetch" href="/note/assets/js/12.1b649a19.js"><link rel="prefetch" href="/note/assets/js/120.b3a105c7.js"><link rel="prefetch" href="/note/assets/js/13.c8f31ead.js"><link rel="prefetch" href="/note/assets/js/14.f9046e47.js"><link rel="prefetch" href="/note/assets/js/15.3af5a383.js"><link rel="prefetch" href="/note/assets/js/16.9a3efa49.js"><link rel="prefetch" href="/note/assets/js/17.ef3ca875.js"><link rel="prefetch" href="/note/assets/js/18.831fa1a4.js"><link rel="prefetch" href="/note/assets/js/19.cfea4209.js"><link rel="prefetch" href="/note/assets/js/20.9c5bbcd6.js"><link rel="prefetch" href="/note/assets/js/21.3ad15aa3.js"><link rel="prefetch" href="/note/assets/js/22.45739dd6.js"><link rel="prefetch" href="/note/assets/js/23.0b3b321e.js"><link rel="prefetch" href="/note/assets/js/24.69ce0e0c.js"><link rel="prefetch" href="/note/assets/js/25.0730c414.js"><link rel="prefetch" href="/note/assets/js/26.2834d6fd.js"><link rel="prefetch" href="/note/assets/js/27.b67f9ce5.js"><link rel="prefetch" href="/note/assets/js/28.1b0ec007.js"><link rel="prefetch" href="/note/assets/js/29.c69a505d.js"><link rel="prefetch" href="/note/assets/js/3.922513d5.js"><link rel="prefetch" href="/note/assets/js/30.59c9f0f6.js"><link rel="prefetch" href="/note/assets/js/31.99a0ee4b.js"><link rel="prefetch" href="/note/assets/js/32.34fb1316.js"><link rel="prefetch" href="/note/assets/js/33.4c466f0a.js"><link rel="prefetch" href="/note/assets/js/34.11542871.js"><link rel="prefetch" href="/note/assets/js/35.f46213e9.js"><link rel="prefetch" href="/note/assets/js/36.191cc770.js"><link rel="prefetch" href="/note/assets/js/37.8d31cfbf.js"><link rel="prefetch" href="/note/assets/js/38.10058a9f.js"><link rel="prefetch" href="/note/assets/js/39.95b7b6ef.js"><link rel="prefetch" href="/note/assets/js/4.a1966589.js"><link rel="prefetch" href="/note/assets/js/40.aacc67a1.js"><link rel="prefetch" href="/note/assets/js/41.69d1900a.js"><link rel="prefetch" href="/note/assets/js/42.a10bf330.js"><link rel="prefetch" href="/note/assets/js/43.cca6ff22.js"><link rel="prefetch" href="/note/assets/js/44.90b90816.js"><link rel="prefetch" href="/note/assets/js/45.113abd6a.js"><link rel="prefetch" href="/note/assets/js/46.c428ba25.js"><link rel="prefetch" href="/note/assets/js/47.3fddf95f.js"><link rel="prefetch" href="/note/assets/js/48.cc7000a1.js"><link rel="prefetch" href="/note/assets/js/49.b873071f.js"><link rel="prefetch" href="/note/assets/js/5.b21639f8.js"><link rel="prefetch" href="/note/assets/js/50.fb0418b2.js"><link rel="prefetch" href="/note/assets/js/51.3933f89b.js"><link rel="prefetch" href="/note/assets/js/52.5d4b2e9e.js"><link rel="prefetch" href="/note/assets/js/53.b771539b.js"><link rel="prefetch" href="/note/assets/js/54.a0da92be.js"><link rel="prefetch" href="/note/assets/js/55.e3c32e70.js"><link rel="prefetch" href="/note/assets/js/56.c273a07a.js"><link rel="prefetch" href="/note/assets/js/57.d0e02578.js"><link rel="prefetch" href="/note/assets/js/58.72664a5f.js"><link rel="prefetch" href="/note/assets/js/59.d425fbf8.js"><link rel="prefetch" href="/note/assets/js/6.0299a03f.js"><link rel="prefetch" href="/note/assets/js/60.961047ab.js"><link rel="prefetch" href="/note/assets/js/61.dd024c7d.js"><link rel="prefetch" href="/note/assets/js/62.aa0ba217.js"><link rel="prefetch" href="/note/assets/js/63.e2a55dcc.js"><link rel="prefetch" href="/note/assets/js/64.30bf7f34.js"><link rel="prefetch" href="/note/assets/js/65.39726ca4.js"><link rel="prefetch" href="/note/assets/js/66.1addd97a.js"><link rel="prefetch" href="/note/assets/js/67.cc99e8a2.js"><link rel="prefetch" href="/note/assets/js/68.e278ab91.js"><link rel="prefetch" href="/note/assets/js/69.a9c2296f.js"><link rel="prefetch" href="/note/assets/js/7.84671687.js"><link rel="prefetch" href="/note/assets/js/70.51cd3ef1.js"><link rel="prefetch" href="/note/assets/js/71.78a7e100.js"><link rel="prefetch" href="/note/assets/js/72.d5f54084.js"><link rel="prefetch" href="/note/assets/js/73.2b2e81d3.js"><link rel="prefetch" href="/note/assets/js/75.b315d618.js"><link rel="prefetch" href="/note/assets/js/76.e4402459.js"><link rel="prefetch" href="/note/assets/js/77.c492b51c.js"><link rel="prefetch" href="/note/assets/js/78.f13c15b5.js"><link rel="prefetch" href="/note/assets/js/79.6da0305c.js"><link rel="prefetch" href="/note/assets/js/80.10321fab.js"><link rel="prefetch" href="/note/assets/js/81.9daf45ce.js"><link rel="prefetch" href="/note/assets/js/82.17c606f7.js"><link rel="prefetch" href="/note/assets/js/83.68053253.js"><link rel="prefetch" href="/note/assets/js/84.cac1ee23.js"><link rel="prefetch" href="/note/assets/js/85.eb45d699.js"><link rel="prefetch" href="/note/assets/js/86.cdfbccd6.js"><link rel="prefetch" href="/note/assets/js/87.edc80e1b.js"><link rel="prefetch" href="/note/assets/js/88.d1cd3a58.js"><link rel="prefetch" href="/note/assets/js/89.ffd23af7.js"><link rel="prefetch" href="/note/assets/js/90.7ea29979.js"><link rel="prefetch" href="/note/assets/js/91.fa52ca7b.js"><link rel="prefetch" href="/note/assets/js/92.1aa72a1e.js"><link rel="prefetch" href="/note/assets/js/93.723b96db.js"><link rel="prefetch" href="/note/assets/js/94.e1a4317f.js"><link rel="prefetch" href="/note/assets/js/95.486c4f74.js"><link rel="prefetch" href="/note/assets/js/96.6f5bcf47.js"><link rel="prefetch" href="/note/assets/js/97.d196e0cc.js"><link rel="prefetch" href="/note/assets/js/98.3213f4f1.js"><link rel="prefetch" href="/note/assets/js/99.e73f1d6c.js"><link rel="prefetch" href="/note/assets/js/vendors~docsearch.200fb47e.js">
    <link rel="stylesheet" href="/note/assets/css/0.styles.fa566ad0.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/note/" class="home-link router-link-active"><!----> <span class="site-name">开发者笔记</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/note/" class="nav-link">
  Home
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Java" class="dropdown-title"><span class="title">Java</span> <span class="arrow down"></span></button> <button type="button" aria-label="Java" class="mobile-dropdown-title"><span class="title">Java</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/note/java/base/basic.html" class="nav-link">
  Java基础
</a></li><li class="dropdown-item"><!----> <a href="/note/java/collection/ArrayList.html" class="nav-link">
  Java集合框架
</a></li><li class="dropdown-item"><!----> <a href="/note/java/concurrent/Theory.html" class="nav-link">
  Java并发编程
</a></li><li class="dropdown-item"><!----> <a href="/note/java/jvm/memory.html" class="nav-link">
  JVM相关
</a></li><li class="dropdown-item"><!----> <a href="/note/java/nio/io.html" class="nav-link">
  Java NIO相关
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="数据存储" class="dropdown-title"><span class="title">数据存储</span> <span class="arrow down"></span></button> <button type="button" aria-label="数据存储" class="mobile-dropdown-title"><span class="title">数据存储</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/note/storage/database/mysql.html" class="nav-link">
  MySQL
</a></li><li class="dropdown-item"><!----> <a href="/note/storage/redis/redis-question.html" class="nav-link">
  Redis
</a></li><li class="dropdown-item"><!----> <a href="/note/storage/mq/kafka-intro.html" class="nav-link">
  消息队列
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="框架" class="dropdown-title"><span class="title">框架</span> <span class="arrow down"></span></button> <button type="button" aria-label="框架" class="mobile-dropdown-title"><span class="title">框架</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/note/framework/spring-framework/spring-framework-intro.html" class="nav-link">
  Spring框架
</a></li><li class="dropdown-item"><!----> <a href="/note/framework/netty/netty-business-logic.html" class="nav-link">
  Netty
</a></li><li class="dropdown-item"><!----> <a href="/note/framework/apollo/setup-debug-enviroment.html" class="nav-link">
  Apollo源码分析
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="架构" class="dropdown-title"><span class="title">架构</span> <span class="arrow down"></span></button> <button type="button" aria-label="架构" class="mobile-dropdown-title"><span class="title">架构</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/note/arch/system-design/01-scale-from-zero.html" class="nav-link">
  系统设计
</a></li><li class="dropdown-item"><!----> <a href="/note/arch/case-study/rate-limiter.html" class="nav-link">
  案例
</a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/note/" class="nav-link">
  Home
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Java" class="dropdown-title"><span class="title">Java</span> <span class="arrow down"></span></button> <button type="button" aria-label="Java" class="mobile-dropdown-title"><span class="title">Java</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/note/java/base/basic.html" class="nav-link">
  Java基础
</a></li><li class="dropdown-item"><!----> <a href="/note/java/collection/ArrayList.html" class="nav-link">
  Java集合框架
</a></li><li class="dropdown-item"><!----> <a href="/note/java/concurrent/Theory.html" class="nav-link">
  Java并发编程
</a></li><li class="dropdown-item"><!----> <a href="/note/java/jvm/memory.html" class="nav-link">
  JVM相关
</a></li><li class="dropdown-item"><!----> <a href="/note/java/nio/io.html" class="nav-link">
  Java NIO相关
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="数据存储" class="dropdown-title"><span class="title">数据存储</span> <span class="arrow down"></span></button> <button type="button" aria-label="数据存储" class="mobile-dropdown-title"><span class="title">数据存储</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/note/storage/database/mysql.html" class="nav-link">
  MySQL
</a></li><li class="dropdown-item"><!----> <a href="/note/storage/redis/redis-question.html" class="nav-link">
  Redis
</a></li><li class="dropdown-item"><!----> <a href="/note/storage/mq/kafka-intro.html" class="nav-link">
  消息队列
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="框架" class="dropdown-title"><span class="title">框架</span> <span class="arrow down"></span></button> <button type="button" aria-label="框架" class="mobile-dropdown-title"><span class="title">框架</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/note/framework/spring-framework/spring-framework-intro.html" class="nav-link">
  Spring框架
</a></li><li class="dropdown-item"><!----> <a href="/note/framework/netty/netty-business-logic.html" class="nav-link">
  Netty
</a></li><li class="dropdown-item"><!----> <a href="/note/framework/apollo/setup-debug-enviroment.html" class="nav-link">
  Apollo源码分析
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="架构" class="dropdown-title"><span class="title">架构</span> <span class="arrow down"></span></button> <button type="button" aria-label="架构" class="mobile-dropdown-title"><span class="title">架构</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/note/arch/system-design/01-scale-from-zero.html" class="nav-link">
  系统设计
</a></li><li class="dropdown-item"><!----> <a href="/note/arch/case-study/rate-limiter.html" class="nav-link">
  案例
</a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Apollo源码分析</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/note/framework/apollo/setup-debug-enviroment.html" class="sidebar-link">Apollo调试环境搭建</a></li><li><a href="/note/framework/apollo/portal-create-app.html" class="sidebar-link">Apollo源码分析——Portal创建App</a></li><li><a href="/note/framework/apollo/portal-create-cluster.html" class="sidebar-link">Apollo源码分析——Portal创建Cluster</a></li><li><a href="/note/framework/apollo/portal-create-appnamespace.html" class="sidebar-link">Apollo源码分析——Portal创建Namespace</a></li><li><a href="/note/framework/apollo/portal-create-namespace.html" class="sidebar-link">Apollo源码分析——Portal关联Namespace</a></li><li><a href="/note/framework/apollo/portal-create-item.html" class="sidebar-link">Apollo源码分析——Portal创建Item</a></li><li><a href="/note/framework/apollo/portal-create-item-by-text.html" class="sidebar-link">Apollo源码分析——Portal文本变更Item</a></li><li><a href="/note/framework/apollo/portal-publish.html" class="sidebar-link">Apollo源码分析——Portal发布配置</a></li><li><a href="/note/framework/apollo/adminservice-send-release-message.html" class="sidebar-link">Apollo源码分析——AdminService发布ReleaseMessage</a></li><li><a href="/note/framework/apollo/configservice-notifications.html" aria-current="page" class="active sidebar-link">Apollo源码分析——ConfigService通知配置变更</a></li><li><a href="/note/framework/apollo/configservice-query-api.html" class="sidebar-link">Apollo源码分析——ConfigService配置查询</a></li><li><a href="/note/framework/apollo/client-poll-config.html" class="sidebar-link">Apollo源码分析——Client拉取配置</a></li><li><a href="/note/framework/apollo/portal-create-namespace-branch.html" class="sidebar-link">Apollo源码分析——Portal 创建灰度</a></li><li><a href="/note/framework/apollo/portal-create-namespace-branch-gray-rule.html" class="sidebar-link">Apollo源码分析——Portal 配置灰度规则</a></li><li><a href="/note/framework/apollo/portal-publish-namespace-branch-to-master.html" class="sidebar-link">Apollo源码分析——Portal 灰度全量发布</a></li><li><a href="/note/framework/apollo/portal-publish-namespace-branch.html" class="sidebar-link">Apollo 源码解析 —— Portal 灰度发布</a></li><li><a href="/note/framework/apollo/client-config-api-1.html" class="sidebar-link">Apollo 源码解析 —— 客户端 API 配置（一）之一览</a></li><li><a href="/note/framework/apollo/client-config-api-2.html" class="sidebar-link">Apollo 源码解析 —— 客户端 API 配置（二）之 Config</a></li><li><a href="/note/framework/apollo/client-config-api-3.html" class="sidebar-link">Apollo 源码解析 —— 客户端 API 配置（三）之 ConfigFile</a></li><li><a href="/note/framework/apollo/client-config-api-4.html" class="sidebar-link">Apollo 源码解析 —— 客户端 API 配置（四）之 ConfigRepository                            </a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="apollo源码分析-configservice通知配置变更"><a href="#apollo源码分析-configservice通知配置变更" class="header-anchor">#</a> Apollo源码分析——ConfigService通知配置变更</h1> <p></p><div class="table-of-contents"><ul><li><a href="#apollo源码分析-configservice通知配置变更">Apollo源码分析——ConfigService通知配置变更</a><ul><li><a href="#概述">概述</a></li><li><a href="#notificationcontrollerv2">NotificationControllerV2</a><ul><li><a href="#pollnotification">pollNotification</a></li><li><a href="#handlemessage">handleMessage</a></li></ul></li><li><a href="#apolloconfignotification">ApolloConfigNotification</a></li><li><a href="#deferredresultwrapper">DeferredResultWrapper</a></li><li><a href="#releasemessageservicewithcache">ReleaseMessageServiceWithCache</a></li><li><a href="#watchkeysutil">WatchKeysUtil</a></li><li><a href="#entitymanagerutil">EntityManagerUtil</a></li></ul></li></ul></div><p></p> <h2 id="概述"><a href="#概述" class="header-anchor">#</a> 概述</h2> <p>上文中提到<code>ReleaseMessageScanner</code>扫描到ReleaseMessage后会回调<code>ReleaseMessageListener</code>接口的实现，其中<code>NotificationControllerV2</code>实现和客户端推送配置相关。</p> <p>那NotificationControllerV2在得知有配置发布后是如何通知到客户端的呢？</p> <p>以下内容来自<a href="https://www.apolloconfig.com/#/zh/design/apollo-design" target="_blank" rel="noopener noreferrer">Apollo配置中心设计<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>实现方式如下：</p> <blockquote><ol><li>客户端会发起一个Http请求到Config Service的notifications/v2接口，也就是NotificationControllerV2，参见RemoteConfigLongPollService</li> <li>NotificationControllerV2不会立即返回结果，而是通过Spring DeferredResult把请求挂起</li> <li>如果在60秒内没有该客户端关心的配置发布，那么会返回Http状态码304给客户端</li> <li>如果有该客户端关心的配置发布，NotificationControllerV2会调用DeferredResult的setResult方法，传入有配置变化的namespace信息，同时该请求会立即返回。客户端从返回的结果中获取到配置变化的namespace后，会立即请求Config Service获取该namespace的最新配置。</li></ol></blockquote> <h2 id="notificationcontrollerv2"><a href="#notificationcontrollerv2" class="header-anchor">#</a> NotificationControllerV2</h2> <h3 id="pollnotification"><a href="#pollnotification" class="header-anchor">#</a> pollNotification</h3> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@GetMapping</span>
<span class="token keyword">public</span> <span class="token class-name">DeferredResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ResponseEntity</span><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">ApolloConfigNotification</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">pollNotification</span><span class="token punctuation">(</span>
        <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;appId&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> appId<span class="token punctuation">,</span>
        <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;cluster&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> cluster<span class="token punctuation">,</span>
        <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;notifications&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> notificationsAsString<span class="token punctuation">,</span>
        <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;dataCenter&quot;</span><span class="token punctuation">,</span> required <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token class-name">String</span> dataCenter<span class="token punctuation">,</span>
        <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;ip&quot;</span><span class="token punctuation">,</span> required <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token class-name">String</span> clientIp<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ApolloConfigNotification</span><span class="token punctuation">&gt;</span></span> notifications <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        notifications <span class="token operator">=</span>
            gson<span class="token punctuation">.</span><span class="token function">fromJson</span><span class="token punctuation">(</span>notificationsAsString<span class="token punctuation">,</span> notificationsTypeReference<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Tracer</span><span class="token punctuation">.</span><span class="token function">logError</span><span class="token punctuation">(</span>ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">CollectionUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>notifications<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token class-name">BadRequestException</span><span class="token punctuation">.</span><span class="token function">invalidNotificationsFormat</span><span class="token punctuation">(</span>notificationsAsString<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">ApolloConfigNotification</span><span class="token punctuation">&gt;</span></span> filteredNotifications <span class="token operator">=</span> <span class="token function">filterNotifications</span><span class="token punctuation">(</span>appId<span class="token punctuation">,</span> notifications<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">CollectionUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>filteredNotifications<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token class-name">BadRequestException</span><span class="token punctuation">.</span><span class="token function">invalidNotificationsFormat</span><span class="token punctuation">(</span>notificationsAsString<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token class-name">DeferredResultWrapper</span> deferredResultWrapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DeferredResultWrapper</span><span class="token punctuation">(</span>bizConfig<span class="token punctuation">.</span><span class="token function">longPollingTimeoutInMilli</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> namespaces <span class="token operator">=</span> <span class="token class-name">Sets</span><span class="token punctuation">.</span><span class="token function">newHashSetWithExpectedSize</span><span class="token punctuation">(</span>filteredNotifications<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> clientSideNotifications <span class="token operator">=</span> <span class="token class-name">Maps</span><span class="token punctuation">.</span><span class="token function">newHashMapWithExpectedSize</span><span class="token punctuation">(</span>filteredNotifications<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Map<span class="token punctuation">.</span>Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">ApolloConfigNotification</span><span class="token punctuation">&gt;</span></span> notificationEntry <span class="token operator">:</span> filteredNotifications<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> normalizedNamespace <span class="token operator">=</span> notificationEntry<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ApolloConfigNotification</span> notification <span class="token operator">=</span> notificationEntry<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        namespaces<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>normalizedNamespace<span class="token punctuation">)</span><span class="token punctuation">;</span>
        clientSideNotifications<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>normalizedNamespace<span class="token punctuation">,</span> notification<span class="token punctuation">.</span><span class="token function">getNotificationId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>notification<span class="token punctuation">.</span><span class="token function">getNamespaceName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> normalizedNamespace<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            deferredResultWrapper<span class="token punctuation">.</span><span class="token function">recordNamespaceNameNormalizedResult</span><span class="token punctuation">(</span>notification<span class="token punctuation">.</span><span class="token function">getNamespaceName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> normalizedNamespace<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token class-name">Multimap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> watchedKeysMap <span class="token operator">=</span>
        watchKeysUtil<span class="token punctuation">.</span><span class="token function">assembleAllWatchKeys</span><span class="token punctuation">(</span>appId<span class="token punctuation">,</span> cluster<span class="token punctuation">,</span> namespaces<span class="token punctuation">,</span> dataCenter<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> watchedKeys <span class="token operator">=</span> <span class="token class-name">Sets</span><span class="token punctuation">.</span><span class="token function">newHashSet</span><span class="token punctuation">(</span>watchedKeysMap<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 1、set deferredResult before the check, for avoid more waiting
     * If the check before setting deferredResult,it may receive a notification the next time
     * when method handleMessage is executed between check and set deferredResult.
     */</span>
    deferredResultWrapper
          <span class="token punctuation">.</span><span class="token function">onTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token function">logWatchedKeys</span><span class="token punctuation">(</span>watchedKeys<span class="token punctuation">,</span> <span class="token string">&quot;Apollo.LongPoll.TimeOutKeys&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    deferredResultWrapper<span class="token punctuation">.</span><span class="token function">onCompletion</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">//unregister all keys</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> key <span class="token operator">:</span> watchedKeys<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            deferredResults<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> deferredResultWrapper<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">logWatchedKeys</span><span class="token punctuation">(</span>watchedKeys<span class="token punctuation">,</span> <span class="token string">&quot;Apollo.LongPoll.CompletedKeys&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//register all keys</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> key <span class="token operator">:</span> watchedKeys<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>deferredResults<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> deferredResultWrapper<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">logWatchedKeys</span><span class="token punctuation">(</span>watchedKeys<span class="token punctuation">,</span> <span class="token string">&quot;Apollo.LongPoll.RegisteredKeys&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Listening {} from appId: {}, cluster: {}, namespace: {}, datacenter: {}&quot;</span><span class="token punctuation">,</span>
        watchedKeys<span class="token punctuation">,</span> appId<span class="token punctuation">,</span> cluster<span class="token punctuation">,</span> namespaces<span class="token punctuation">,</span> dataCenter<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 2、check new release
     */</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ReleaseMessage</span><span class="token punctuation">&gt;</span></span> latestReleaseMessages <span class="token operator">=</span>
        releaseMessageService<span class="token punctuation">.</span><span class="token function">findLatestReleaseMessagesGroupByMessages</span><span class="token punctuation">(</span>watchedKeys<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * Manually close the entity manager.
     * Since for async request, Spring won't do so until the request is finished,
     * which is unacceptable since we are doing long polling - means the db connection would be hold
     * for a very long time
     */</span>
    entityManagerUtil<span class="token punctuation">.</span><span class="token function">closeEntityManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ApolloConfigNotification</span><span class="token punctuation">&gt;</span></span> newNotifications <span class="token operator">=</span>
        <span class="token function">getApolloConfigNotifications</span><span class="token punctuation">(</span>namespaces<span class="token punctuation">,</span> clientSideNotifications<span class="token punctuation">,</span> watchedKeysMap<span class="token punctuation">,</span>
            latestReleaseMessages<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">CollectionUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>newNotifications<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        deferredResultWrapper<span class="token punctuation">.</span><span class="token function">setResult</span><span class="token punctuation">(</span>newNotifications<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> deferredResultWrapper<span class="token punctuation">.</span><span class="token function">getResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><ol><li>将<code>notificationsAsString</code>解析成<code>List&lt;ApolloConfigNotification&gt;</code>，表示客户端本地的配置通知信息
<ul><li>因为一个客户端可以订阅多个 Namespace ，所以该参数是 List</li> <li>该接口真正返回的结果也是<code>List&lt;ApolloConfigNotification&gt;</code>，仅返回配置发生变化的 Namespace 对应的 ApolloConfigNotification 。也就说，当有几个配置发生变化的 Namespace ，返回几个对应的 ApolloConfigNotification 。另外，客户端接收到返回后，会增量合并到本地的配置通知信息。客户端下次请求时，使用合并后的配置通知信息</li> <li>注意，客户端请求时，只传递 ApolloConfigNotification 的 <code>namespaceName</code> + <code>notificationId</code> ，不传递 messages</li></ul></li> <li><code>clientIp</code>请求参数，目前该接口暂时用不到，作为预留参数</li> <li>调用<code>filterNotifications</code>方法，过滤后返回<code>Map&lt;String, ApolloConfigNotification&gt;</code>。<code>filterNotifications</code>的目的是客户端传递的Namespace名字可能不正确，比如大小写不对，这个方法会对其做归一化处理<div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">ApolloConfigNotification</span><span class="token punctuation">&gt;</span></span> <span class="token function">filterNotifications</span><span class="token punctuation">(</span><span class="token class-name">String</span> appId<span class="token punctuation">,</span>
                                                                <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ApolloConfigNotification</span><span class="token punctuation">&gt;</span></span> notifications<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">ApolloConfigNotification</span><span class="token punctuation">&gt;</span></span> filteredNotifications <span class="token operator">=</span> <span class="token class-name">Maps</span><span class="token punctuation">.</span><span class="token function">newHashMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">ApolloConfigNotification</span> notification <span class="token operator">:</span> notifications<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Strings</span><span class="token punctuation">.</span><span class="token function">isNullOrEmpty</span><span class="token punctuation">(</span>notification<span class="token punctuation">.</span><span class="token function">getNamespaceName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//strip out .properties suffix</span>
        <span class="token class-name">String</span> originalNamespace <span class="token operator">=</span> namespaceUtil<span class="token punctuation">.</span><span class="token function">filterNamespaceName</span><span class="token punctuation">(</span>notification<span class="token punctuation">.</span><span class="token function">getNamespaceName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        notification<span class="token punctuation">.</span><span class="token function">setNamespaceName</span><span class="token punctuation">(</span>originalNamespace<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//fix the character case issue, such as FX.apollo &lt;-&gt; fx.apollo</span>
        <span class="token class-name">String</span> normalizedNamespace <span class="token operator">=</span> namespaceUtil<span class="token punctuation">.</span><span class="token function">normalizeNamespace</span><span class="token punctuation">(</span>appId<span class="token punctuation">,</span> originalNamespace<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// in case client side namespace name has character case issue and has difference notification ids</span>
        <span class="token comment">// such as FX.apollo = 1 but fx.apollo = 2, we should let FX.apollo have the chance to update its notification id</span>
        <span class="token comment">// which means we should record FX.apollo = 1 here and ignore fx.apollo = 2</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>filteredNotifications<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>normalizedNamespace<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
            filteredNotifications<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>normalizedNamespace<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getNotificationId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> notification<span class="token punctuation">.</span><span class="token function">getNotificationId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        filteredNotifications<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>normalizedNamespace<span class="token punctuation">,</span> notification<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> filteredNotifications<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>调用<code>namespaceUtil.filterNamespaceName</code>方法过滤Namespace后缀，如果是以<code>.properties</code>结尾则去掉该后缀<div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">filterNamespaceName</span><span class="token punctuation">(</span><span class="token class-name">String</span> namespaceName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>namespaceName<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">endsWith</span><span class="token punctuation">(</span><span class="token string">&quot;.properties&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> dotIndex <span class="token operator">=</span> namespaceName<span class="token punctuation">.</span><span class="token function">lastIndexOf</span><span class="token punctuation">(</span><span class="token string">&quot;.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> namespaceName<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> dotIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> namespaceName<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li>调用<code>namespaceUtil.normalizeNamespace</code>方法进行归一化处理。例如，数据库中Namespace名为<code>Fx.Apollo</code>，而客户端Namespace名为<code>fx.Apollo</code>,通过归一化后，统一为<code>Fx.Apollo</code><div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">normalizeNamespace</span><span class="token punctuation">(</span><span class="token class-name">String</span> appId<span class="token punctuation">,</span> <span class="token class-name">String</span> namespaceName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">AppNamespace</span> appNamespace <span class="token operator">=</span> appNamespaceServiceWithCache<span class="token punctuation">.</span><span class="token function">findByAppIdAndNamespace</span><span class="token punctuation">(</span>appId<span class="token punctuation">,</span> namespaceName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>appNamespace <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> appNamespace<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    appNamespace <span class="token operator">=</span> appNamespaceServiceWithCache<span class="token punctuation">.</span><span class="token function">findPublicNamespaceByName</span><span class="token punctuation">(</span>namespaceName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>appNamespace <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> appNamespace<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> namespaceName<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li>如果客户端Namespace的名字有大小写的问题，并且恰好有不同的通知编号。例如Namespace名字为<code>FX.apollo</code>的通知编号是1，但是<code>fx.apollo</code>的通知编号为2。我们应该让<code>FX.apollo</code>可以更新它的通知编号，所以，我们使用<code>FX.apollo</code>的ApolloConfigNotification对象，添加到结果，而忽略<code>fx.apollo</code>。通过这样的方式，若此时服务器的通知编号为3，那么<code>FX.apollo</code>的通知编号先更新成3，再下一次长轮询时，<code>fx.apollo</code>的通知编号再更新成3</li></ul></li> <li>创建<code>DeferredResultWrapper</code>对象，超时时间由<code>bizConfig.longPollingTimeoutInMilli()</code>返回，可通过参数<code>long.polling.timeout</code>设置，默认值60s</li> <li>创建<code>Set&lt;String&gt;</code>对象<code>namespaces</code>、<code>Map&lt;String, Long&gt;</code>对象<code>clientSideNotifications</code>，循环<code>filterNotifications</code>，将归一化后的Namespace名字加入到<code>namespaces</code>和<code>clientSideNotifications</code>中。如果归一化的Namespace名字与客户端传递的Namespace名字不一致，则记录到<code>deferredResultWrapper</code>中，原因是客户端只认识原始的Namespace名字</li> <li>调用<code>watchKeysUtil.assembleAllWatchKeys</code>组装Watch Key</li> <li>为<code>deferredResultWrapper</code>设置<code>onTimeout</code>、<code>onCompletion</code>事件的回调函数</li> <li>将每个Watch Key和<code>deferredResultWrapper</code>注册到<code>deferredResults</code>中</li> <li>调用<code>releaseMessageService.findLatestReleaseMessagesGroupByMessages</code>方法，获得 Watch Key 集合中，每个 Watch Key 对应的最新的 ReleaseMessage 记录</li> <li>调用<code>entityManagerUtil.closeEntityManager</code>手动关闭 EntityManager，对应Async请求，Srping在请求完成之前是不会关闭EntityManager的，这意味着长连接过程中，数据库连接不会释放，实际上后面的处理已经不需要数据库连接了，所以这里释放调</li> <li>调用<code>getApolloConfigNotifications</code>方法，获得新的 ApolloConfigNotification 通知数组<code>newNotifications</code><div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ApolloConfigNotification</span><span class="token punctuation">&gt;</span></span> <span class="token function">getApolloConfigNotifications</span><span class="token punctuation">(</span><span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> namespaces<span class="token punctuation">,</span>
                                                                  <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> clientSideNotifications<span class="token punctuation">,</span>
                                                                  <span class="token class-name">Multimap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> watchedKeysMap<span class="token punctuation">,</span>
                                                                  <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ReleaseMessage</span><span class="token punctuation">&gt;</span></span> latestReleaseMessages<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ApolloConfigNotification</span><span class="token punctuation">&gt;</span></span> newNotifications <span class="token operator">=</span> <span class="token class-name">Lists</span><span class="token punctuation">.</span><span class="token function">newArrayList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">CollectionUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>latestReleaseMessages<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> latestNotifications <span class="token operator">=</span> <span class="token class-name">Maps</span><span class="token punctuation">.</span><span class="token function">newHashMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">ReleaseMessage</span> releaseMessage <span class="token operator">:</span> latestReleaseMessages<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        latestNotifications<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>releaseMessage<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> releaseMessage<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> namespace <span class="token operator">:</span> namespaces<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">long</span> clientSideId <span class="token operator">=</span> clientSideNotifications<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>namespace<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">long</span> latestId <span class="token operator">=</span> <span class="token class-name">ConfigConsts</span><span class="token punctuation">.</span><span class="token constant">NOTIFICATION_ID_PLACEHOLDER</span><span class="token punctuation">;</span>
        <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> namespaceWatchedKeys <span class="token operator">=</span> watchedKeysMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>namespace<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> namespaceWatchedKey <span class="token operator">:</span> namespaceWatchedKeys<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">long</span> namespaceNotificationId <span class="token operator">=</span>
                latestNotifications<span class="token punctuation">.</span><span class="token function">getOrDefault</span><span class="token punctuation">(</span>namespaceWatchedKey<span class="token punctuation">,</span> <span class="token class-name">ConfigConsts</span><span class="token punctuation">.</span><span class="token constant">NOTIFICATION_ID_PLACEHOLDER</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>namespaceNotificationId <span class="token operator">&gt;</span> latestId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                latestId <span class="token operator">=</span> namespaceNotificationId<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>latestId <span class="token operator">&gt;</span> clientSideId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">ApolloConfigNotification</span> notification <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ApolloConfigNotification</span><span class="token punctuation">(</span>namespace<span class="token punctuation">,</span> latestId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            namespaceWatchedKeys<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>latestNotifications<span class="token operator">::</span><span class="token function">containsKey</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>namespaceWatchedKey <span class="token operator">-&gt;</span>
                notification<span class="token punctuation">.</span><span class="token function">addMessage</span><span class="token punctuation">(</span>namespaceWatchedKey<span class="token punctuation">,</span> latestNotifications<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>namespaceWatchedKey<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            newNotifications<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>notification<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> newNotifications<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>遍历<code>latestReleaseMessages</code>，将服务端最新的ReleaseMessage记录在<code>latestNotifications</code>中</li> <li>遍历<code>namespaces</code>，从<code>clientSideNotifications</code>获取客户端该Namespace的通知ID，计算服务端最大的ID</li> <li>若服务器的通知编号大于客户端的通知编号，意味着有配置更新，那么会创建<code>ApolloConfigNotification</code>对象，循环调用<code>addMessage</code>方法，添加到<code>ApolloConfigNotification</code>中</li> <li>返回<code>newNotifications</code>，若非空，说明有配置更新</li></ul></li> <li>若有新的通知，调用<code>DeferredResultWrapper#setResult(List&lt;ApolloConfigNotification&gt;)</code>方法，直接设置 DeferredResult 的结果，从而结束长轮询。</li></ol> <h3 id="handlemessage"><a href="#handlemessage" class="header-anchor">#</a> handleMessage</h3> <p><code>handleMessage</code>方法实现了<code>ReleaseMessageListener</code>接口中的定义，用于ReleaseMessage的通知</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/notifications/v2&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">NotificationControllerV2</span> <span class="token keyword">implements</span> <span class="token class-name">ReleaseMessageListener</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handleMessage</span><span class="token punctuation">(</span><span class="token class-name">ReleaseMessage</span> message<span class="token punctuation">,</span> <span class="token class-name">String</span> channel<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;message received - channel: {}, message: {}&quot;</span><span class="token punctuation">,</span> channel<span class="token punctuation">,</span> message<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">String</span> content <span class="token operator">=</span> message<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Tracer</span><span class="token punctuation">.</span><span class="token function">logEvent</span><span class="token punctuation">(</span><span class="token string">&quot;Apollo.LongPoll.Messages&quot;</span><span class="token punctuation">,</span> content<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">Topics</span><span class="token punctuation">.</span><span class="token constant">APOLLO_RELEASE_TOPIC</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>channel<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token class-name">Strings</span><span class="token punctuation">.</span><span class="token function">isNullOrEmpty</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token class-name">String</span> changedNamespace <span class="token operator">=</span> retrieveNamespaceFromReleaseMessage<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Strings</span><span class="token punctuation">.</span><span class="token function">isNullOrEmpty</span><span class="token punctuation">(</span>changedNamespace<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;message format invalid - {}&quot;</span><span class="token punctuation">,</span> content<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>deferredResults<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//create a new list to avoid ConcurrentModificationException</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DeferredResultWrapper</span><span class="token punctuation">&gt;</span></span> results <span class="token operator">=</span> <span class="token class-name">Lists</span><span class="token punctuation">.</span><span class="token function">newArrayList</span><span class="token punctuation">(</span>deferredResults<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">ApolloConfigNotification</span> configNotification <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ApolloConfigNotification</span><span class="token punctuation">(</span>changedNamespace<span class="token punctuation">,</span> message<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        configNotification<span class="token punctuation">.</span><span class="token function">addMessage</span><span class="token punctuation">(</span>content<span class="token punctuation">,</span> message<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//do async notification if too many clients</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>results<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> bizConfig<span class="token punctuation">.</span><span class="token function">releaseMessageNotificationBatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            largeNotificationBatchExecutorService<span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Async notify {} clients for key {} with batch {}&quot;</span><span class="token punctuation">,</span> results<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> content<span class="token punctuation">,</span>
                    bizConfig<span class="token punctuation">.</span><span class="token function">releaseMessageNotificationBatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> results<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> i <span class="token operator">%</span> bizConfig<span class="token punctuation">.</span><span class="token function">releaseMessageNotificationBatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">try</span> <span class="token punctuation">{</span>
                        <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MILLISECONDS</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span>bizConfig<span class="token punctuation">.</span><span class="token function">releaseMessageNotificationBatchIntervalInMilli</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment">//ignore</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Async notify {}&quot;</span><span class="token punctuation">,</span> results<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                results<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setResult</span><span class="token punctuation">(</span>configNotification<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Notify {} clients for key {}&quot;</span><span class="token punctuation">,</span> results<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> content<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">DeferredResultWrapper</span> result <span class="token operator">:</span> results<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            result<span class="token punctuation">.</span><span class="token function">setResult</span><span class="token punctuation">(</span>configNotification<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Notification completed&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ol><li>判断<code>channel</code>是否是<code>Topics.APOLLO_RELEASE_TOPIC = &quot;apollo-release&quot;</code>，且ReleaseMessage的<code>content</code>不为空，否则直接返回</li> <li>调用<code>retrieveNamespaceFromReleaseMessage</code>函数，将<code>content</code>进行分隔提取出Namespace，如果Namespace是空的话直接返回。ReleaseMessage消息格式可以参考前文，具体在<code>ReleaseMessageKeyGenerator.generate</code>方法，格式是<code>appId+cluster+namespace</code><div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Function</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> retrieveNamespaceFromReleaseMessage <span class="token operator">=</span>
    releaseMessage <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Strings</span><span class="token punctuation">.</span><span class="token function">isNullOrEmpty</span><span class="token punctuation">(</span>releaseMessage<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> keys <span class="token operator">=</span> <span class="token class-name">ReleaseMessageKeyGenerator</span><span class="token punctuation">.</span><span class="token function">messageToList</span><span class="token punctuation">(</span>releaseMessage<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">CollectionUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>keys<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> keys<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div></li> <li>检查<code>deferredResults</code>是否包含<code>content</code>，不包含直接返回</li> <li>从<code>deferredResults</code>中构造<code>DeferredResultWrapper</code>列表<code>results</code>，注意<code>deferredResults</code>是一个<code>Multimap</code>结构，因此<code>get</code>时候返回的是一个集合</li> <li>创建<code>ApolloConfigNotification</code>对象<code>configNotification</code>作为最终返回给客户端的数据结构，并调用<code>addMessage</code>方法将<code>content</code>加入到内部的<code>ApolloNotificationMessages</code>对象<code>messages</code>中</li> <li>如果<code>results</code>列表的长度大于<code>bizConfig.releaseMessageNotificationBatch()</code>（这个值由参数<code>apollo.release-message.notification.batch</code>设置，默认值是100）。如果列表过长表示现在有太多的客户端长连接存在，那么会在<code>largeNotificationBatchExecutorService</code>线程池中异步向客户端推送，每推送<code>bizConfig.releaseMessageNotificationBatch()</code>个客户端，就会sleep <code>bizConfig.releaseMessageNotificationBatchIntervalInMilli()</code>（这个值由参数<code>apollo.release-message.notification.batch.interval</code>设置，默认值是100）毫秒</li> <li>如果<code>reulsts</code>李彪长度不大于<code>bizConfig.releaseMessageNotificationBatch()</code>，那么直接<code>setResult</code>通知客户端</li></ol> <h2 id="apolloconfignotification"><a href="#apolloconfignotification" class="header-anchor">#</a> ApolloConfigNotification</h2> <p><code>com.ctrip.framework.apollo.core.dto.ApolloConfigNotification</code>，Apollo配置通知DTO</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ApolloConfigNotification</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> namespaceName<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">long</span> notificationId<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token class-name">ApolloNotificationMessages</span> messages<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">ApolloConfigNotification</span><span class="token punctuation">(</span><span class="token class-name">String</span> namespaceName<span class="token punctuation">,</span> <span class="token keyword">long</span> notificationId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>namespaceName <span class="token operator">=</span> namespaceName<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>notificationId <span class="token operator">=</span> notificationId<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addMessage</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token keyword">long</span> notificationId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>messages <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">synchronized</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>messages <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span>messages <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ApolloNotificationMessages</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">this</span><span class="token punctuation">.</span>messages<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> notificationId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li><code>messages</code>使用了<code>volatile</code>修饰，原因是可能存在多线程修改</li></ul> <p><code>ApolloNotificationMessages</code>就是对Map的封装，内部仅有一个Map结构<code>details</code></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ApolloNotificationMessages</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> details<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>为什么<code>ApolloConfigNotification</code>中有<code>ApolloNotificationMessages</code>，而且<code>ApolloNotificationMessages</code>的<code>details</code>字段是Map？按道理说，对于一个Namespace的通知，使用 <code>ApolloConfigNotification</code>的<code>namespaceName + notificationId</code>已经足够了。但是，在<code>namespaceName</code>对应的Namespace是关联类型时，会同时查询<code>当前Namespace + 关联的Namespace</code>这两个Namespace，所以会是多个，使用Map数据结构。 当然，对于<code>/notifications/v2</code>接口，仅有【直接】获得到配置变化才可能出现<code>ApolloNotificationMessages.details</code>为多个的情况。为啥？在<code>#handleMessage(...)</code>方法中，一次只处理一条ReleaseMessage，因此只会有<code>ApolloNotificationMessages.details</code>只会有一个。</p> <h2 id="deferredresultwrapper"><a href="#deferredresultwrapper" class="header-anchor">#</a> DeferredResultWrapper</h2> <p><code>com.ctrip.framework.apollo.configservice.wrapper.DeferredResultWrapper</code> ，DeferredResult 包装器，封装 DeferredResult 的公用方法。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">ResponseEntity</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">ApolloConfigNotification</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span>
      <span class="token constant">NOT_MODIFIED_RESPONSE_LIST</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ResponseEntity</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token class-name">HttpStatus</span><span class="token punctuation">.</span><span class="token constant">NOT_MODIFIED</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">private</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> normalizedNamespaceNameToOriginalNamespaceName<span class="token punctuation">;</span>

<span class="token keyword">private</span> <span class="token class-name">DeferredResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ResponseEntity</span><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">ApolloConfigNotification</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> result<span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token class-name">DeferredResultWrapper</span><span class="token punctuation">(</span><span class="token keyword">long</span> timeoutInMilli<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DeferredResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>timeoutInMilli<span class="token punctuation">,</span> <span class="token constant">NOT_MODIFIED_RESPONSE_LIST</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>NOT_MODIFIED_RESPONSE_LIST</code>，静态属性，未修改时的 ResponseEntity 响应，使用 304 状态码。</p> <p><code>result</code> 属性，响应的 DeferredResult 对象，在构造方法中初始化。</p> <p><code>normalizedNamespaceNameToOriginalNamespaceName</code>属性，归一化( normalized )和原始( original )的 Namespace 的名字的 Map 。因为客户端在填写 Namespace 时，写错了名字的大小写。在 Config Service 中，会进行归一化“修复”，方便逻辑的统一编写。但是，最终返回给客户端需要“还原”回原始( original )的 Namespace 的名字，避免客户端无法识别。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">recordNamespaceNameNormalizedResult</span><span class="token punctuation">(</span><span class="token class-name">String</span> originalNamespaceName<span class="token punctuation">,</span> <span class="token class-name">String</span> normalizedNamespaceName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>normalizedNamespaceNameToOriginalNamespaceName <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      normalizedNamespaceNameToOriginalNamespaceName <span class="token operator">=</span> <span class="token class-name">Maps</span><span class="token punctuation">.</span><span class="token function">newHashMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    normalizedNamespaceNameToOriginalNamespaceName<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>normalizedNamespaceName<span class="token punctuation">,</span> originalNamespaceName<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setResult</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ApolloConfigNotification</span><span class="token punctuation">&gt;</span></span> notifications<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 恢复被归一化的 Namespace 的名字为原始的 Namespace 的名字</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>normalizedNamespaceNameToOriginalNamespaceName <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        notifications<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>notification <span class="token operator">-&gt;</span> normalizedNamespaceNameToOriginalNamespaceName<span class="token punctuation">.</span>containsKey
                <span class="token punctuation">(</span>notification<span class="token punctuation">.</span><span class="token function">getNamespaceName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>notification <span class="token operator">-&gt;</span> notification<span class="token punctuation">.</span><span class="token function">setNamespaceName</span><span class="token punctuation">(</span>
                normalizedNamespaceNameToOriginalNamespaceName<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>notification<span class="token punctuation">.</span><span class="token function">getNamespaceName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 设置结果，并使用 200 状态码。</span>
    result<span class="token punctuation">.</span><span class="token function">setResult</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ResponseEntity</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>notifications<span class="token punctuation">,</span> <span class="token class-name">HttpStatus</span><span class="token punctuation">.</span><span class="token constant">OK</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="releasemessageservicewithcache"><a href="#releasemessageservicewithcache" class="header-anchor">#</a> ReleaseMessageServiceWithCache</h2> <p><code>com.ctrip.framework.apollo.configservice.service.ReleaseMessageServiceWithCache</code> ，实现 InitializingBean 和 ReleaseMessageListener 接口，缓存 ReleaseMessage 的 Service 实现类。通过将 ReleaseMessage 缓存在内存中，提高查询性能。缓存实现方式如下：</p> <ul><li>启动时，初始化 ReleaseMessage 到缓存。</li> <li>新增时，基于 ReleaseMessageListener ，通知有新的 ReleaseMessage ，根据是否有消息间隙，直接使用该 ReleaseMessage 或从数据库读取。</li></ul> <p><code>#afterPropertiesSet()</code> 方法，通知 Spring 调用，初始化定时任务。代码如下：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">afterPropertiesSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token function">populateDataBaseInterval</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//block the startup process until load finished</span>
    <span class="token comment">//this should happen before ReleaseMessageScanner due to autowire</span>
    <span class="token function">loadReleaseMessages</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    executorService<span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>doScan<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isInterrupted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">Transaction</span> transaction <span class="token operator">=</span> <span class="token class-name">Tracer</span><span class="token punctuation">.</span><span class="token function">newTransaction</span><span class="token punctuation">(</span><span class="token string">&quot;Apollo.ReleaseMessageServiceWithCache&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;scanNewReleaseMessages&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token function">loadReleaseMessages</span><span class="token punctuation">(</span>maxIdScanned<span class="token punctuation">)</span><span class="token punctuation">;</span>
                transaction<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token class-name">Transaction</span><span class="token punctuation">.</span><span class="token constant">SUCCESS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                transaction<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span>ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
                logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;Scan new release messages failed&quot;</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                transaction<span class="token punctuation">.</span><span class="token function">complete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                scanIntervalTimeUnit<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span>scanInterval<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">//ignore</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><ol><li><p>调用<code>#populateDataBaseInterval()</code>方法，从<code>bizConfig</code>中读取<code>scanInterval</code>和<code>scanIntervalTimeUnit</code></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">populateDataBaseInterval</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    scanInterval <span class="token operator">=</span> bizConfig<span class="token punctuation">.</span><span class="token function">releaseMessageCacheScanInterval</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    scanIntervalTimeUnit <span class="token operator">=</span> bizConfig<span class="token punctuation">.</span><span class="token function">releaseMessageCacheScanIntervalTimeUnit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>调用<code>#loadReleaseMessages(startId)</code>方法，初始拉取 ReleaseMessage 到缓存。以<code>startId</code>为起点、500为批次大小，分批从数据库中查询ReleaseMessage，调用<code>mergeReleaseMessage</code>合并到缓存中。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">loadReleaseMessages</span><span class="token punctuation">(</span><span class="token keyword">long</span> startId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">boolean</span> hasMore <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>hasMore <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isInterrupted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//current batch is 500</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ReleaseMessage</span><span class="token punctuation">&gt;</span></span> releaseMessages <span class="token operator">=</span> releaseMessageRepository
            <span class="token punctuation">.</span><span class="token function">findFirst500ByIdGreaterThanOrderByIdAsc</span><span class="token punctuation">(</span>startId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">CollectionUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>releaseMessages<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        releaseMessages<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">::</span><span class="token function">mergeReleaseMessage</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> scanned <span class="token operator">=</span> releaseMessages<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        startId <span class="token operator">=</span> releaseMessages<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>scanned <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        hasMore <span class="token operator">=</span> scanned <span class="token operator">==</span> <span class="token number">500</span><span class="token punctuation">;</span>
        logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Loaded {} release messages with startId {}&quot;</span><span class="token punctuation">,</span> scanned<span class="token punctuation">,</span> startId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">mergeReleaseMessage</span><span class="token punctuation">(</span><span class="token class-name">ReleaseMessage</span> releaseMessage<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">ReleaseMessage</span> old <span class="token operator">=</span> releaseMessageCache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>releaseMessage<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>old <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> releaseMessage<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> old<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        releaseMessageCache<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>releaseMessage<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> releaseMessage<span class="token punctuation">)</span><span class="token punctuation">;</span>
        maxIdScanned <span class="token operator">=</span> releaseMessage<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>当有新ReleaseMessage产生时会回调<code>#handleMessage()</code>方法，代码如下</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handleMessage</span><span class="token punctuation">(</span><span class="token class-name">ReleaseMessage</span> message<span class="token punctuation">,</span> <span class="token class-name">String</span> channel<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//Could stop once the ReleaseMessageScanner starts to work</span>
    doScan<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;message received - channel: {}, message: {}&quot;</span><span class="token punctuation">,</span> channel<span class="token punctuation">,</span> message<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">String</span> content <span class="token operator">=</span> message<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Tracer</span><span class="token punctuation">.</span><span class="token function">logEvent</span><span class="token punctuation">(</span><span class="token string">&quot;Apollo.ReleaseMessageService.UpdateCache&quot;</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">Topics</span><span class="token punctuation">.</span><span class="token constant">APOLLO_RELEASE_TOPIC</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>channel<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token class-name">Strings</span><span class="token punctuation">.</span><span class="token function">isNullOrEmpty</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">long</span> gap <span class="token operator">=</span> message<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> maxIdScanned<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>gap <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">mergeReleaseMessage</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>gap <span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//gap found!</span>
        <span class="token function">loadReleaseMessages</span><span class="token punctuation">(</span>maxIdScanned<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>关闭增量拉取定时任务的执行。后续通过 ReleaseMessageScanner 通知即可。</li> <li>仅处理 APOLLO_RELEASE_TOPIC 。</li> <li>计算<code>gap</code></li> <li>若无空缺，调用 <code>#mergeReleaseMessage(message)</code> 方法，直接合并即可。</li> <li>若有空缺，调用 <code>#loadReleaseMessages(maxIdScanned)</code> 方法，增量拉取。</li> <li>何时会产生空缺？定时任务还来不及拉取( 即未执行 )，ReleaseMessageScanner 就已经通知，此处会产生空缺的 gap 。</li></ul></li></ol> <h2 id="watchkeysutil"><a href="#watchkeysutil" class="header-anchor">#</a> WatchKeysUtil</h2> <p><code>com.ctrip.framework.apollo.configservice.util.WatchKeysUtil</code> ，Watch Key 工具类。</p> <p>核心的方法为 <code>#assembleAllWatchKeys(appId, clusterName, namespaces, dataCenter)</code> 方法，组装 Watch Key Multimap 。其中 KEY 为 Namespace 的名字，VALUE 为 Watch Key 集合。代码如下：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">Multimap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">assembleAllWatchKeys</span><span class="token punctuation">(</span><span class="token class-name">String</span> appId<span class="token punctuation">,</span> <span class="token class-name">String</span> clusterName<span class="token punctuation">,</span>
                                                       <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> namespaces<span class="token punctuation">,</span>
                                                       <span class="token class-name">String</span> dataCenter<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Multimap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> watchedKeysMap <span class="token operator">=</span>
        <span class="token function">assembleWatchKeys</span><span class="token punctuation">(</span>appId<span class="token punctuation">,</span> clusterName<span class="token punctuation">,</span> namespaces<span class="token punctuation">,</span> dataCenter<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//Every app has an 'application' namespace</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>namespaces<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> namespaces<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token class-name">ConfigConsts</span><span class="token punctuation">.</span><span class="token constant">NAMESPACE_APPLICATION</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> namespacesBelongToAppId <span class="token operator">=</span> <span class="token function">namespacesBelongToAppId</span><span class="token punctuation">(</span>appId<span class="token punctuation">,</span> namespaces<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> publicNamespaces <span class="token operator">=</span> <span class="token class-name">Sets</span><span class="token punctuation">.</span><span class="token function">difference</span><span class="token punctuation">(</span>namespaces<span class="token punctuation">,</span> namespacesBelongToAppId<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//Listen on more namespaces if it's a public namespace</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>publicNamespaces<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            watchedKeysMap
                <span class="token punctuation">.</span><span class="token function">putAll</span><span class="token punctuation">(</span><span class="token function">findPublicConfigWatchKeys</span><span class="token punctuation">(</span>appId<span class="token punctuation">,</span> clusterName<span class="token punctuation">,</span> publicNamespaces<span class="token punctuation">,</span> dataCenter<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> watchedKeysMap<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><ol><li>调用 <code>#assembleWatchKeys(appId, clusterName, namespaces, dataCenter)</code> 方法，组装 App 下的 Watch Key Multimap 。<div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token class-name">Multimap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">assembleWatchKeys</span><span class="token punctuation">(</span><span class="token class-name">String</span> appId<span class="token punctuation">,</span> <span class="token class-name">String</span> clusterName<span class="token punctuation">,</span>
                                                 <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> namespaces<span class="token punctuation">,</span>
                                                 <span class="token class-name">String</span> dataCenter<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Multimap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> watchedKeysMap <span class="token operator">=</span> <span class="token class-name">HashMultimap</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> namespace <span class="token operator">:</span> namespaces<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        watchedKeysMap<span class="token punctuation">.</span><span class="token function">putAll</span><span class="token punctuation">(</span>namespace<span class="token punctuation">,</span> <span class="token function">assembleWatchKeys</span><span class="token punctuation">(</span>appId<span class="token punctuation">,</span> clusterName<span class="token punctuation">,</span> namespace<span class="token punctuation">,</span> dataCenter<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> watchedKeysMap<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">assembleWatchKeys</span><span class="token punctuation">(</span><span class="token class-name">String</span> appId<span class="token punctuation">,</span> <span class="token class-name">String</span> clusterName<span class="token punctuation">,</span> <span class="token class-name">String</span> namespace<span class="token punctuation">,</span>
                                    <span class="token class-name">String</span> dataCenter<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">ConfigConsts</span><span class="token punctuation">.</span><span class="token constant">NO_APPID_PLACEHOLDER</span><span class="token punctuation">.</span><span class="token function">equalsIgnoreCase</span><span class="token punctuation">(</span>appId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">emptySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> watchedKeys <span class="token operator">=</span> <span class="token class-name">Sets</span><span class="token punctuation">.</span><span class="token function">newHashSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//watch specified cluster config change</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token class-name">ConfigConsts</span><span class="token punctuation">.</span><span class="token constant">CLUSTER_NAME_DEFAULT</span><span class="token punctuation">,</span> clusterName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        watchedKeys<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token function">generate</span><span class="token punctuation">(</span>appId<span class="token punctuation">,</span> clusterName<span class="token punctuation">,</span> namespace<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//watch data center config change</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">Strings</span><span class="token punctuation">.</span><span class="token function">isNullOrEmpty</span><span class="token punctuation">(</span>dataCenter<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>dataCenter<span class="token punctuation">,</span> clusterName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
     watchedKeys<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token function">generate</span><span class="token punctuation">(</span>appId<span class="token punctuation">,</span> dataCenter<span class="token punctuation">,</span> namespace<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//watch default cluster config change</span>
    watchedKeys<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token function">generate</span><span class="token punctuation">(</span>appId<span class="token punctuation">,</span> <span class="token class-name">ConfigConsts</span><span class="token punctuation">.</span><span class="token constant">CLUSTER_NAME_DEFAULT</span><span class="token punctuation">,</span> namespace<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> watchedKeys<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li>判断 namespaces 中，可能存在关联类型的 Namespace ，因此需要进一步处理。在这里的判断会比较“绕”，如果 namespaces 仅仅是 &quot;application&quot; 时，那么肯定不存在关联类型的 Namespace 。
<ul><li>调用 <code>#namespacesBelongToAppId(appId, namespaces)</code> 方法，获得属于该 App 的 Namespace 的名字的集合。<div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">namespacesBelongToAppId</span><span class="token punctuation">(</span><span class="token class-name">String</span> appId<span class="token punctuation">,</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> namespaces<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">ConfigConsts</span><span class="token punctuation">.</span><span class="token constant">NO_APPID_PLACEHOLDER</span><span class="token punctuation">.</span><span class="token function">equalsIgnoreCase</span><span class="token punctuation">(</span>appId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">emptySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AppNamespace</span><span class="token punctuation">&gt;</span></span> appNamespaces <span class="token operator">=</span> appNamespaceService<span class="token punctuation">.</span><span class="token function">findByAppIdAndNamespaces</span><span class="token punctuation">(</span>appId<span class="token punctuation">,</span> namespaces<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>appNamespaces <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> appNamespaces<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">emptySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> appNamespaces<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">AppNamespace</span><span class="token operator">::</span><span class="token function">getName</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li>通过 <code>Sets#difference(...)</code> 方法，进行集合差异计算，获得关联类型的 Namespace 的名字的集合。</li> <li>调用<code>#findPublicConfigWatchKeys(...)</code> 方法，获得关联类型的 Namespace 的名字的集合的 Watch Key Multimap ，并添加到结果集中。<div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token class-name">Multimap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">findPublicConfigWatchKeys</span><span class="token punctuation">(</span><span class="token class-name">String</span> applicationId<span class="token punctuation">,</span>
                                                     <span class="token class-name">String</span> clusterName<span class="token punctuation">,</span>
                                                     <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> namespaces<span class="token punctuation">,</span>
                                                     <span class="token class-name">String</span> dataCenter<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Multimap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> watchedKeysMap <span class="token operator">=</span> <span class="token class-name">HashMultimap</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AppNamespace</span><span class="token punctuation">&gt;</span></span> appNamespaces <span class="token operator">=</span> appNamespaceService<span class="token punctuation">.</span><span class="token function">findPublicNamespacesByNames</span><span class="token punctuation">(</span>namespaces<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">AppNamespace</span> appNamespace <span class="token operator">:</span> appNamespaces<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//check whether the namespace's appId equals to current one</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>applicationId<span class="token punctuation">,</span> appNamespace<span class="token punctuation">.</span><span class="token function">getAppId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

        <span class="token class-name">String</span> publicConfigAppId <span class="token operator">=</span> appNamespace<span class="token punctuation">.</span><span class="token function">getAppId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        watchedKeysMap<span class="token punctuation">.</span><span class="token function">putAll</span><span class="token punctuation">(</span>appNamespace<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token function">assembleWatchKeys</span><span class="token punctuation">(</span>publicConfigAppId<span class="token punctuation">,</span> clusterName<span class="token punctuation">,</span> appNamespace<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> dataCenter<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> watchedKeysMap<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div></li></ul></li></ol> <h2 id="entitymanagerutil"><a href="#entitymanagerutil" class="header-anchor">#</a> EntityManagerUtil</h2> <p><code>com.ctrip.framework.apollo.biz.utils.EntityManagerUtil</code> ，实现 <code>org.springframework.orm.jpa.EntityManagerFactoryAccessor</code> 抽象类，EntityManager 抽象类。代码如下：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">EntityManagerUtil</span> <span class="token keyword">extends</span> <span class="token class-name">EntityManagerFactoryAccessor</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Logger</span> logger <span class="token operator">=</span> <span class="token class-name">LoggerFactory</span><span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token class-name">EntityManagerUtil</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/**
    * close the entity manager.
    * Use it with caution! This is only intended for use with async request, which Spring won't
    * close the entity manager until the async request is finished.
    */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">closeEntityManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">EntityManagerHolder</span> emHolder <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">EntityManagerHolder</span><span class="token punctuation">)</span>
            <span class="token class-name">TransactionSynchronizationManager</span><span class="token punctuation">.</span><span class="token function">getResource</span><span class="token punctuation">(</span><span class="token function">getEntityManagerFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>emHolder <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Closing JPA EntityManager in EntityManagerUtil&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">EntityManagerFactoryUtils</span><span class="token punctuation">.</span><span class="token function">closeEntityManager</span><span class="token punctuation">(</span>emHolder<span class="token punctuation">.</span><span class="token function">getEntityManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/note/framework/apollo/adminservice-send-release-message.html" class="prev">
        Apollo源码分析——AdminService发布ReleaseMessage
      </a></span> <span class="next"><a href="/note/framework/apollo/configservice-query-api.html">
        Apollo源码分析——ConfigService配置查询
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/note/assets/js/app.e7654e9f.js" defer></script><script src="/note/assets/js/2.e810aa3c.js" defer></script><script src="/note/assets/js/1.07fc4d8c.js" defer></script><script src="/note/assets/js/74.026d5759.js" defer></script>
  </body>
</html>
