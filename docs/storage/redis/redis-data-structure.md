# Redis数据结构

## 简单动态字符串

* 常数复杂度获取字符串长度。
* 拒绝C字符串缓冲区溢出。
* 减少修改字符串时带来的内存重分配字数。使用空间预分配、惰性空间释放两种优化策略。
* 二进制安全。
* 兼容部分C字符串函数。

## 链表

* 双端：链表节点带有prev和next指针，获取某个节点的前置节点和后置节点的复杂度都是O（1）。
* 无环：表头节点的prev指针和表尾节点的next指针都指向NULL，对链表的访问以NULL为终点。
* 带表头指针和表尾指针：通过list结构的head指针和tail指针，程序获取链表的表头节点和表尾节点的复杂度为O（1）。
* 带链表长度计数器：程序使用list结构的len属性来对list持有的链表节点进行计数，程序获取链表中节点数量的复杂度为O（1）。
* 多态：链表节点使用void*指针来保存节点值，并且可以通过list结构的dup、free、match三个属性为节点值设置类型特定函数，所以链表可以用于保存各种不同类型的值。

## 字典

* 哈希表的实现类似HashMap，有一个table数组存储dictEntry，size属性存储字典大小（即table数组大小），used属性记录字典已有的键值对数量，sizemark属性总等于size-1，用来决定键值对应该放到table数组的哪个位置上。
* 字典基于哈希表实现，ht属性包含两个哈希表的数组，一般情况下只使用ht[0]，只有在对ht[0]rehash时才会使用ht[1]。rehashindex记录了目前rehash的进度，如果没有在进行rehash值为-1。
* 使用拉链法解决键的哈希冲突；为了插入效率，总是将新节点插入到链表的表头位置。
* 渐进式rehash。

## 跳跃表

* 跳跃表支持平均O（logN）、最坏O（N）复杂度的节点查找，还可以通过顺序性操作来批量处理节点。
* 跳跃表是有序集合的底层实现之一。
* Redis的跳跃表实现由zskiplist和zskiplistNode两个结构组成，其中zskiplist用于保存跳跃表信息（比如表头节点、表尾节点、长度），而zskiplistNode则用于表示跳跃表节点。
* 每个跳跃表节点的层高都是1至32之间的随机数。
* 在同一个跳跃表中，多个节点可以包含相同的分值，但每个节点的成员对象必须是唯一的。
* 跳跃表中的节点按照分值大小进行排序，当分值相同时，节点按照成员对象的大小进行排序。

## 整数集合

* 整数集合（intset）是集合键的底层实现之一，当一个集合只包含整数值元素，并且这个集合的元素数量不多时，Redis就会使用整数集合作为集合键的底层实现。
* 整数集合（intset）是Redis用于保存整数值的集合抽象数据结构，它可以保存类型为int16_t、int32_t或者int64_t的整数值，并且保证集合中不会出现重复元素。
* 每当要将一个新元素添加到整数集合里面，并且新元素的类型比整数集合现有所有元素的类型都要长时，整数集合需要先进行升级，然后才能将新元素添加到整数集合里面。
* 整数集合的升级策略有两个好处，一个是提升整数集合的灵活性，另一个是尽可能地节约内存。
* 整数集合不支持降级操作，一旦对数组进行了升级，编码就会一直保持升级后的状态。

## 压缩列表

* 压缩列表是一种为节约内存而开发的顺序型数据结构。
* 压缩列表被用作列表键和哈希键的底层实现之一。
* 压缩列表可以包含多个节点，每个节点可以保存一个字节数组或者整数值。
* 添加新节点到压缩列表，或者从压缩列表中删除节点，可能会引发连锁更新操作，但这种操作出现的几率并不高。

# 对象

Redis没有直接使用上述数据结构，而是基于这些数据结构创建了一个对象系统，这个系统包含字符串对象、列表对象、哈希对象、集合对象和有序集合对象这五种类型的对象，每种对象都用到了至少一种我们前面所介绍的数据结构。

通过这五种不同类型的对象，Redis可以在执行命令之前，根据对象的类型来判断一个对象是否可以执行给定的命令。使用对象的另一个好处是，我们可以针对不同的使用场景，为对象设置多种不同的数据结构实现，从而优化对象在不同场景下的使用效率。

除此之外，Redis的对象系统还实现了基于引用计数技术的内存回收机制，当程序不再使用某个对象的时候，这个对象所占用的内存就会被自动释放；另外，Redis还通过引用计数技术实现了对象共享机制，这一机制可以在适当的条件下，通过让多个数据库键共享同一个对象来节约内存。

最后，Redis的对象带有访问时间记录信息，该信息可以用于计算数据库键的空转时长，在服务器启用了maxmemory功能的情况下，空转时长较大的那些键可能会优先被服务器删除。

## 对象的类型与编码

Redis中对象包括：

* `REDIS_STRING`：字符串对象。
* `REDIS_LIST`：链表对象。
* `REDIS_HASH`：哈希对象。
* `REDIS_SET`：集合对象。
* `REDIS_ZSET`：有序集合对象。

Redis中编码包括：

* `REDIS_ENCODING_INT`：long类型的整数。
* `REDIS_ENCODING_EMBSTR`：embstr编码的简单动态字符串。
* `REDIS_ENCODING_RAW`：简单动态字符串。
* `REDIS_ENCODING_HT`：字典。
* `REDIS_ENCODING_LINKEDLIST`：双端链表。
* `REDIS_ENCODING_ZIPLIST`：压缩列表。
* `REDIS_ENCODING_INTSET`：整数集合。
* `REDIS_ENCODING_SKIPLIST`：跳跃表和字典。

每种类型的对象都至少使用了两种类型的编码。

* `REDIS_STRING`使用了`REDIS_ENCODING_INT`、`REDIS_ENCODING_EMBSTR`、`REDIS_ENCODING_RAW`。
* `REDIS_LIST`使用了`REDIS_ENCODING_ZIPLIST`、`REDIS_ENCODING_LINKEDLIST`。
* `REDIS_HASH`使用了`REDIS_ENCODING_ZIPLIST`、`REDIS_ENCODING_HT`。
* `REDIS_SET`使用了`REDIS_ENCODING_INTSET`、`REDIS_ENCODING_HT`。
* `REDIS_ZSET`使用了`REDIS_ENCODING_ZIPLIST`、`REDIS_ENCODING_SKIPLIST`。

## 内存回收

Redis在自己的对象系统中构建了一个使用引用计数的内存回收机制。每个对象的引用计数信息存储在redisObject结构的refcount属性中。

引用计数属性还可以实现对象共享。Redis在初始化服务器时会创建一万个字符串对象，包含从0到9999的所有整数值。类似于Java中Integer的缓存。

## 对象的空转时间

redisObject结构包含一个lru属性，记录对象最后一次被命令程序访问的时间。