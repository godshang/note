<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>数据库分库分表 | 开发者笔记</title>
    <meta name="generator" content="VuePress 1.9.10">
    
    <meta name="description" content="">
    
    <link rel="preload" href="/note/assets/css/0.styles.fa566ad0.css" as="style"><link rel="preload" href="/note/assets/js/app.fe0ed53e.js" as="script"><link rel="preload" href="/note/assets/js/2.7b239f4c.js" as="script"><link rel="preload" href="/note/assets/js/1.51e4995c.js" as="script"><link rel="preload" href="/note/assets/js/34.e1b481dc.js" as="script"><link rel="prefetch" href="/note/assets/js/10.555b32ff.js"><link rel="prefetch" href="/note/assets/js/100.923d2cb5.js"><link rel="prefetch" href="/note/assets/js/101.1b10aa6b.js"><link rel="prefetch" href="/note/assets/js/102.519481ff.js"><link rel="prefetch" href="/note/assets/js/103.93f3de8d.js"><link rel="prefetch" href="/note/assets/js/104.5f17bec9.js"><link rel="prefetch" href="/note/assets/js/105.22c71f14.js"><link rel="prefetch" href="/note/assets/js/106.7aca8b70.js"><link rel="prefetch" href="/note/assets/js/107.a1b34675.js"><link rel="prefetch" href="/note/assets/js/108.3dc6e794.js"><link rel="prefetch" href="/note/assets/js/109.97ce641d.js"><link rel="prefetch" href="/note/assets/js/11.fd20f755.js"><link rel="prefetch" href="/note/assets/js/110.ed78ce1a.js"><link rel="prefetch" href="/note/assets/js/111.81bf4714.js"><link rel="prefetch" href="/note/assets/js/112.916871fd.js"><link rel="prefetch" href="/note/assets/js/113.3e03ceee.js"><link rel="prefetch" href="/note/assets/js/114.a044d982.js"><link rel="prefetch" href="/note/assets/js/115.3804ad48.js"><link rel="prefetch" href="/note/assets/js/116.8f6f44ad.js"><link rel="prefetch" href="/note/assets/js/117.e215e63e.js"><link rel="prefetch" href="/note/assets/js/118.dfeb9e88.js"><link rel="prefetch" href="/note/assets/js/119.466009e4.js"><link rel="prefetch" href="/note/assets/js/12.3ad661be.js"><link rel="prefetch" href="/note/assets/js/120.77bd5754.js"><link rel="prefetch" href="/note/assets/js/121.04ff5c2a.js"><link rel="prefetch" href="/note/assets/js/13.0bb3a7d0.js"><link rel="prefetch" href="/note/assets/js/14.f9046e47.js"><link rel="prefetch" href="/note/assets/js/15.3af5a383.js"><link rel="prefetch" href="/note/assets/js/16.c8d9f254.js"><link rel="prefetch" href="/note/assets/js/17.71204e89.js"><link rel="prefetch" href="/note/assets/js/18.831fa1a4.js"><link rel="prefetch" href="/note/assets/js/19.a6dff0f2.js"><link rel="prefetch" href="/note/assets/js/20.611906c5.js"><link rel="prefetch" href="/note/assets/js/21.8da184a7.js"><link rel="prefetch" href="/note/assets/js/22.c52856f3.js"><link rel="prefetch" href="/note/assets/js/23.700dac36.js"><link rel="prefetch" href="/note/assets/js/24.69ce0e0c.js"><link rel="prefetch" href="/note/assets/js/25.0730c414.js"><link rel="prefetch" href="/note/assets/js/26.0dc2f351.js"><link rel="prefetch" href="/note/assets/js/27.b67f9ce5.js"><link rel="prefetch" href="/note/assets/js/28.1b0ec007.js"><link rel="prefetch" href="/note/assets/js/29.fd8012dc.js"><link rel="prefetch" href="/note/assets/js/3.922513d5.js"><link rel="prefetch" href="/note/assets/js/30.eb83510f.js"><link rel="prefetch" href="/note/assets/js/31.2eff891a.js"><link rel="prefetch" href="/note/assets/js/32.1ca7680c.js"><link rel="prefetch" href="/note/assets/js/33.e23bb18b.js"><link rel="prefetch" href="/note/assets/js/35.f46213e9.js"><link rel="prefetch" href="/note/assets/js/36.a5e42658.js"><link rel="prefetch" href="/note/assets/js/37.0f540e46.js"><link rel="prefetch" href="/note/assets/js/38.b372cea4.js"><link rel="prefetch" href="/note/assets/js/39.95b7b6ef.js"><link rel="prefetch" href="/note/assets/js/4.7f32a226.js"><link rel="prefetch" href="/note/assets/js/40.aacc67a1.js"><link rel="prefetch" href="/note/assets/js/41.baa508be.js"><link rel="prefetch" href="/note/assets/js/42.adae8cbf.js"><link rel="prefetch" href="/note/assets/js/43.895ef36a.js"><link rel="prefetch" href="/note/assets/js/44.bbb4481a.js"><link rel="prefetch" href="/note/assets/js/45.cbf322f4.js"><link rel="prefetch" href="/note/assets/js/46.68e5a9a5.js"><link rel="prefetch" href="/note/assets/js/47.3fddf95f.js"><link rel="prefetch" href="/note/assets/js/48.92c8b712.js"><link rel="prefetch" href="/note/assets/js/49.4c802eef.js"><link rel="prefetch" href="/note/assets/js/5.27e38e77.js"><link rel="prefetch" href="/note/assets/js/50.36092570.js"><link rel="prefetch" href="/note/assets/js/51.1113abd3.js"><link rel="prefetch" href="/note/assets/js/52.b9a2d2d1.js"><link rel="prefetch" href="/note/assets/js/53.7dc6c9ae.js"><link rel="prefetch" href="/note/assets/js/54.e1fa1251.js"><link rel="prefetch" href="/note/assets/js/55.3b47207f.js"><link rel="prefetch" href="/note/assets/js/56.e2fa0521.js"><link rel="prefetch" href="/note/assets/js/57.efe7b9d7.js"><link rel="prefetch" href="/note/assets/js/58.91a3fbe0.js"><link rel="prefetch" href="/note/assets/js/59.759256fb.js"><link rel="prefetch" href="/note/assets/js/6.eeaf7e02.js"><link rel="prefetch" href="/note/assets/js/60.63a865bc.js"><link rel="prefetch" href="/note/assets/js/61.6ea99453.js"><link rel="prefetch" href="/note/assets/js/62.92a1deae.js"><link rel="prefetch" href="/note/assets/js/63.f0f2e8ba.js"><link rel="prefetch" href="/note/assets/js/64.66ca54af.js"><link rel="prefetch" href="/note/assets/js/65.d7a5fccb.js"><link rel="prefetch" href="/note/assets/js/66.6fd1421d.js"><link rel="prefetch" href="/note/assets/js/67.ba2be8c2.js"><link rel="prefetch" href="/note/assets/js/68.73dd8a54.js"><link rel="prefetch" href="/note/assets/js/69.01ef0cca.js"><link rel="prefetch" href="/note/assets/js/7.97a5d920.js"><link rel="prefetch" href="/note/assets/js/70.c0e7f26a.js"><link rel="prefetch" href="/note/assets/js/71.6e8cf6b2.js"><link rel="prefetch" href="/note/assets/js/72.f93545c3.js"><link rel="prefetch" href="/note/assets/js/73.65ede5b3.js"><link rel="prefetch" href="/note/assets/js/74.221a3475.js"><link rel="prefetch" href="/note/assets/js/75.4f15972e.js"><link rel="prefetch" href="/note/assets/js/76.db77aaf5.js"><link rel="prefetch" href="/note/assets/js/77.57d30a26.js"><link rel="prefetch" href="/note/assets/js/78.67ade579.js"><link rel="prefetch" href="/note/assets/js/79.d209365a.js"><link rel="prefetch" href="/note/assets/js/80.3676f009.js"><link rel="prefetch" href="/note/assets/js/81.de92044c.js"><link rel="prefetch" href="/note/assets/js/82.807d0fc1.js"><link rel="prefetch" href="/note/assets/js/83.41ad2d0d.js"><link rel="prefetch" href="/note/assets/js/84.09cc5bde.js"><link rel="prefetch" href="/note/assets/js/85.5452bba4.js"><link rel="prefetch" href="/note/assets/js/86.59edb859.js"><link rel="prefetch" href="/note/assets/js/87.382dd4a3.js"><link rel="prefetch" href="/note/assets/js/88.a715c97d.js"><link rel="prefetch" href="/note/assets/js/89.c8360788.js"><link rel="prefetch" href="/note/assets/js/90.130359da.js"><link rel="prefetch" href="/note/assets/js/91.e3275599.js"><link rel="prefetch" href="/note/assets/js/92.393dd45a.js"><link rel="prefetch" href="/note/assets/js/93.33847c52.js"><link rel="prefetch" href="/note/assets/js/94.d8033e92.js"><link rel="prefetch" href="/note/assets/js/95.5bd3b80e.js"><link rel="prefetch" href="/note/assets/js/96.50504acf.js"><link rel="prefetch" href="/note/assets/js/97.636b17d3.js"><link rel="prefetch" href="/note/assets/js/98.1801094c.js"><link rel="prefetch" href="/note/assets/js/99.88e5b949.js"><link rel="prefetch" href="/note/assets/js/vendors~docsearch.69e677f0.js">
    <link rel="stylesheet" href="/note/assets/css/0.styles.fa566ad0.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/note/" class="home-link router-link-active"><!----> <span class="site-name">开发者笔记</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/note/" class="nav-link">
  Home
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Java" class="dropdown-title"><span class="title">Java</span> <span class="arrow down"></span></button> <button type="button" aria-label="Java" class="mobile-dropdown-title"><span class="title">Java</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/note/java/base/basic.html" class="nav-link">
  Java基础
</a></li><li class="dropdown-item"><!----> <a href="/note/java/collection/ArrayList.html" class="nav-link">
  Java集合框架
</a></li><li class="dropdown-item"><!----> <a href="/note/java/concurrent/Theory.html" class="nav-link">
  Java并发编程
</a></li><li class="dropdown-item"><!----> <a href="/note/java/jvm/memory.html" class="nav-link">
  JVM相关
</a></li><li class="dropdown-item"><!----> <a href="/note/java/nio/io.html" class="nav-link">
  Java NIO相关
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="数据存储" class="dropdown-title"><span class="title">数据存储</span> <span class="arrow down"></span></button> <button type="button" aria-label="数据存储" class="mobile-dropdown-title"><span class="title">数据存储</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/note/storage/database/mysql.html" class="nav-link">
  MySQL
</a></li><li class="dropdown-item"><!----> <a href="/note/storage/redis/redis-question.html" class="nav-link">
  Redis
</a></li><li class="dropdown-item"><!----> <a href="/note/storage/mq/kafka-intro.html" class="nav-link">
  消息队列
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="框架" class="dropdown-title"><span class="title">框架</span> <span class="arrow down"></span></button> <button type="button" aria-label="框架" class="mobile-dropdown-title"><span class="title">框架</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/note/framework/spring-framework/spring-framework-intro.html" class="nav-link">
  Spring框架
</a></li><li class="dropdown-item"><!----> <a href="/note/framework/netty/netty-business-logic.html" class="nav-link">
  Netty
</a></li><li class="dropdown-item"><!----> <a href="/note/framework/apollo/setup-debug-enviroment.html" class="nav-link">
  Apollo源码分析
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="架构" class="dropdown-title"><span class="title">架构</span> <span class="arrow down"></span></button> <button type="button" aria-label="架构" class="mobile-dropdown-title"><span class="title">架构</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/note/arch/system-design/01-scale-from-zero.html" class="nav-link">
  系统设计
</a></li><li class="dropdown-item"><!----> <a href="/note/arch/case-study/rate-limiter.html" class="nav-link">
  案例
</a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/note/" class="nav-link">
  Home
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Java" class="dropdown-title"><span class="title">Java</span> <span class="arrow down"></span></button> <button type="button" aria-label="Java" class="mobile-dropdown-title"><span class="title">Java</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/note/java/base/basic.html" class="nav-link">
  Java基础
</a></li><li class="dropdown-item"><!----> <a href="/note/java/collection/ArrayList.html" class="nav-link">
  Java集合框架
</a></li><li class="dropdown-item"><!----> <a href="/note/java/concurrent/Theory.html" class="nav-link">
  Java并发编程
</a></li><li class="dropdown-item"><!----> <a href="/note/java/jvm/memory.html" class="nav-link">
  JVM相关
</a></li><li class="dropdown-item"><!----> <a href="/note/java/nio/io.html" class="nav-link">
  Java NIO相关
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="数据存储" class="dropdown-title"><span class="title">数据存储</span> <span class="arrow down"></span></button> <button type="button" aria-label="数据存储" class="mobile-dropdown-title"><span class="title">数据存储</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/note/storage/database/mysql.html" class="nav-link">
  MySQL
</a></li><li class="dropdown-item"><!----> <a href="/note/storage/redis/redis-question.html" class="nav-link">
  Redis
</a></li><li class="dropdown-item"><!----> <a href="/note/storage/mq/kafka-intro.html" class="nav-link">
  消息队列
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="框架" class="dropdown-title"><span class="title">框架</span> <span class="arrow down"></span></button> <button type="button" aria-label="框架" class="mobile-dropdown-title"><span class="title">框架</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/note/framework/spring-framework/spring-framework-intro.html" class="nav-link">
  Spring框架
</a></li><li class="dropdown-item"><!----> <a href="/note/framework/netty/netty-business-logic.html" class="nav-link">
  Netty
</a></li><li class="dropdown-item"><!----> <a href="/note/framework/apollo/setup-debug-enviroment.html" class="nav-link">
  Apollo源码分析
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="架构" class="dropdown-title"><span class="title">架构</span> <span class="arrow down"></span></button> <button type="button" aria-label="架构" class="mobile-dropdown-title"><span class="title">架构</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/note/arch/system-design/01-scale-from-zero.html" class="nav-link">
  系统设计
</a></li><li class="dropdown-item"><!----> <a href="/note/arch/case-study/rate-limiter.html" class="nav-link">
  案例
</a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>数据库</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/note/storage/database/mysql.html" class="sidebar-link">MySQL常见问题</a></li><li><a href="/note/storage/database/shard.html" aria-current="page" class="active sidebar-link">分库分表</a></li><li><a href="/note/storage/database/db-index.html" class="sidebar-link">索引</a></li><li><a href="/note/storage/database/transaction.html" class="sidebar-link">事务</a></li><li><a href="/note/storage/database/acid.html" class="sidebar-link">事务ACID的实现原理</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="数据库分库分表"><a href="#数据库分库分表" class="header-anchor">#</a> 数据库分库分表</h1> <h2 id="为什么要分库分表-设计高并发系统的时候-数据库层面该如何设计"><a href="#为什么要分库分表-设计高并发系统的时候-数据库层面该如何设计" class="header-anchor">#</a> 为什么要分库分表？（设计高并发系统的时候，数据库层面该如何设计？）</h2> <p>说白了，分库分表是两回事儿，大家可别搞混了，可能是光分库不分表，也可能是光分表不分库，都有可能。</p> <p>我先给大家抛出来一个场景。</p> <p>假如我们现在是一个小创业公司（或者是一个 BAT 公司刚兴起的一个新部门），现在注册用户就 20 万，每天活跃用户就 1 万，每天单表数据量就 1000，然后高峰期每秒钟并发请求最多就 10 个。我的天，就这种系统，随便找一个有几年工作经验的，然后带几个刚培训出来的，随便干干都可以。</p> <p>结果没想到我们运气居然这么好，碰上个 CEO 带着我们走上了康庄大道，业务发展迅猛，过了几个月，注册用户数达到了 2000 万！每天活跃用户数 100 万！每天单表数据量 10 万条！高峰期每秒最大请求达到 1000！同时公司还顺带着融资了两轮，进账了几个亿人民币啊！公司估值达到了惊人的几亿美金！这是小独角兽的节奏！</p> <p>好吧，没事，现在大家感觉压力已经有点大了，为啥呢？因为每天多 10 万条数据，一个月就多 300 万条数据，现在咱们单表已经几百万数据了，马上就破千万了。但是勉强还能撑着。高峰期请求现在是 1000，咱们线上部署了几台机器，负载均衡搞了一下，数据库撑 1000QPS 也还凑合。但是大家现在开始感觉有点担心了，接下来咋整呢......</p> <p>再接下来几个月，我的天，CEO 太牛逼了，公司用户数已经达到 1 亿，公司继续融资几十亿人民币啊！公司估值达到了惊人的几十亿美金，成为了国内今年最牛逼的明星创业公司！天，我们太幸运了。</p> <p>但是我们同时也是不幸的，因为此时每天活跃用户数上千万，每天单表新增数据多达 50 万，目前一个表总数据量都已经达到了两三千万了！扛不住啊！数据库磁盘容量不断消耗掉！高峰期并发达到惊人的 <code>5000~8000</code> ！别开玩笑了，哥。我跟你保证，你的系统支撑不到现在，已经挂掉了！</p> <p>好吧，所以你看到这里差不多就理解分库分表是怎么回事儿了，实际上这是跟着你的公司业务发展走的，你公司业务发展越好，用户就越多，数据量越大，请求量越大，那你单个数据库一定扛不住。</p> <h3 id="分表"><a href="#分表" class="header-anchor">#</a> 分表</h3> <p>比如你单表都几千万数据了，你确定你能扛住么？绝对不行，<strong>单表数据量太大</strong>，会极大影响你的 sql <strong>执行的性能</strong>，到了后面你的 sql 可能就跑的很慢了。一般来说，就以我的经验来看，单表到几百万的时候，性能就会相对差一些了，你就得分表了。</p> <p>分表是啥意思？就是把一个表的数据放到多个表中，然后查询的时候你就查一个表。比如按照用户 id 来分表，将一个用户的数据就放在一个表中。然后操作的时候你对一个用户就操作那个表就好了。这样可以控制每个表的数据量在可控的范围内，比如每个表就固定在 200 万以内。</p> <h3 id="分库"><a href="#分库" class="header-anchor">#</a> 分库</h3> <p>分库是啥意思？就是你一个库一般我们经验而言，最多支撑到并发 2000，一定要扩容了，而且一个健康的单库并发值你最好保持在每秒 1000 左右，不要太大。那么你可以将一个库的数据拆分到多个库中，访问的时候就访问一个库好了。</p> <p>这就是所谓的<strong>分库分表</strong>，为啥要分库分表？你明白了吧。</p> <table><thead><tr><th>#</th> <th>分库分表前</th> <th>分库分表后</th></tr></thead> <tbody><tr><td>并发支撑情况</td> <td>MySQL 单机部署，扛不住高并发</td> <td>MySQL 从单机到多机，能承受的并发增加了多倍</td></tr> <tr><td>磁盘使用情况</td> <td>MySQL 单机磁盘容量几乎撑满</td> <td>拆分为多个库，数据库服务器磁盘使用率大大降低</td></tr> <tr><td>SQL 执行性能</td> <td>单表数据量太大，SQL 越跑越慢</td> <td>单表数据量减少，SQL 执行效率明显提升</td></tr></tbody></table> <h2 id="用过哪些分库分表中间件-不同的分库分表中间件都有什么优点和缺点"><a href="#用过哪些分库分表中间件-不同的分库分表中间件都有什么优点和缺点" class="header-anchor">#</a> 用过哪些分库分表中间件？不同的分库分表中间件都有什么优点和缺点？</h2> <p>这个其实就是看看你了解哪些分库分表的中间件，各个中间件的优缺点是啥？然后你用过哪些分库分表的中间件。</p> <p>比较常见的包括：</p> <ul><li>Cobar</li> <li>TDDL</li> <li>Atlas</li> <li>Sharding-jdbc</li> <li>Mycat</li></ul> <h3 id="cobar"><a href="#cobar" class="header-anchor">#</a> Cobar</h3> <p>阿里 b2b 团队开发和开源的，属于 proxy 层方案，就是介于应用服务器和数据库服务器之间。应用程序通过 JDBC 驱动访问 Cobar 集群，Cobar 根据 SQL 和分库规则对 SQL 做分解，然后分发到 MySQL 集群不同的数据库实例上执行。早些年还可以用，但是最近几年都没更新了，基本没啥人用，差不多算是被抛弃的状态吧。而且不支持读写分离、存储过程、跨库 join 和分页等操作。</p> <h3 id="tddl"><a href="#tddl" class="header-anchor">#</a> TDDL</h3> <p>淘宝团队开发的，属于 client 层方案。支持基本的 crud 语法和读写分离，但不支持 join、多表查询等语法。目前使用的也不多，因为还依赖淘宝的 diamond 配置管理系统。</p> <h3 id="atlas"><a href="#atlas" class="header-anchor">#</a> Atlas</h3> <p>360 开源的，属于 proxy 层方案，以前是有一些公司在用的，但是确实有一个很大的问题就是社区最新的维护都在 5 年前了。所以，现在用的公司基本也很少了。</p> <h3 id="sharding-jdbc"><a href="#sharding-jdbc" class="header-anchor">#</a> Sharding-jdbc</h3> <p>当当开源的，属于 client 层方案，是<a href="https://shardingsphere.apache.org" target="_blank" rel="noopener noreferrer"><code>ShardingSphere</code> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>的 client 层方案，<a href="https://shardingsphere.apache.org" target="_blank" rel="noopener noreferrer"><code>ShardingSphere</code> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>还提供 proxy 层的方案 Sharding-Proxy。确实之前用的还比较多一些，因为 SQL 语法支持也比较多，没有太多限制，而且截至 2019.4，已经推出到了 <code>4.0.0-RC1</code> 版本，支持分库分表、读写分离、分布式 id 生成、柔性事务（最大努力送达型事务、TCC 事务）。而且确实之前使用的公司会比较多一些（这个在官网有登记使用的公司，可以看到从 2017 年一直到现在，是有不少公司在用的），目前社区也还一直在开发和维护，还算是比较活跃，个人认为算是一个现在也<strong>可以选择的方案</strong>。</p> <h3 id="mycat"><a href="#mycat" class="header-anchor">#</a> Mycat</h3> <p>基于 Cobar 改造的，属于 proxy 层方案，支持的功能非常完善，而且目前应该是非常火的而且不断流行的数据库中间件，社区很活跃，也有一些公司开始在用了。但是确实相比于 Sharding jdbc 来说，年轻一些，经历的锤炼少一些。</p> <h3 id="总结"><a href="#总结" class="header-anchor">#</a> 总结</h3> <p>综上，现在其实建议考量的，就是 Sharding-jdbc 和 Mycat，这两个都可以去考虑使用。</p> <p>Sharding-jdbc 这种 client 层方案的<strong>优点在于不用部署，运维成本低，不需要代理层的二次转发请求，性能很高</strong>，但是如果遇到升级啥的需要各个系统都重新升级版本再发布，各个系统都需要<strong>耦合</strong> Sharding-jdbc 的依赖；</p> <p>Mycat 这种 proxy 层方案的<strong>缺点在于需要部署</strong>，自己运维一套中间件，运维成本高，但是<strong>好处在于对于各个项目是透明的</strong>，如果遇到升级之类的都是自己中间件那里搞就行了。</p> <p>通常来说，这两个方案其实都可以选用，但是我个人建议中小型公司选用 Sharding-jdbc，client 层方案轻便，而且维护成本低，不需要额外增派人手，而且中小型公司系统复杂度会低一些，项目也没那么多；但是中大型公司最好还是选用 Mycat 这类 proxy 层方案，因为可能大公司系统和项目非常多，团队很大，人员充足，那么最好是专门弄个人来研究和维护 Mycat，然后大量项目直接透明使用即可。</p> <h2 id="你们具体是如何对数据库如何进行垂直拆分或水平拆分的"><a href="#你们具体是如何对数据库如何进行垂直拆分或水平拆分的" class="header-anchor">#</a> 你们具体是如何对数据库如何进行垂直拆分或水平拆分的？</h2> <p>水平拆分的意思，就是把一个表的数据给弄到多个库的多个表里去，但是每个库的表结构都一样，只不过每个库表放的数据是不同的，所有库表的数据加起来就是全部数据。水平拆分的意义，就是将数据均匀放更多的库里，然后用多个库来扛更高的并发，还有就是用多个库的存储容量来进行扩容。</p> <img src="data:image/png;base64,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"> <p>垂直拆分的意思，就是把一个有很多字段的表给拆分成多个表，或者是多个库上去。每个库表的结构都不一样，每个库表都包含部分字段。一般来说，会将较少的访问频率很高的字段放到一个表里去，然后将较多的访问频率很低的字段放到另外一个表里去。因为数据库是有缓存的，你访问频率高的行字段越少，就可以在缓存里缓存更多的行，性能就越好。这个一般在表层面做的较多一些。</p> <img src="data:image/png;base64,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"> <p>这个其实挺常见的，不一定我说，大家很多同学可能自己都做过，把一个大表拆开，订单表、订单支付表、订单商品表。</p> <p>好了，无论分库还是分表，上面说的那些数据库中间件都是可以支持的。就是基本上那些中间件可以做到你分库分表之后，中间件可以根据你指定的某个字段值，比如说 userid，自动路由到对应的库上去，然后再自动路由到对应的表里去。</p> <p>你就得考虑一下，你的项目里该如何分库分表？一般来说，垂直拆分，你可以在表层面来做，对一些字段特别多的表做一下拆分；水平拆分，你可以说是并发承载不了，或者是数据量太大，容量承载不了，你给拆了，按什么字段来拆，你自己想好；分表，你考虑一下，你如果哪怕是拆到每个库里去，并发和容量都 ok 了，但是每个库的表还是太大了，那么你就分表，将这个表分开，保证每个表的数据量并不是很大。</p> <p>而且这儿还有两种分库分表的方式：</p> <p>一种是按照 range 来分，就是每个库一段连续的数据，这个一般是按比如时间范围来的，但是这种一般较少用，因为很容易产生热点问题，大量的流量都打在最新的数据上了。
或者是按照某个字段 hash 一下均匀分散，这个较为常用。
range 来分，好处在于说，扩容的时候很简单，因为你只要预备好，给每个月都准备一个库就可以了，到了一个新的月份的时候，自然而然，就会写新的库了；缺点，但是大部分的请求，都是访问最新的数据。实际生产用 range，要看场景。</p> <p>hash 分发，好处在于说，可以平均分配每个库的数据量和请求压力；坏处在于说扩容起来比较麻烦，会有一个数据迁移的过程，之前的数据需要重新计算 hash 值重新分配到不同的库或表。</p> <h2 id="现在有一个未分库分表的系统-未来要分库分表-如何设计才可以让系统从未分库分表动态切换到分库分表上"><a href="#现在有一个未分库分表的系统-未来要分库分表-如何设计才可以让系统从未分库分表动态切换到分库分表上" class="header-anchor">#</a> 现在有一个未分库分表的系统，未来要分库分表，如何设计才可以让系统从未分库分表动态切换到分库分表上？</h2> <p>这个其实从 low 到高大上有好几种方案，我们都玩儿过，我都给你说一下。</p> <h3 id="停机迁移方案"><a href="#停机迁移方案" class="header-anchor">#</a> 停机迁移方案</h3> <p>我先给你说一个最 low 的方案，就是很简单，大家伙儿凌晨 12 点开始运维，网站或者 app 挂个公告，说 0 点到早上 6 点进行运维，无法访问。</p> <p>接着到 0 点停机，系统停掉，没有流量写入了，此时老的单库单表数据库静止了。然后你之前得写好一个导数的一次性工具，此时直接跑起来，然后将单库单表的数据哗哗哗读出来，写到分库分表里面去。</p> <p>导数完了之后，就 ok 了，修改系统的数据库连接配置啥的，包括可能代码和 SQL 也许有修改，那你就用最新的代码，然后直接启动连到新的分库分表上去。</p> <p>验证一下，ok 了，完美，大家伸个懒腰，看看看凌晨 4 点钟的北京夜景，打个滴滴回家吧。</p> <p>但是这个方案比较 low，谁都能干，我们来看看高大上一点的方案。</p> <img src="/note/assets/img/877369a71197ed1a6d933819739836f4.877369a7.png"> <h3 id="双写迁移方案"><a href="#双写迁移方案" class="header-anchor">#</a> 双写迁移方案</h3> <p>这个是我们常用的一种迁移方案，比较靠谱一些，不用停机，不用看北京凌晨 4 点的风景。</p> <p>简单来说，就是在线上系统里面，之前所有写库的地方，增删改操作，除了对老库增删改，都加上对新库的增删改，这就是所谓的双写，同时写俩库，老库和新库。</p> <p>然后系统部署之后，新库数据差太远，用之前说的导数工具，跑起来读老库数据写新库，写的时候要根据 gmt_modified 这类字段判断这条数据最后修改的时间，除非是读出来的数据在新库里没有，或者是比新库的数据新才会写。简单来说，就是不允许用老数据覆盖新数据。</p> <p>导完一轮之后，有可能数据还是存在不一致，那么就程序自动做一轮校验，比对新老库每个表的每条数据，接着如果有不一样的，就针对那些不一样的，从老库读数据再次写。反复循环，直到两个库每个表的数据都完全一致为止。</p> <p>接着当数据完全一致了，就 ok 了，基于仅仅使用分库分表的最新代码，重新部署一次，不就仅仅基于分库分表在操作了么，还没有几个小时的停机时间，很稳。所以现在基本玩儿数据迁移之类的，都是这么干的。</p> <img src="/note/assets/img/f763a270298c784f8299950daa458082.f763a270.png"> <h2 id="如何设计可以动态扩容缩容的分库分表方案"><a href="#如何设计可以动态扩容缩容的分库分表方案" class="header-anchor">#</a> 如何设计可以动态扩容缩容的分库分表方案？</h2> <p>对于分库分表来说，主要是面对以下问题：</p> <p>选择一个数据库中间件，调研、学习、测试；
设计你的分库分表的一个方案，你要分成多少个库，每个库分成多少个表，比如 3 个库，每个库 4 个表；
基于选择好的数据库中间件，以及在测试环境建立好的分库分表的环境，然后测试一下能否正常进行分库分表的读写；
完成单库单表到分库分表的迁移，双写方案；
线上系统开始基于分库分表对外提供服务；
扩容了，扩容成 6 个库，每个库需要 12 个表，你怎么来增加更多库和表呢？
这个是你必须面对的一个事儿，就是你已经弄好分库分表方案了，然后一堆库和表都建好了，基于分库分表中间件的代码开发啥的都好了，测试都 ok 了，数据能均匀分布到各个库和各个表里去，而且接着你还通过双写的方案咔嚓一下上了系统，已经直接基于分库分表方案在搞了。</p> <p>那么现在问题来了，你现在这些库和表又支撑不住了，要继续扩容咋办？这个可能就是说你的每个库的容量又快满了，或者是你的表数据量又太大了，也可能是你每个库的写并发太高了，你得继续扩容。</p> <p>这都是玩儿分库分表线上必须经历的事儿。</p> <h3 id="停机扩容-不推荐"><a href="#停机扩容-不推荐" class="header-anchor">#</a> 停机扩容（不推荐）</h3> <p>这个方案就跟停机迁移一样，步骤几乎一致，唯一的一点就是那个导数的工具，是把现有库表的数据抽出来慢慢倒入到新的库和表里去。但是最好别这么玩儿，有点不太靠谱，因为既然分库分表就说明数据量实在是太大了，可能多达几亿条，甚至几十亿，你这么玩儿，可能会出问题。</p> <p>从单库单表迁移到分库分表的时候，数据量并不是很大，单表最大也就两三千万。那么你写个工具，多弄几台机器并行跑，1 小时数据就导完了。这没有问题。</p> <p>如果 3 个库 + 12 个表，跑了一段时间了，数据量都 1~2 亿了。光是导 2 亿数据，都要导个几个小时，6 点，刚刚导完数据，还要搞后续的修改配置，重启系统，测试验证，10 点才可以搞完。所以不能这么搞。</p> <h3 id="优化后的方案"><a href="#优化后的方案" class="header-anchor">#</a> 优化后的方案</h3> <p>一开始上来就是 32 个库，每个库 32 个表，那么总共是 1024 张表。</p> <p>我可以告诉各位同学，这个分法，第一，基本上国内的互联网肯定都是够用了，第二，无论是并发支撑还是数据量支撑都没问题。</p> <p>每个库正常承载的写入并发量是 1000，那么 32 个库就可以承载 32 _ 1000 = 32000 的写并发，如果每个库承载 1500 的写并发，32 _ 1500 = 48000 的写并发，接近 5 万每秒的写入并发，前面再加一个 MQ，削峰，每秒写入 MQ 8 万条数据，每秒消费 5 万条数据。</p> <p>有些除非是国内排名非常靠前的这些公司，他们的最核心的系统的数据库，可能会出现几百台数据库的这么一个规模，128 个库，256 个库，512 个库。</p> <p>1024 张表，假设每个表放 500 万数据，在 MySQL 里可以放 50 亿条数据。</p> <p>每秒 5 万的写并发，总共 50 亿条数据，对于国内大部分的互联网公司来说，其实一般来说都够了。</p> <p>谈分库分表的扩容，<strong>第一次分库分表，就一次性给他分个够</strong>，32 个库，1024 张表，可能对大部分的中小型互联网公司来说，已经可以支撑好几年了。</p> <p>一个实践是利用 <code>32 * 32</code> 来分库分表，即分为 32 个库，每个库里一个表分为 32 张表。一共就是 1024 张表。根据某个 id 先根据 32 取模路由到库，再根据 32 取模路由到库里的表。</p> <table><thead><tr><th>orderId</th> <th>id % 32 (库)</th> <th>id / 32 % 32 (表)</th></tr></thead> <tbody><tr><td>259</td> <td>3</td> <td>8</td></tr> <tr><td>1189</td> <td>5</td> <td>5</td></tr> <tr><td>352</td> <td>0</td> <td>11</td></tr> <tr><td>4593</td> <td>17</td> <td>15</td></tr></tbody></table> <p>刚开始的时候，这个库可能就是逻辑库，建在一个数据库上的，就是一个 MySQL 服务器可能建了 n 个库，比如 32 个库。后面如果要拆分，就是不断在库和 MySQL 服务器之间做迁移就可以了。然后系统配合改一下配置即可。</p> <p>比如说最多可以扩展到 32 个数据库服务器，每个数据库服务器是一个库。如果还是不够？最多可以扩展到 1024 个数据库服务器，每个数据库服务器上面一个库一个表。因为最多是 1024 个表。</p> <p>这么搞，是不用自己写代码做数据迁移的，都交给 DBA 来搞好了，但是 DBA 确实是需要做一些库表迁移的工作，但是总比你自己写代码，然后抽数据导数据来的效率高得多吧。</p> <p>哪怕是要减少库的数量，也很简单，其实说白了就是按倍数缩容就可以了，然后修改一下路由规则。</p> <p>这里对步骤做一个总结：</p> <ol><li>设定好几台数据库服务器，每台服务器上几个库，每个库多少个表，推荐是 32 库 * 32 表，对于大部分公司来说，可能几年都够了。</li> <li>路由的规则，orderId 模 32 = 库，orderId / 32 模 32 = 表</li> <li>扩容的时候，申请增加更多的数据库服务器，装好 MySQL，呈倍数扩容，4 台服务器，扩到 8 台服务器，再到 16 台服务器。</li> <li>由 DBA 负责将原先数据库服务器的库，迁移到新的数据库服务器上去，库迁移是有一些便捷的工具的。</li> <li>我们这边就是修改一下配置，调整迁移的库所在数据库服务器的地址。</li> <li>重新发布系统，上线，原先的路由规则变都不用变，直接可以基于 n 倍的数据库服务器的资源，继续进行线上系统的提供服务。</li></ol></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/note/storage/database/mysql.html" class="prev">
        MySQL常见问题
      </a></span> <span class="next"><a href="/note/storage/database/db-index.html">
        索引
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/note/assets/js/app.fe0ed53e.js" defer></script><script src="/note/assets/js/2.7b239f4c.js" defer></script><script src="/note/assets/js/1.51e4995c.js" defer></script><script src="/note/assets/js/34.e1b481dc.js" defer></script>
  </body>
</html>
