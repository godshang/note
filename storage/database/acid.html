<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>事务ACID特性的实现原理 | 开发者笔记</title>
    <meta name="generator" content="VuePress 1.9.10">
    
    <meta name="description" content="">
    
    <link rel="preload" href="/note/assets/css/0.styles.fa566ad0.css" as="style"><link rel="preload" href="/note/assets/js/app.fe0ed53e.js" as="script"><link rel="preload" href="/note/assets/js/2.7b239f4c.js" as="script"><link rel="preload" href="/note/assets/js/1.51e4995c.js" as="script"><link rel="preload" href="/note/assets/js/110.ed78ce1a.js" as="script"><link rel="prefetch" href="/note/assets/js/10.555b32ff.js"><link rel="prefetch" href="/note/assets/js/100.923d2cb5.js"><link rel="prefetch" href="/note/assets/js/101.1b10aa6b.js"><link rel="prefetch" href="/note/assets/js/102.519481ff.js"><link rel="prefetch" href="/note/assets/js/103.93f3de8d.js"><link rel="prefetch" href="/note/assets/js/104.5f17bec9.js"><link rel="prefetch" href="/note/assets/js/105.22c71f14.js"><link rel="prefetch" href="/note/assets/js/106.7aca8b70.js"><link rel="prefetch" href="/note/assets/js/107.a1b34675.js"><link rel="prefetch" href="/note/assets/js/108.3dc6e794.js"><link rel="prefetch" href="/note/assets/js/109.97ce641d.js"><link rel="prefetch" href="/note/assets/js/11.fd20f755.js"><link rel="prefetch" href="/note/assets/js/111.81bf4714.js"><link rel="prefetch" href="/note/assets/js/112.916871fd.js"><link rel="prefetch" href="/note/assets/js/113.3e03ceee.js"><link rel="prefetch" href="/note/assets/js/114.a044d982.js"><link rel="prefetch" href="/note/assets/js/115.3804ad48.js"><link rel="prefetch" href="/note/assets/js/116.8f6f44ad.js"><link rel="prefetch" href="/note/assets/js/117.e215e63e.js"><link rel="prefetch" href="/note/assets/js/118.dfeb9e88.js"><link rel="prefetch" href="/note/assets/js/119.466009e4.js"><link rel="prefetch" href="/note/assets/js/12.3ad661be.js"><link rel="prefetch" href="/note/assets/js/120.77bd5754.js"><link rel="prefetch" href="/note/assets/js/121.04ff5c2a.js"><link rel="prefetch" href="/note/assets/js/13.0bb3a7d0.js"><link rel="prefetch" href="/note/assets/js/14.f9046e47.js"><link rel="prefetch" href="/note/assets/js/15.3af5a383.js"><link rel="prefetch" href="/note/assets/js/16.c8d9f254.js"><link rel="prefetch" href="/note/assets/js/17.71204e89.js"><link rel="prefetch" href="/note/assets/js/18.831fa1a4.js"><link rel="prefetch" href="/note/assets/js/19.a6dff0f2.js"><link rel="prefetch" href="/note/assets/js/20.611906c5.js"><link rel="prefetch" href="/note/assets/js/21.8da184a7.js"><link rel="prefetch" href="/note/assets/js/22.c52856f3.js"><link rel="prefetch" href="/note/assets/js/23.700dac36.js"><link rel="prefetch" href="/note/assets/js/24.69ce0e0c.js"><link rel="prefetch" href="/note/assets/js/25.0730c414.js"><link rel="prefetch" href="/note/assets/js/26.0dc2f351.js"><link rel="prefetch" href="/note/assets/js/27.b67f9ce5.js"><link rel="prefetch" href="/note/assets/js/28.1b0ec007.js"><link rel="prefetch" href="/note/assets/js/29.fd8012dc.js"><link rel="prefetch" href="/note/assets/js/3.922513d5.js"><link rel="prefetch" href="/note/assets/js/30.eb83510f.js"><link rel="prefetch" href="/note/assets/js/31.2eff891a.js"><link rel="prefetch" href="/note/assets/js/32.1ca7680c.js"><link rel="prefetch" href="/note/assets/js/33.e23bb18b.js"><link rel="prefetch" href="/note/assets/js/34.e1b481dc.js"><link rel="prefetch" href="/note/assets/js/35.f46213e9.js"><link rel="prefetch" href="/note/assets/js/36.a5e42658.js"><link rel="prefetch" href="/note/assets/js/37.0f540e46.js"><link rel="prefetch" href="/note/assets/js/38.b372cea4.js"><link rel="prefetch" href="/note/assets/js/39.95b7b6ef.js"><link rel="prefetch" href="/note/assets/js/4.7f32a226.js"><link rel="prefetch" href="/note/assets/js/40.aacc67a1.js"><link rel="prefetch" href="/note/assets/js/41.baa508be.js"><link rel="prefetch" href="/note/assets/js/42.adae8cbf.js"><link rel="prefetch" href="/note/assets/js/43.895ef36a.js"><link rel="prefetch" href="/note/assets/js/44.bbb4481a.js"><link rel="prefetch" href="/note/assets/js/45.cbf322f4.js"><link rel="prefetch" href="/note/assets/js/46.68e5a9a5.js"><link rel="prefetch" href="/note/assets/js/47.3fddf95f.js"><link rel="prefetch" href="/note/assets/js/48.92c8b712.js"><link rel="prefetch" href="/note/assets/js/49.4c802eef.js"><link rel="prefetch" href="/note/assets/js/5.27e38e77.js"><link rel="prefetch" href="/note/assets/js/50.36092570.js"><link rel="prefetch" href="/note/assets/js/51.1113abd3.js"><link rel="prefetch" href="/note/assets/js/52.b9a2d2d1.js"><link rel="prefetch" href="/note/assets/js/53.7dc6c9ae.js"><link rel="prefetch" href="/note/assets/js/54.e1fa1251.js"><link rel="prefetch" href="/note/assets/js/55.3b47207f.js"><link rel="prefetch" href="/note/assets/js/56.e2fa0521.js"><link rel="prefetch" href="/note/assets/js/57.efe7b9d7.js"><link rel="prefetch" href="/note/assets/js/58.91a3fbe0.js"><link rel="prefetch" href="/note/assets/js/59.759256fb.js"><link rel="prefetch" href="/note/assets/js/6.eeaf7e02.js"><link rel="prefetch" href="/note/assets/js/60.63a865bc.js"><link rel="prefetch" href="/note/assets/js/61.6ea99453.js"><link rel="prefetch" href="/note/assets/js/62.92a1deae.js"><link rel="prefetch" href="/note/assets/js/63.f0f2e8ba.js"><link rel="prefetch" href="/note/assets/js/64.66ca54af.js"><link rel="prefetch" href="/note/assets/js/65.d7a5fccb.js"><link rel="prefetch" href="/note/assets/js/66.6fd1421d.js"><link rel="prefetch" href="/note/assets/js/67.ba2be8c2.js"><link rel="prefetch" href="/note/assets/js/68.73dd8a54.js"><link rel="prefetch" href="/note/assets/js/69.01ef0cca.js"><link rel="prefetch" href="/note/assets/js/7.97a5d920.js"><link rel="prefetch" href="/note/assets/js/70.c0e7f26a.js"><link rel="prefetch" href="/note/assets/js/71.6e8cf6b2.js"><link rel="prefetch" href="/note/assets/js/72.f93545c3.js"><link rel="prefetch" href="/note/assets/js/73.65ede5b3.js"><link rel="prefetch" href="/note/assets/js/74.221a3475.js"><link rel="prefetch" href="/note/assets/js/75.4f15972e.js"><link rel="prefetch" href="/note/assets/js/76.db77aaf5.js"><link rel="prefetch" href="/note/assets/js/77.57d30a26.js"><link rel="prefetch" href="/note/assets/js/78.67ade579.js"><link rel="prefetch" href="/note/assets/js/79.d209365a.js"><link rel="prefetch" href="/note/assets/js/80.3676f009.js"><link rel="prefetch" href="/note/assets/js/81.de92044c.js"><link rel="prefetch" href="/note/assets/js/82.807d0fc1.js"><link rel="prefetch" href="/note/assets/js/83.41ad2d0d.js"><link rel="prefetch" href="/note/assets/js/84.09cc5bde.js"><link rel="prefetch" href="/note/assets/js/85.5452bba4.js"><link rel="prefetch" href="/note/assets/js/86.59edb859.js"><link rel="prefetch" href="/note/assets/js/87.382dd4a3.js"><link rel="prefetch" href="/note/assets/js/88.a715c97d.js"><link rel="prefetch" href="/note/assets/js/89.c8360788.js"><link rel="prefetch" href="/note/assets/js/90.130359da.js"><link rel="prefetch" href="/note/assets/js/91.e3275599.js"><link rel="prefetch" href="/note/assets/js/92.393dd45a.js"><link rel="prefetch" href="/note/assets/js/93.33847c52.js"><link rel="prefetch" href="/note/assets/js/94.d8033e92.js"><link rel="prefetch" href="/note/assets/js/95.5bd3b80e.js"><link rel="prefetch" href="/note/assets/js/96.50504acf.js"><link rel="prefetch" href="/note/assets/js/97.636b17d3.js"><link rel="prefetch" href="/note/assets/js/98.1801094c.js"><link rel="prefetch" href="/note/assets/js/99.88e5b949.js"><link rel="prefetch" href="/note/assets/js/vendors~docsearch.69e677f0.js">
    <link rel="stylesheet" href="/note/assets/css/0.styles.fa566ad0.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/note/" class="home-link router-link-active"><!----> <span class="site-name">开发者笔记</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/note/" class="nav-link">
  Home
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Java" class="dropdown-title"><span class="title">Java</span> <span class="arrow down"></span></button> <button type="button" aria-label="Java" class="mobile-dropdown-title"><span class="title">Java</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/note/java/base/basic.html" class="nav-link">
  Java基础
</a></li><li class="dropdown-item"><!----> <a href="/note/java/collection/ArrayList.html" class="nav-link">
  Java集合框架
</a></li><li class="dropdown-item"><!----> <a href="/note/java/concurrent/Theory.html" class="nav-link">
  Java并发编程
</a></li><li class="dropdown-item"><!----> <a href="/note/java/jvm/memory.html" class="nav-link">
  JVM相关
</a></li><li class="dropdown-item"><!----> <a href="/note/java/nio/io.html" class="nav-link">
  Java NIO相关
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="数据存储" class="dropdown-title"><span class="title">数据存储</span> <span class="arrow down"></span></button> <button type="button" aria-label="数据存储" class="mobile-dropdown-title"><span class="title">数据存储</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/note/storage/database/mysql.html" class="nav-link">
  MySQL
</a></li><li class="dropdown-item"><!----> <a href="/note/storage/redis/redis-question.html" class="nav-link">
  Redis
</a></li><li class="dropdown-item"><!----> <a href="/note/storage/mq/kafka-intro.html" class="nav-link">
  消息队列
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="框架" class="dropdown-title"><span class="title">框架</span> <span class="arrow down"></span></button> <button type="button" aria-label="框架" class="mobile-dropdown-title"><span class="title">框架</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/note/framework/spring-framework/spring-framework-intro.html" class="nav-link">
  Spring框架
</a></li><li class="dropdown-item"><!----> <a href="/note/framework/netty/netty-business-logic.html" class="nav-link">
  Netty
</a></li><li class="dropdown-item"><!----> <a href="/note/framework/apollo/setup-debug-enviroment.html" class="nav-link">
  Apollo源码分析
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="架构" class="dropdown-title"><span class="title">架构</span> <span class="arrow down"></span></button> <button type="button" aria-label="架构" class="mobile-dropdown-title"><span class="title">架构</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/note/arch/system-design/01-scale-from-zero.html" class="nav-link">
  系统设计
</a></li><li class="dropdown-item"><!----> <a href="/note/arch/case-study/rate-limiter.html" class="nav-link">
  案例
</a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/note/" class="nav-link">
  Home
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Java" class="dropdown-title"><span class="title">Java</span> <span class="arrow down"></span></button> <button type="button" aria-label="Java" class="mobile-dropdown-title"><span class="title">Java</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/note/java/base/basic.html" class="nav-link">
  Java基础
</a></li><li class="dropdown-item"><!----> <a href="/note/java/collection/ArrayList.html" class="nav-link">
  Java集合框架
</a></li><li class="dropdown-item"><!----> <a href="/note/java/concurrent/Theory.html" class="nav-link">
  Java并发编程
</a></li><li class="dropdown-item"><!----> <a href="/note/java/jvm/memory.html" class="nav-link">
  JVM相关
</a></li><li class="dropdown-item"><!----> <a href="/note/java/nio/io.html" class="nav-link">
  Java NIO相关
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="数据存储" class="dropdown-title"><span class="title">数据存储</span> <span class="arrow down"></span></button> <button type="button" aria-label="数据存储" class="mobile-dropdown-title"><span class="title">数据存储</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/note/storage/database/mysql.html" class="nav-link">
  MySQL
</a></li><li class="dropdown-item"><!----> <a href="/note/storage/redis/redis-question.html" class="nav-link">
  Redis
</a></li><li class="dropdown-item"><!----> <a href="/note/storage/mq/kafka-intro.html" class="nav-link">
  消息队列
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="框架" class="dropdown-title"><span class="title">框架</span> <span class="arrow down"></span></button> <button type="button" aria-label="框架" class="mobile-dropdown-title"><span class="title">框架</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/note/framework/spring-framework/spring-framework-intro.html" class="nav-link">
  Spring框架
</a></li><li class="dropdown-item"><!----> <a href="/note/framework/netty/netty-business-logic.html" class="nav-link">
  Netty
</a></li><li class="dropdown-item"><!----> <a href="/note/framework/apollo/setup-debug-enviroment.html" class="nav-link">
  Apollo源码分析
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="架构" class="dropdown-title"><span class="title">架构</span> <span class="arrow down"></span></button> <button type="button" aria-label="架构" class="mobile-dropdown-title"><span class="title">架构</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/note/arch/system-design/01-scale-from-zero.html" class="nav-link">
  系统设计
</a></li><li class="dropdown-item"><!----> <a href="/note/arch/case-study/rate-limiter.html" class="nav-link">
  案例
</a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>数据库</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/note/storage/database/mysql.html" class="sidebar-link">MySQL常见问题</a></li><li><a href="/note/storage/database/shard.html" class="sidebar-link">分库分表</a></li><li><a href="/note/storage/database/db-index.html" class="sidebar-link">索引</a></li><li><a href="/note/storage/database/transaction.html" class="sidebar-link">事务</a></li><li><a href="/note/storage/database/acid.html" aria-current="page" class="active sidebar-link">事务ACID的实现原理</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="事务acid特性的实现原理"><a href="#事务acid特性的实现原理" class="header-anchor">#</a> 事务ACID特性的实现原理</h1> <p>事务是数据库操作的执行单元，一个事务中可能包含一个或多个SQL语句，这些语句要么都执行，要么都不执行。在MySQL中，事务是由存储引擎实现的，MySQL支持事务的存储引擎包括InnoDB、NDB Cluster等，其他存储引擎不支持事务，如MyIsam、Memory等。</p> <p>事务具有ACID四个属性，分别是：</p> <ul><li>原子性（Atomicity）</li> <li>一致性（Consistency）</li> <li>隔离性（Isolation）</li> <li>持久性（Durability）</li></ul> <p>按照严格的标准，只有同时满足ACID特性才是事务；但是在各大数据库厂商的实现中，真正满足ACID的事务少之又少。例如MySQL的NDB Cluster事务不满足持久性和隔离性；InnoDB默认事务隔离级别是可重复读，不满足隔离性；Oracle默认的事务隔离级别为READ COMMITTED，不满足隔离性……因此与其说ACID是事务必须满足的条件，不如说它们是衡量事务的四个维度。</p> <h2 id="原子性"><a href="#原子性" class="header-anchor">#</a> 原子性</h2> <h3 id="定义"><a href="#定义" class="header-anchor">#</a> 定义</h3> <p>原子性是指一个事务是一个不可分割的工作单位，其中的操作要么都做，要么都不做；如果事务中一个sql语句执行失败，则已执行的语句也必须回滚，数据库退回到事务前的状态。</p> <h3 id="实现原理-undo-log"><a href="#实现原理-undo-log" class="header-anchor">#</a> 实现原理：undo log</h3> <p>在说明原子性原理之前，首先介绍一下MySQL的事务日志。MySQL的日志有很多种，如二进制日志、错误日志、查询日志、慢查询日志等，此外InnoDB存储引擎还提供了两种事务日志：redo log(重做日志)和undo log(回滚日志)。其中redo log用于保证事务持久性；undo log则是事务原子性和隔离性实现的基础。</p> <p>下面说回undo log。实现原子性的关键，是当事务回滚时能够撤销所有已经成功执行的sql语句。InnoDB实现回滚，靠的是undo log：当事务对数据库进行修改时，InnoDB会生成对应的undo log；如果事务执行失败或调用了rollback，导致事务需要回滚，便可以利用undo log中的信息将数据回滚到修改之前的样子。</p> <p>undo log属于逻辑日志，它记录的是sql执行相关的信息。当发生回滚时，InnoDB会根据undo log的内容做与之前相反的工作：对于每个insert，回滚时会执行delete；对于每个delete，回滚时会执行insert；对于每个update，回滚时会执行一个相反的update，把数据改回去。</p> <p>以update操作为例：当事务执行update时，其生成的undo log中会包含被修改行的主键(以便知道修改了哪些行)、修改了哪些列、这些列在修改前后的值等信息，回滚时便可以使用这些信息将数据还原到update之前的状态。</p> <h2 id="持久性"><a href="#持久性" class="header-anchor">#</a> 持久性</h2> <h3 id="定义-2"><a href="#定义-2" class="header-anchor">#</a> 定义</h3> <p>持久性是指事务一旦提交，它对数据库的改变就应该是永久性的。接下来的其他操作或故障不应该对其有任何影响。</p> <h3 id="实现原理-redo-log"><a href="#实现原理-redo-log" class="header-anchor">#</a> 实现原理：redo log</h3> <p>redo log和undo log都属于InnoDB的事务日志。下面先聊一下redo log存在的背景。</p> <p>InnoDB作为MySQL的存储引擎，数据是存放在磁盘中的，但如果每次读写数据都需要磁盘IO，效率会很低。为此，InnoDB提供了缓存(Buffer Pool)，Buffer Pool中包含了磁盘中部分数据页的映射，作为访问数据库的缓冲：当从数据库读取数据时，会首先从Buffer Pool中读取，如果Buffer Pool中没有，则从磁盘读取后放入Buffer Pool；当向数据库写入数据时，会首先写入Buffer Pool，Buffer Pool中修改的数据会定期刷新到磁盘中（这一过程称为刷脏）。</p> <p>Buffer Pool的使用大大提高了读写数据的效率，但是也带了新的问题：如果MySQL宕机，而此时Buffer Pool中修改的数据还没有刷新到磁盘，就会导致数据的丢失，事务的持久性无法保证。</p> <p>于是，redo log被引入来解决这个问题：当数据修改时，除了修改Buffer Pool中的数据，还会在redo log记录这次操作；当事务提交时，会调用fsync接口对redo log进行刷盘。如果MySQL宕机，重启时可以读取redo log中的数据，对数据库进行恢复。redo log采用的是WAL（Write-ahead logging，预写式日志），所有修改先写入日志，再更新到Buffer Pool，保证了数据不会因MySQL宕机而丢失，从而满足了持久性要求。</p> <p>既然redo log也需要在事务提交时将日志写入磁盘，为什么它比直接将Buffer Pool中修改的数据写入磁盘(即刷脏)要快呢？主要有以下两方面的原因：</p> <p>（1）刷脏是随机IO，因为每次修改的数据位置随机，但写redo log是追加操作，属于顺序IO。</p> <p>（2）刷脏是以数据页（Page）为单位的，MySQL默认页大小是16KB，一个Page上一个小修改都要整页写入；而redo log中只包含真正需要写入的部分，无效IO大大减少。</p> <h3 id="redo-log与binlog"><a href="#redo-log与binlog" class="header-anchor">#</a> redo log与binlog</h3> <p>我们知道，在MySQL中还存在binlog(二进制日志)也可以记录写操作并用于数据的恢复，但二者是有着根本的不同的：</p> <p>（1）作用不同：redo log是用于crash recovery的，保证MySQL宕机也不会影响持久性；binlog是用于point-in-time recovery的，保证服务器可以基于时间点恢复数据，此外binlog还用于主从复制。</p> <p>（2）层次不同：redo log是InnoDB存储引擎实现的，而binlog是MySQL的服务器层(可以参考文章前面对MySQL逻辑架构的介绍)实现的，同时支持InnoDB和其他存储引擎。</p> <p>（3）内容不同：redo log是物理日志，内容基于磁盘的Page；binlog的内容是二进制的，根据binlog_format参数的不同，可能基于sql语句、基于数据本身或者二者的混合。</p> <p>（4）写入时机不同：binlog在事务提交时写入；redo log的写入时机相对多元：</p> <ul><li>前面曾提到：当事务提交时会调用fsync对redo log进行刷盘；这是默认情况下的策略，修改innodb_flush_log_at_trx_commit参数可以改变该策略，但事务的持久性将无法保证。</li> <li>除了事务提交时，还有其他刷盘时机：如master thread每秒刷盘一次redo log等，这样的好处是不一定要等到commit时刷盘，commit速度大大加快。</li></ul> <h2 id="隔离性"><a href="#隔离性" class="header-anchor">#</a> 隔离性</h2> <h3 id="定义-3"><a href="#定义-3" class="header-anchor">#</a> 定义</h3> <p>与原子性、持久性侧重于研究事务本身不同，隔离性研究的是不同事务之间的相互影响。隔离性是指，事务内部的操作与其他事务是隔离的，并发执行的各个事务之间不能互相干扰。严格的隔离性，对应了事务隔离级别中的Serializable (可串行化)，但实际应用中出于性能方面的考虑很少会使用可串行化。</p> <p>隔离性追求的是并发情形下事务之间互不干扰。简单起见，我们主要考虑最简单的读操作和写操作(加锁读等特殊读操作会特殊说明)，那么隔离性的探讨，主要可以分为两个方面：</p> <ul><li>(一个事务)写操作对(另一个事务)写操作的影响：锁机制保证隔离性</li> <li>(一个事务)写操作对(另一个事务)读操作的影响：MVCC保证隔离性</li></ul> <h3 id="锁机制"><a href="#锁机制" class="header-anchor">#</a> 锁机制</h3> <p>首先来看两个事务的写操作之间的相互影响。隔离性要求同一时刻只能有一个事务对数据进行写操作，InnoDB通过锁机制来保证这一点。</p> <p>锁机制的基本原理可以概括为：事务在修改数据之前，需要先获得相应的锁；获得锁之后，事务便可以修改数据；该事务操作期间，这部分数据是锁定的，其他事务如果需要修改数据，需要等待当前事务提交或回滚后释放锁。</p> <p><strong>行锁与表锁</strong></p> <p>按照粒度，锁可以分为表锁、行锁以及其他位于二者之间的锁。表锁在操作数据时会锁定整张表，并发性能较差；行锁则只锁定需要操作的数据，并发性能好。但是由于加锁本身需要消耗资源(获得锁、检查锁、释放锁等都需要消耗资源)，因此在锁定数据较多情况下使用表锁可以节省大量资源。MySQL中不同的存储引擎支持的锁是不一样的，例如MyIsam只支持表锁，而InnoDB同时支持表锁和行锁，且出于性能考虑，绝大多数情况下使用的都是行锁。</p> <h2 id="一致性"><a href="#一致性" class="header-anchor">#</a> 一致性</h2> <h3 id="定义-4"><a href="#定义-4" class="header-anchor">#</a> 定义</h3> <p>一致性是指事务执行结束后，数据库的完整性约束没有被破坏，事务执行的前后都是合法的数据状态。数据库的完整性约束包括但不限于：实体完整性（如行的主键存在且唯一）、列完整性（如字段的类型、大小、长度要符合要求）、外键约束、用户自定义完整性（如转账前后，两个账户余额的和应该不变）。</p> <h3 id="实现"><a href="#实现" class="header-anchor">#</a> 实现</h3> <p>可以说，一致性是事务追求的最终目标：前面提到的原子性、持久性和隔离性，都是为了保证数据库状态的一致性。此外，除了数据库层面的保障，一致性的实现也需要应用层面进行保障。</p> <p>实现一致性的措施包括：</p> <ul><li>保证原子性、持久性和隔离性，如果这些特性无法保证，事务的一致性也无法保证</li> <li>数据库本身提供保障，例如不允许向整形列插入字符串值、字符串长度不能超过列的限制等</li> <li>应用层面进行保障，例如如果转账操作只扣除转账者的余额，而没有增加接收者的余额，无论数据库实现的多么完美，也无法保证状态的一致</li></ul></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/note/storage/database/transaction.html" class="prev">
        事务
      </a></span> <!----></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/note/assets/js/app.fe0ed53e.js" defer></script><script src="/note/assets/js/2.7b239f4c.js" defer></script><script src="/note/assets/js/1.51e4995c.js" defer></script><script src="/note/assets/js/110.ed78ce1a.js" defer></script>
  </body>
</html>
